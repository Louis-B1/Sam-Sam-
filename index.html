<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission: Les Chipies</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        body { 
            background-color: #050505; 
            margin: 0; 
            overflow: hidden; 
            font-family: 'VT323', monospace; 
            color: white; 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
        }

        /* --- TÉLÉPHONE (INTRO) --- */
        #phone-container {
            position: absolute; width: 360px; height: 720px;
            background: #000; border: 12px solid #1a1a1a; border-radius: 40px;
            display: flex; flex-direction: column; overflow: hidden;
            z-index: 100; box-shadow: 0 0 80px rgba(0,0,0,0.8);
        }
        #chat-header {
            background: #202020; padding: 25px; text-align: center; border-bottom: 2px solid #333;
            font-size: 24px; color: #fff; letter-spacing: 1px; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        /* Indicateur vert en ligne */
        .online-dot { width:12px; height:12px; background:#2ecc71; border-radius:50%; box-shadow: 0 0 5px #2ecc71; }

        #chat-body {
            flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px;
            background: #111; overflow-y: auto; scroll-behavior: smooth;
        }
        
        .msg {
            max-width: 80%; padding: 15px; border-radius: 8px; font-size: 20px; line-height: 1.1;
            box-shadow: 3px 3px 0px #000; animation: pop 0.3s ease-out;
        }
        @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }
        
        .left { background: #333; align-self: flex-start; color: #eee; border-top-left-radius: 0; }
        .right { background: #007aff; align-self: flex-end; color: white; border-top-right-radius: 0; }
        .name { font-size: 14px; color: #aaa; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; }

        #btn-start {
            padding: 30px; background: #2ecc71; color: #004400; text-align: center; 
            cursor: pointer; font-size: 28px; text-transform: uppercase; font-weight: bold;
            border-top: 4px solid #27ae60; display: none; /* Caché au début */
        }
        #btn-start:hover { background: #27ae60; color: white; }

        /* --- JEU (POKÉMON STYLE) --- */
        #game-ui {
            position: absolute; top: 20px; left: 20px; z-index: 10; display: none;
            background: rgba(255, 255, 255, 0.9); padding: 10px 20px; border: 4px solid #333; border-radius: 4px;
            box-shadow: 5px 5px 0px rgba(0,0,0,0.5); color: black;
        }
        .hud-text { margin: 0; font-size: 28px; font-weight: bold; }
        
        canvas { 
            border: 8px solid #ddd; border-radius: 4px;
            box-shadow: 0 0 100px rgba(0,0,0,1); 
            image-rendering: pixelated; 
            display: none;
        }

        /* Scanlines Retro */
        .scanlines {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
        }

        #end-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; display: none;
            flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white;
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    
    <div id="youtube-audio" style="position:absolute; top:-9999px;"></div>

    <div id="phone-container">
        <div id="chat-header">
            <div class="online-dot"></div>&nbsp;
            Les Chipies (4)
        </div>
        <div id="chat-body">
            </div>
        <div id="btn-start">ALLER CHERCHER SAM</div>
    </div>

    <div id="game-ui">
        <div class="hud-text" id="zone-name">PLACE DES VOSGES</div>
        <div style="font-size:20px; color:#555;">OBJETS: <span id="score" style="color:#d32f2f; font-weight:bold;">0</span>/3</div>
        <div id="message-area" style="margin-top:5px; color:#007aff; font-size: 22px; min-height:25px;"></div>
    </div>

    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="end-screen">
        <h1 style="color: #2ecc71; font-size: 60px; margin-bottom: 20px;">SAMUEL RETROUVÉ !</h1>
        <div style="background: #fff; color:black; padding: 30px; border-radius:10px; border: 5px solid #aaa; max-width: 600px;">
            <p style="font-size: 30px; line-height: 1.2;">
                "Wesh l'équipe... J'ai plus de batterie.<br>
                Je dormais dans un kebab rue de Douai.<br>
                C'était pas la Police, c'était le camion poubelle qui faisait trop de bruit."
            </p>
        </div>
        <br>
        <button onclick="location.reload()" style="padding:15px 30px; font-size:24px; cursor:pointer; font-family:'VT323'; background:#d32f2f; color:white; border:none;">RETOURNER EN COURS</button>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const TILE = 50; 
        let patterns = {};
        
        // --- 2. LOGIQUE DU CHAT (Simple et Robuste) ---
        const messages = [
            { s: 'Matthieu', t: "Il est où Samuel ? Le prof va faire l'appel." },
            { s: 'Samuel', t: "LES CHIPIES C'EST CHAUD." },
            { s: 'Samuel', t: "La police me coursent." },
            { s: 'Moi', t: "Mdr arrête tes mythos Sam, t'as encore bu ?" },
            { s: 'Samuel', t: "Jure que non ! J'étais Place des Vosges, y'a eu une descente." },
            { s: 'Julie', t: "Pff... Il a surement perdu sa carte étudiante et il ose pas venir." },
            { s: 'Samuel', t: "J'ai paumé mes affaires en courant vers Pigalle." },
            { s: 'Samuel', t: "Venez me chercher je suis perdu." },
            { s: 'Moi', t: "Ok j'arrive. Bouge pas (pour une fois)." }
        ];

        let msgIdx = 0;
        function playChat() {
            if (msgIdx >= messages.length) {
                document.getElementById('btn-start').style.display = 'block';
                return;
            }
            const m = messages[msgIdx];
            const div = document.createElement('div');
            div.className = `msg ${m.s === 'Moi' ? 'right' : 'left'}`;
            div.innerHTML = `<div class="name">${m.s}</div>${m.t}`;
            const chatBody = document.getElementById('chat-body');
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
            
            msgIdx++;
            setTimeout(playChat, 1200); // Vitesse du chat
        }

        // Lancement immédiat au chargement de la page
        document.addEventListener("DOMContentLoaded", function() {
            setTimeout(playChat, 500);
        });

        // --- 3. AUDIO (API YOUTUBE) ---
        var player;
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-audio', {
                height: '0', width: '0', 
                videoId: 'tE7Qy9i2Qhs', // Jazz Parisien Chill
                playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1, 'playlist': 'tE7Qy9i2Qhs' }
            });
        }

        // --- 4. TEXTURES PIXEL ART ---
        function createPattern(type) {
            const c = document.createElement('canvas'); c.width = TILE; c.height = TILE;
            const ctx = c.getContext('2d');

            if(type === 'grass_vosges') {
                ctx.fillStyle = '#6ab04c'; ctx.fillRect(0,0,TILE,TILE);
                ctx.fillStyle = '#badc58'; 
                ctx.fillRect(5,5,4,4); ctx.fillRect(25,35,4,4); ctx.fillRect(40,10,4,4);
                ctx.fillStyle = '#488235'; 
                ctx.fillRect(0,0,2,TILE); ctx.fillRect(0,0,TILE,2); 
            }
            else if(type === 'brick_vosges') {
                ctx.fillStyle = '#eb4d4b'; ctx.fillRect(0,0,TILE,TILE);
                ctx.fillStyle = '#c0392b'; 
                for(let y=0; y<TILE; y+=12.5) {
                    ctx.fillRect(0, y, TILE, 2);
                    let off = (y/12.5)%2===0?0:25; ctx.fillRect(off, y, 2, 12.5);
                }
                ctx.fillStyle = '#f1f2f6'; ctx.fillRect(0,0,10,TILE);
                ctx.strokeStyle = '#bdc3c7'; ctx.strokeRect(0,0,10,TILE);
            }
            else if(type === 'path') {
                ctx.fillStyle = '#f7f1e3'; ctx.fillRect(0,0,TILE,TILE);
                ctx.fillStyle = '#d1ccc0';
                for(let i=0; i<15; i++) ctx.fillRect(Math.random()*TILE, Math.random()*TILE, 3, 3);
            }
            else if(type === 'cobble_pigalle') {
                ctx.fillStyle = '#2c3e50'; ctx.fillRect(0,0,TILE,TILE);
                ctx.strokeStyle = '#34495e'; ctx.lineWidth = 2;
                for(let y=0; y<TILE; y+=12.5) for(let x=0; x<TILE; x+=12.5) ctx.strokeRect(x,y,12.5,12.5);
            }
            else if(type === 'wall_pigalle') {
                ctx.fillStyle = '#1e272e'; ctx.fillRect(0,0,TILE,TILE);
                ctx.fillStyle = '#000'; ctx.fillRect(10,10,30,30); 
                ctx.fillStyle = '#333'; ctx.fillRect(24,10,2,30); ctx.fillRect(10,24,30,2); 
            }
            else if(type === 'neon_sex') {
                ctx.fillStyle = '#1e272e'; ctx.fillRect(0,0,TILE,TILE);
                ctx.fillStyle = '#ff00a0'; ctx.shadowBlur = 15; ctx.shadowColor = '#ff00a0';
                ctx.font = "14px monospace"; ctx.fillText("CLUB", 8, 30); ctx.shadowBlur = 0;
            }
            else if(type === 'fountain') {
                ctx.fillStyle = '#3498db'; ctx.fillRect(0,0,TILE,TILE);
                ctx.fillStyle = '#ecf0f1'; ctx.globalAlpha=0.3;
                ctx.beginPath(); ctx.arc(TILE/2, TILE/2, 15, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
            }
            return ctx.createPattern(c, 'repeat');
        }

        function initPatterns() {
            patterns.grass = createPattern('grass_vosges');
            patterns.brick = createPattern('brick_vosges');
            patterns.path = createPattern('path');
            patterns.cobble = createPattern('cobble_pigalle');
            patterns.wall = createPattern('wall_pigalle');
            patterns.neon = createPattern('neon_sex');
            patterns.water = createPattern('fountain');
        }

        // --- 5. DATA JEU ---
        const map1 = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,2,0,0,0,0,0,0,0,1],
            [1,0,2,2,2,2,0,2,0,2,2,2,2,0,0,1],
            [1,0,2,2,2,2,0,0,0,2,2,2,2,0,0,1],
            [1,0,2,2,4,4,0,0,0,4,4,2,2,0,0,1],
            [1,0,2,2,4,4,0,0,0,4,4,2,2,0,0,1],
            [1,0,2,2,2,2,0,0,0,2,2,2,2,0,0,1],
            [1,0,2,2,2,2,0,0,0,2,2,2,2,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,2,2,2,2,0,0,0,2,2,2,2,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,9,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];
        
        const map2 = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,5,1,1,0,1,1,5,1,0,1,5,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,0,0,1,1,1,1,0,0,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,1,1,1,0,0,0,1,1,1,0,0,0,1],
            [1,0,0,0,0,0,0,8,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        const items1 = [{x: 8, y: 5, label: "Carte Étudiante"}, {x: 3, y: 3, label: "Vape"}, {x: 12, y: 8, label: "Chargeur"}];
        const items2 = [{x: 2, y: 8, label: "Kebab Froid"}, {x: 12, y: 5, label: "Ticket Métro"}, {x: 6, y: 2, label: "Flyer BDE"}];

        // --- 6. MOTEUR JEU ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let player = {x: 1, y: 1};
        let currentMap = [];
        let items = [];
        let level = 1;
        let score = 0;
        let gameActive = false;

        function startGame() {
            document.getElementById('phone-container').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('gameCanvas').style.display = 'block';
            gameActive = true;
            
            // On lance la musique ICI seulement (User Interaction)
            if(player && player.playVideo) {
                player.unMute();
                player.setVolume(50);
                player.playVideo();
            }

            initPatterns();
            loadLevel(1);
            loop();
        }

        function loadLevel(lvl) {
            level = lvl;
            score = 0;
            document.getElementById('score').innerText = "0";
            
            if(lvl === 1) {
                currentMap = map1;
                items = JSON.parse(JSON.stringify(items1));
                player = {x: 2, y: 2};
                document.getElementById('zone-name').innerText = "PLACE DES VOSGES";
            } else {
                currentMap = map2;
                items = JSON.parse(JSON.stringify(items2));
                player = {x: 2, y: 2};
                document.getElementById('zone-name').innerText = "PIGALLE (NUIT)";
            }
        }

        function move(dx, dy) {
            if(!gameActive) return;
            const nx = player.x + dx;
            const ny = player.y + dy;

            const cell = currentMap[ny][nx];
            if(cell === 1 || cell === 4 || cell === 5) return; // Murs

            player.x = nx; player.y = ny;

            const itemIdx = items.findIndex(i => i.x === nx && i.y === ny);
            if(itemIdx !== -1) {
                score++;
                document.getElementById('score').innerText = score;
                showMessage(`Trouvé: ${items[itemIdx].label} !`);
                items.splice(itemIdx, 1);
            }

            if(cell === 9) {
                if(score >= 3) loadLevel(2);
                else showMessage("Il te manque des objets !");
            }
            if(cell === 8) {
                if(score >= 3) {
                    gameActive = false;
                    document.getElementById('gameCanvas').style.display = 'none';
                    document.getElementById('game-ui').style.display = 'none';
                    document.getElementById('end-screen').style.display = 'flex';
                } else showMessage("C'est Sam ! Mais il faut ses affaires.");
            }
        }

        function showMessage(txt) {
            const el = document.getElementById('message-area');
            el.innerText = txt;
            setTimeout(() => el.innerText = "", 2000);
        }

        function loop() {
            if(!gameActive) return;
            ctx.clearRect(0,0,canvas.width, canvas.height);
            
            for(let y=0; y<currentMap.length; y++) {
                for(let x=0; x<currentMap[y].length; x++) {
                    const c = currentMap[y][x];
                    const px = x*TILE; const py = y*TILE;
                    
                    if(level === 1) {
                        if(c === 0) ctx.fillStyle = patterns.path;
                        else ctx.fillStyle = patterns.grass;
                    } else {
                        ctx.fillStyle = patterns.cobble;
                    }
                    if(c !== 4) ctx.fillRect(px, py, TILE, TILE); 

                    if(c === 1) { ctx.fillStyle = level===1 ? patterns.brick : patterns.wall; ctx.fillRect(px,py,TILE,TILE); }
                    if(c === 4) { ctx.fillStyle = patterns.water; ctx.fillRect(px,py,TILE,TILE); }
                    if(c === 5) { ctx.fillStyle = patterns.neon; ctx.fillRect(px,py,TILE,TILE); }
                }
            }

            items.forEach(i => {
                const cx = i.x*TILE + TILE/2; const cy = i.y*TILE + TILE/2;
                ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(cx, cy, 12, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.arc(cx, cy, 12, 0, Math.PI, true); ctx.fill();
                ctx.fillStyle = "#333"; ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI*2); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(cx-12, cy); ctx.lineTo(cx+12, cy); ctx.stroke();
            });

            const px = player.x*TILE; const py = player.y*TILE;
            ctx.fillStyle = "#3498db"; ctx.fillRect(px+10, py+15, 30, 30);
            ctx.fillStyle = "#f1c40f"; ctx.fillRect(px+12, py+5, 26, 20);
            ctx.fillStyle = "#2c3e50"; ctx.fillRect(px+12, py, 26, 8);
            
            if(level === 1) {
                ctx.fillStyle = "#2ecc71"; ctx.font="20px VT323"; 
                ctx.fillText("MÉTRO", 14*TILE, 10*TILE+30);
            } else {
                const sx = 7*TILE; const sy = 10*TILE;
                ctx.fillStyle = "#e74c3c"; ctx.fillRect(sx+10, sy+15, 30, 30);
                ctx.fillStyle = "#f1c40f"; ctx.fillRect(sx+12, sy+5, 26, 20);
                ctx.fillStyle = "#000"; ctx.fillText("SAM", sx+10, sy-5);
            }

            requestAnimationFrame(loop);
        }

        window.addEventListener('keydown', e => {
            if(e.key === "ArrowUp") move(0,-1);
            if(e.key === "ArrowDown") move(0,1);
            if(e.key === "ArrowLeft") move(-1,0);
            if(e.key === "ArrowRight") move(1,0);
        });

        document.getElementById('btn-start').addEventListener('click', startGame);

    </script>
</body>
</html>
