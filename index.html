<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Mission Samuel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{
  margin:0;
  background:#05070c;
  overflow:hidden;
  font-family:Courier New, monospace;
  color:white;
}
canvas{display:block}
.scanlines{
  position:fixed;
  inset:0;
  pointer-events:none;
  background:linear-gradient(
    rgba(0,0,0,0) 50%,
    rgba(0,0,0,0.15) 50%
  );
  background-size:100% 4px;
}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div class="scanlines"></div>

<script>
/* ===================== SETUP ===================== */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
resize();
window.addEventListener("resize", resize);

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}

const TILE = 40;
const GRID_W = 11;
const GRID_H = 11;
const offsetX = canvas.width/2 - (GRID_W*TILE)/2;
const offsetY = canvas.height/2 - (GRID_H*TILE)/2;

/* ===================== STATE ===================== */
let player = {x:5,y:10};
let shake = 0;
let freeze = 0;
let glowFlash = 0;
let gameEnded = false;

const pigeons = [
  {x:3,y:5,static:false},
  {x:7,y:4,static:false},
  {x:5,y:2,static:true}
];

const waitZone = {x:5,y:6};
let waitTimer = 0;
let mustWait = false;

/* ===================== CHAT ===================== */
let chat = [
  {t:"Alexis :",d:0},
  {t:"Je suis perdu.",d:800},
  {t:"Retrouve‑moi.",d:800}
];
let chatIndex = 0;
let chatTimer = 0;

/* ===================== INPUT ===================== */
const keys = {};
onkeydown = e => keys[e.key] = true;
onkeyup = e => keys[e.key] = false;

/* ===================== LOOP ===================== */
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

/* ===================== UPDATE ===================== */
function update(){
  if(gameEnded) return;

  if(freeze>0){ freeze--; return; }

  let moved = false;
  let nx = player.x;
  let ny = player.y;

  if(keys.ArrowUp){ny--; moved=true}
  if(keys.ArrowDown){ny++; moved=true}
  if(keys.ArrowLeft){nx--; moved=true}
  if(keys.ArrowRight){nx++; moved=true}

  if(moved){
    keys.ArrowUp=keys.ArrowDown=keys.ArrowLeft=keys.ArrowRight=false;

    if(nx>=0&&nx<GRID_W&&ny>=0&&ny<GRID_H){
      player.x=nx; player.y=ny;
      shake=2; glowFlash=4;
    }
  }

  // pigeon collision
  for(let p of pigeons){
    if(player.x===p.x && player.y===p.y){
      freeze=10;
    }
  }

  // wait zone
  if(player.x===waitZone.x && player.y===waitZone.y){
    mustWait=true;
    waitTimer++;
    if(waitTimer>120){
      endGame();
    }
  }else{
    mustWait=false;
    waitTimer=0;
  }

  // chat timing
  chatTimer++;
}

/* ===================== END ===================== */
function endGame(){
  gameEnded=true;
  chat=[
    {t:"Alexis :",d:0},
    {t:"Sam ?",d:900},
    {t:"J’ai retrouvé mon tel.",d:900},
    {t:"En fait non.",d:1200},
    {t:"Je suis dans un kebab.",d:1500}
  ];
  chatIndex=0;
  chatTimer=0;
}

/* ===================== DRAW ===================== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // vignette
  ctx.fillStyle="rgba(0,0,0,0.4)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  let sx = offsetX + (Math.random()*shake - shake/2);
  let sy = offsetY + (Math.random()*shake - shake/2);
  shake = Math.max(0, shake-1);

  // grid
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      ctx.strokeStyle="#0b132a";
      ctx.strokeRect(sx+x*TILE, sy+y*TILE, TILE, TILE);
    }
  }

  // wait zone
  ctx.fillStyle="rgba(0,255,255,0.15)";
  ctx.fillRect(sx+waitZone.x*TILE, sy+waitZone.y*TILE, TILE, TILE);

  // pigeons
  for(let p of pigeons){
    ctx.shadowBlur=20;
    ctx.shadowColor="#ffd500";
    ctx.fillStyle="#ffd500";
    ctx.fillRect(sx+p.x*TILE+10, sy+p.y*TILE+10, 20, 20);
  }
  ctx.shadowBlur=0;

  // player
  ctx.shadowBlur=glowFlash>0?30:15;
  ctx.shadowColor="#ff3cff";
  ctx.fillStyle="#ff3cff";
  ctx.fillRect(
    sx+player.x*TILE+8,
    sy+player.y*TILE+8,
    24,24
  );
  ctx.shadowBlur=0;
  glowFlash=Math.max(0,glowFlash-1);

  // chat
  drawChat();
}

/* ===================== CHAT DRAW ===================== */
function drawChat(){
  ctx.fillStyle="rgba(0,0,0,0.7)";
  ctx.fillRect(0,canvas.height-140,canvas.width,140);

  ctx.fillStyle="#fff";
  ctx.font="20px Courier New";

  let y = canvas.height-100;
  let time = 0;

  for(let i=0;i<chat.length;i++){
    time += chat[i].d;
    if(chatTimer>time){
      ctx.fillText(chat[i].t,20,y);
      y+=26;
    }
  }

  if(gameEnded && chatTimer>5000){
    ctx.fillStyle="#aaa";
    ctx.fillText("Un jeu inutile. Merci d’avoir marché.",20,canvas.height-20);
  }
}
</script>
</body>
</html>
