<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paris Haussmann - Retrouve Samuel</title>
    <style>
        :root {
            --haussmann-stone: #e6dccf;
            --paris-roof: #4a4e58;
            --paris-gold: #c5a059;
        }
        body {
            background-color: #000;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Empêche les barres de défilement */
            font-family: 'Segoe UI', sans-serif;
            user-select: none;
            width: 100vw;
            height: 100vh;
        }
        
        /* Le conteneur prend tout l'écran */
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: black;
        }
        
        /* Le canvas remplit le conteneur */
        canvas { 
            display: block; 
            width: 100%; 
            height: 100%;
            image-rendering: pixelated; 
        }
        
        /* Interface (HUD) Élégante */
        #hud {
            position: absolute;
            top: 20px; left: 20px;
            padding: 15px 25px;
            background: rgba(20, 20, 30, 0.85);
            border-left: 4px solid var(--paris-gold);
            border-radius: 0 10px 10px 0;
            color: white;
            font-family: 'Georgia', serif; /* Police plus classique/chic */
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .hud-line { margin-bottom: 5px; font-size: 18px; }
        #levelName { color: var(--paris-gold); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Ecran de démarrage */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(40,40,60,0.95));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            cursor: pointer;
        }
        h1 { 
            font-family: 'Georgia', serif;
            font-size: 6vw; /* Taille adaptative */
            margin: 0; color: var(--paris-gold); 
            text-transform: uppercase; letter-spacing: 5px;
            text-shadow: 0 0 30px rgba(197, 160, 89, 0.6);
        }
        p { font-size: 24px; color: #ddd; margin-top: 10px; font-style: italic;}
        .btn-start { 
            margin-top: 50px;
            padding: 15px 40px;
            background: transparent;
            border: 2px solid var(--paris-gold);
            color: var(--paris-gold);
            font-size: 20px;
            font-weight: bold;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .btn-start:hover { background: var(--paris-gold); color: black; box-shadow: 0 0 20px var(--paris-gold); }

        /* Victoire */
        #win-screen {
            display: none;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 30;
            width: 100%;
        }
        #win-screen h1 { color: #fff; text-shadow: 0 0 20px #fff; font-size: 5vw; margin-bottom: 20px;}
        #samuel-reveal {
            height: 50vh; /* S'adapte à la hauteur de l'écran */
            object-fit: contain;
            animation: bounce 2s infinite ease-in-out;
            filter: drop-shadow(0 0 30px rgba(255,215,0,0.6));
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        
        /* Vidéo cachée mais active */
        #youtube-audio { position: absolute; top: -9999px; left: -9999px; opacity: 0; pointer-events: none;}
    </style>
</head>
<body>

    <div id="youtube-audio"></div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div id="hud">
            <div class="hud-line"><span id="levelName">Quartier Latin</span></div>
            <div class="hud-line" style="font-size: 14px; color: #ccc;">Mission : Trouve l'escalier</div>
        </div>

        <div id="start-screen">
            <h1>PARIS LOST</h1>
            <p>Retrouve Samuel dans les rues de la capitale</p>
            <div class="btn-start">CLIQUER POUR JOUER</div>
        </div>

        <div id="win-screen">
            <h1>SAMUEL RETROUVÉ !</h1>
            <img id="samuel-reveal" src="samuel.png">
        </div>
    </div>

    <script>
        // --- 1. AUDIO (YOUTUBE API) ---
        var player;
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-audio', {
                height: '0', width: '0', 
                videoId: 'bUKC5RAjUdg',
                playerVars: { 
                    'autoplay': 0, 
                    'controls': 0, 
                    'loop': 1, 
                    'playlist': 'bUKC5RAjUdg',
                    'playsinline': 1 
                }
            });
        }

        // --- 2. CONFIGURATION GRAPHIQUE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        // Redimensionnement Plein Écran
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // On recalculera le nombre de rayons dans la boucle de jeu
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Assets
        const samuelSprite = new Image(); 
        samuelSprite.src = "samuel.png";
        
        // --- GÉNÉRATEUR TEXTURE HAUSSMANNIENNE ---
        const wallCanvas = document.createElement('canvas'); 
        wallCanvas.width = 64; wallCanvas.height = 64;
        const wCtx = wallCanvas.getContext('2d');

        // 1. Fond Pierre de taille (Beige crème)
        wCtx.fillStyle = '#eaddcf'; 
        wCtx.fillRect(0,0,64,64);

        // 2. Joints de pierre (Lignes subtiles)
        wCtx.fillStyle = '#d1c4b5';
        wCtx.fillRect(0, 32, 64, 2); // Ligne horizontale milieu
        wCtx.fillRect(0, 62, 64, 2); // Ligne horizontale bas
        wCtx.fillRect(32, 0, 2, 32); // Joint vertical haut
        wCtx.fillRect(10, 32, 2, 32); // Joint vertical bas décalé

        // 3. Fenêtre Parisienne (Cadre + Vitre sombre)
        // Cadre gris
        wCtx.fillStyle = '#eee'; 
        wCtx.fillRect(12, 8, 40, 40);
        // Intérieur fenêtre (Bleu nuit/reflet)
        wCtx.fillStyle = '#2c3e50'; 
        wCtx.fillRect(14, 10, 36, 36);
        // Reflet vitre
        wCtx.fillStyle = 'rgba(255,255,255,0.2)';
        wCtx.beginPath(); wCtx.moveTo(14, 30); wCtx.lineTo(30, 10); wCtx.lineTo(40, 10); wCtx.lineTo(14, 40); wCtx.fill();

        // 4. Garde-corps (Balcon en fer forgé noir)
        wCtx.fillStyle = '#1a1a1a';
        wCtx.fillRect(10, 42, 44, 2); // Barre haut
        wCtx.fillRect(10, 48, 44, 2); // Barre bas
        // Barreaux verticaux
        for(let i=12; i<52; i+=6) {
            wCtx.fillRect(i, 42, 2, 8);
        }

        const wallTexture = new Image(); wallTexture.src = wallCanvas.toDataURL();

        // Variables Jeu
        const TILE_SIZE = 64; 
        const FOV = Math.PI / 3; 
        
        let playerObj = { x: 0, y: 0, dir: 0, speed: 7 }; // Un peu plus rapide
        let currentLevel = 0;
        let gameActive = false;
        
        const levels = [
            {
                name: "Quartier Latin",
                map: [
                    [1,1,1,1,1,1,1,1,1,1,1,1],
                    [1,0,0,0,0,1,0,0,0,0,0,1],
                    [1,0,1,1,0,1,0,1,1,1,0,1],
                    [1,0,1,0,0,0,0,0,0,1,0,1],
                    [1,0,1,0,1,1,1,1,0,0,0,1],
                    [1,0,0,0,0,0,0,1,1,1,9,1],
                    [1,1,1,1,1,1,1,1,1,1,1,1]
                ],
                start: {x: 1.5, y: 1.5, dir: 0}
            },
            {
                name: "Grands Boulevards",
                map: [
                    [1,1,1,1,1,1,1,1,1,1,1],
                    [1,0,0,0,0,0,1,0,0,0,1],
                    [1,0,1,1,1,0,1,0,1,0,1],
                    [1,0,1,0,0,0,0,0,1,0,1],
                    [1,0,1,1,1,1,1,1,1,0,1],
                    [1,0,0,0,0,9,0,0,0,0,1],
                    [1,1,1,1,1,1,1,1,1,1,1]
                ],
                start: {x: 1.5, y: 1.5, dir: 0}
            },
            {
                name: "Place de l'Étoile (Final)",
                map: [
                    [1,1,1,1,1,1,1,1],
                    [1,0,0,0,0,0,0,1],
                    [1,0,1,1,0,1,0,1],
                    [1,0,1,8,0,1,0,1],
                    [1,0,1,1,0,1,0,1],
                    [1,0,0,0,0,0,0,1],
                    [1,1,1,1,1,1,1,1]
                ],
                start: {x: 3.5, y: 5.5, dir: -Math.PI/2}
            }
        ];

        let map = []; let items = [];

        function loadLevel(idx) {
            if (idx >= levels.length) return;
            currentLevel = idx;
            const lvl = levels[idx];
            document.getElementById('levelName').innerText = lvl.name;
            map = lvl.map;
            playerObj.x = lvl.start.x * TILE_SIZE;
            playerObj.y = lvl.start.y * TILE_SIZE;
            playerObj.dir = lvl.start.dir;
            items = [];
            for(let y=0; y<map.length; y++) for(let x=0; x<map[y].length; x++) {
                if(map[y][x] === 8) { 
                    items.push({x: x*TILE_SIZE+TILE_SIZE/2, y: y*TILE_SIZE+TILE_SIZE/2, type: 'samuel'}); 
                    map[y][x] = 0; 
                }
            }
        }

        // --- DÉMARRAGE ---
        function start() {
            document.getElementById('start-screen').style.display = 'none';
            loadLevel(0);
            gameActive = true;
            
            // Lancement Audio FORCÉ ici
            if (player && typeof player.playVideo === 'function') {
                player.unMute(); // Important
                player.setVolume(70);
                player.playVideo();
            } else {
                console.log("Lecteur audio pas prêt ou bloqué.");
            }
            
            loop();
        }
        document.getElementById('start-screen').addEventListener('click', start);

        const keys = {};
        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        function update() {
            if(!gameActive) return;
            // Contrôles
            if (keys['ArrowLeft']) playerObj.dir -= 0.04;
            if (keys['ArrowRight']) playerObj.dir += 0.04;
            let step = 0;
            if (keys['ArrowUp']) step = playerObj.speed;
            if (keys['ArrowDown']) step = -playerObj.speed;
            
            if (step !== 0) {
                let nextX = playerObj.x + Math.cos(playerObj.dir) * step;
                let nextY = playerObj.y + Math.sin(playerObj.dir) * step;
                let gridX = Math.floor(nextX / TILE_SIZE);
                let gridY = Math.floor(nextY / TILE_SIZE);
                
                // Collision glissante simple
                if (map[gridY] && map[gridY][gridX] !== 1) {
                    playerObj.x = nextX; playerObj.y = nextY;
                    if (map[gridY][gridX] === 9) loadLevel(currentLevel + 1);
                }
            }

            items.forEach(item => {
                if (Math.hypot(playerObj.x - item.x, playerObj.y - item.y) < 40 && item.type === 'samuel') {
                    gameActive = false;
                    document.getElementById('win-screen').style.display = 'block';
                    document.getElementById('hud').style.display = 'none';
                }
            });
        }

        function draw() {
            // Effacer l'écran
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // --- CIEL & SOL (Ambiance Parisienne Crépuscule) ---
            // Ciel : Dégradé bleu/rose typique des soirées parisiennes
            let skyGrad = ctx.createLinearGradient(0,0,0,canvas.height/2);
            skyGrad.addColorStop(0, "#2c3e50"); // Bleu nuit haut
            skyGrad.addColorStop(0.5, "#4a69bd"); // Bleu clair
            skyGrad.addColorStop(1, "#e58e26"); // Orange horizon (lumières ville)
            ctx.fillStyle = skyGrad; 
            ctx.fillRect(0,0,canvas.width,canvas.height/2);
            
            // Sol : Trottoirs gris clair
            ctx.fillStyle = "#555"; 
            ctx.fillRect(0,canvas.height/2,canvas.width,canvas.height/2);

            // RAYCASTING
            // On calcule le nombre de rayons en fonction de la largeur réelle de l'écran
            // Pour la performance en plein écran, on peut réduire la résolution (ex: canvas.width / 2)
            const numRays = Math.floor(canvas.width / 2); 
            
            for (let i = 0; i < numRays; i++) {
                let rayAngle = (playerObj.dir - FOV / 2.0) + (i / numRays) * FOV;
                let dist = 0; let hit = false;
                let eyeX = Math.cos(rayAngle), eyeY = Math.sin(rayAngle);

                while (!hit && dist < 1000) {
                    dist += 1; // Augmenter pour perf si besoin
                    let testX = Math.floor((playerObj.x + eyeX * dist) / TILE_SIZE);
                    let testY = Math.floor((playerObj.y + eyeY * dist) / TILE_SIZE);
                    if (testX < 0 || testX >= map[0].length || testY < 0 || testY >= map.length || map[testY][testX] === 1) hit = true;
                }
                
                let correctDist = dist * Math.cos(rayAngle - playerObj.dir);
                let h = (TILE_SIZE * canvas.height) / (correctDist || 1);
                let x = i * 2; // Largeur du rayon

                // Texture Mur
                ctx.drawImage(wallTexture, 0, 0, 64, 64, x, (canvas.height-h)/2, 2, h);
                
                // Ombre distance (Fog) - Légèrement bleuté pour l'air frais
                let fogAmount = Math.min(0.8, dist/800);
                ctx.fillStyle = `rgba(20, 30, 50, ${fogAmount})`;
                ctx.fillRect(x, (canvas.height-h)/2, 2, h);
            }

            // Sprites
            items.forEach(item => {
                let dx = item.x - playerObj.x; let dy = item.y - playerObj.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                let angle = Math.atan2(dy, dx) - playerObj.dir;
                while(angle < -Math.PI) angle += 2*Math.PI;
                while(angle > Math.PI) angle -= 2*Math.PI;
                
                if(Math.abs(angle) < FOV/1.5 && dist > 15) {
                    let h = (TILE_SIZE * canvas.height) / dist;
                    let screenX = (0.5 * (angle/(FOV/2)) + 0.5) * canvas.width - h/2;
                    ctx.drawImage(samuelSprite, screenX, (canvas.height-h)/2, h, h);
                }
            });
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
