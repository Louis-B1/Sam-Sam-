<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paris Investigation : Pigalle Unlocked</title>
    <style>
        /* --- ESTHÉTIQUE GÉNÉRALE --- */
        body {
            background-color: #000;
            margin: 0; padding: 0;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            width: 100vw; height: 100vh;
            user-select: none;
            color: #ddd;
        }
        #game-container { position: relative; width: 100%; height: 100%; }
        /* Canvas en pleine résolution */
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        /* --- FX VISUELS --- */
        #flashlight {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 15%, rgba(0,0,0,0.96) 60%);
            pointer-events: none; z-index: 4; mix-blend-mode: multiply;
        }
        #vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 150px rgba(0,0,0,1);
            pointer-events: none; z-index: 5;
        }
        .rain {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAH0lEQVQoU2nkCAMAAwkBmqMI4H8h/w+rhw0g32OYJQxwQDgfv99cAAAAAElFTkSuQmCC') repeat;
            opacity: 0.1; pointer-events: none;
            animation: rainAnim 0.5s linear infinite; z-index: 3;
        }
        @keyframes rainAnim { from { background-position: 0 0; } to { background-position: 10px 20px; } }

        /* --- UI / HUD --- */
        #ui-layer {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            display: none; /* Caché au début */
            gap: 20px; align-items: flex-start;
        }
        #radar {
            background: rgba(0, 10, 0, 0.9);
            border: 2px solid #555; border-radius: 50%;
            width: 120px; height: 120px;
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
        }
        #mission-panel {
            background: rgba(10, 10, 10, 0.9); padding: 15px;
            border-left: 4px solid #d4af37; color: #ccc;
            backdrop-filter: blur(5px);
            font-size: 16px; text-shadow: 1px 1px 0 #000;
        }

        /* --- DIALOGUES & INTRO --- */
        #intro-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 40px; box-sizing: border-box; text-align: left;
        }
        #intro-text {
            font-size: 22px; line-height: 1.6; color: #eee;
            max-width: 800px; white-space: pre-wrap;
        }
        #skip-btn {
            margin-top: 40px; border: 2px solid #555; padding: 15px 30px;
            cursor: pointer; color: #aaa; font-size: 16px; opacity: 0; transition: opacity 1s;
            text-transform: uppercase; background: #111;
        }
        #skip-btn:hover { background: #333; color: #fff; border-color: #fff; }

        #dialogue-box {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            width: 70%; background: rgba(5, 5, 5, 0.95);
            border: 2px solid #666; border-top: 5px solid #d4af37;
            padding: 25px; z-index: 20; display: none;
            color: #fff; font-size: 20px; box-shadow: 0 10px 40px #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #dialogue-box.active { display: block; animation: popUp 0.3s ease-out; }
        @keyframes popUp { from { transform: translate(-50%, 50px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* --- ÉCRAN DE FIN --- */
        #win-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5,0,0,0.98); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 50;
        }
        #samuel-reveal { height: 45vh; border: 4px solid #fff; margin-bottom: 20px; box-shadow: 0 0 50px rgba(200,0,0,0.5); }
    </style>
</head>
<body>

    <div id="youtube-audio" style="position:absolute; top:-9999px;"></div>

    <div id="game-container">
        <div id="flashlight"></div>
        <div id="vignette"></div>
        <div class="rain"></div>
        
        <canvas id="gameCanvas"></canvas>
        
        <div id="intro-screen">
            <div id="intro-text"></div>
            <div id="skip-btn">COMMENCER L'ENQUÊTE</div>
        </div>

        <div id="ui-layer">
            <canvas id="radar" width="120" height="120"></canvas>
            <div id="mission-panel">
                <div id="zoneName" style="font-size: 22px; color: #fff; font-weight: bold; margin-bottom: 8px;">LIEU INCONNU</div>
                <div style="color:#d4af37; margin-bottom: 5px;">PREUVES : <span id="score" style="color:#fff;">0</span> / 3</div>
                <div style="font-size: 12px; color: #888;">[FLÈCHES] Marcher - [SHIFT] Courir</div>
            </div>
        </div>

        <div id="dialogue-box"></div>

        <div id="win-screen">
            <h1 style="color:#d43737; font-size: 60px; text-shadow: 0 0 20px #500; margin-bottom: 20px;">IL EST LÀ.</h1>
            <img id="samuel-reveal" src="samuel.png" alt="Samuel">
            <p style="color: #888; font-size: 18px;">L'enquête est terminée.</p>
            <p style="color: #555; font-size: 14px; margin-top:10px;">(Cliquez pour recommencer)</p>
        </div>
    </div>

    <script>
        // --- 1. AUDIO YOUTUBE ---
        var player;
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-audio', {
                height: '0', width: '0', videoId: 'bUKC5RAjUdg',
                playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1, 'playlist': 'bUKC5RAjUdg' }
            });
        }
        function changeMusic(mode) {
            if(!player || !player.loadVideoById) return;
            // 0=Intro/Marais, 1=Pigalle
            if(mode === 0) player.loadVideoById('bUKC5RAjUdg'); 
            if(mode === 1) player.loadVideoById('vvHCLeS0bCY');
        }

        // --- 2. INTRO NARRATIVE ---
        const introLines = [
            "Paris. 22h30.",
            "Je sors à peine de la fac. Une journée interminable.",
            "Mon téléphone vibre. C'est Samuel.",
            "...",
            "Message vide. Juste une localisation GPS.",
            "Il n'est pas rentré hier soir. Personne n'a de nouvelles.",
            "La localisation pointe vers le Marais... Place des Vosges.",
            "Je dois le retrouver."
        ];
        
        let lineIndex = 0;
        let charIndex = 0;
        const introTextEl = document.getElementById('intro-text');
        const skipBtn = document.getElementById('skip-btn');

        function typeWriter() {
            if (lineIndex < introLines.length) {
                if (charIndex < introLines[lineIndex].length) {
                    introTextEl.innerHTML += introLines[lineIndex].charAt(charIndex);
                    charIndex++;
                    setTimeout(typeWriter, 35); 
                } else {
                    introTextEl.innerHTML += "<br><br>";
                    lineIndex++;
                    charIndex = 0;
                    setTimeout(typeWriter, 500);
                }
            } else {
                skipBtn.style.opacity = 1;
            }
        }
        window.onload = typeWriter;

        skipBtn.addEventListener('click', () => {
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            gameActive = true;
            loadLevel(0);
            if(player && player.unMute) { player.unMute(); player.setVolume(100); player.playVideo(); }
            loop();
        });

        // --- 3. MOTEUR GRAPHIQUE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const radarCanvas = document.getElementById('radar');
        const radarCtx = radarCanvas.getContext('2d');
        ctx.imageSmoothingEnabled = false; // Pixel art net

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        // Assets
        const samuelSprite = new Image(); samuelSprite.src = "samuel.png";
        
        // --- GÉNÉRATEUR TEXTURE HD (128px de large) ---
        const texWidth = 128; // Plus de détails horizontaux
        const texHeight = 1024; // Haute résolution verticale

        function createTexture(type) {
            const c = document.createElement('canvas'); c.width = texWidth; c.height = texHeight;
            const x = c.getContext('2d');
            
            if (type === 'vosges_wall') {
                // Pierre de taille (Soubassement)
                x.fillStyle = '#989088'; x.fillRect(0, 600, texWidth, 424);
                // Bruit pierre
                x.fillStyle = '#787068'; 
                for(let i=0; i<200; i++) x.fillRect(Math.random()*texWidth, 600+Math.random()*400, 3, 3);
                
                // BRIQUES (Partie haute)
                x.fillStyle = '#8a3a3a'; x.fillRect(0, 0, texWidth, 600);
                // Joints et détails
                for(let y=0; y<600; y+=40) { // Briques plus grosses
                    let offset = (y/40)%2 === 0 ? 0 : 64;
                    // Joints horizontaux
                    x.fillStyle = '#1a1a1a'; x.fillRect(0, y, texWidth, 4);
                    // Joints verticaux
                    x.fillRect(offset, y, 4, 40); x.fillRect(offset+64, y, 4, 40);
                    // Texture sur la brique
                    x.fillStyle = 'rgba(0,0,0,0.1)';
                    x.fillRect(offset+10, y+10, 40, 20);
                }
                // Arche sombre en bas
                x.fillStyle = 'rgba(0,0,0,0.6)'; x.fillRect(0, 700, texWidth, 324);
            } 
            else if (type === 'vosges_tree') {
                // Arbres détaillés
                x.fillStyle = '#051005'; x.fillRect(0,0,texWidth,texHeight);
                function drawLeaves(color, count, size) {
                    x.fillStyle = color;
                    for(let i=0; i<count; i++) {
                        let lx = Math.random()*texWidth;
                        let ly = Math.random()*texHeight;
                        x.fillRect(lx, ly, size, size); // Carrés pour effet pixel art net
                    }
                }
                drawLeaves('#1a3a15', 800, 8); // Sombre
                drawLeaves('#2a6a25', 800, 6); // Moyen
                drawLeaves('#4a9a45', 400, 4); // Clair (Reflets)
            }
            else if (type === 'pigalle') {
                // Mur sale urbain
                x.fillStyle = '#222'; x.fillRect(0,0,texWidth,texHeight);
                x.fillStyle = '#111'; 
                for(let y=0; y<texHeight; y+=20) x.fillRect(0, y, texWidth, 2); // Lignes fines
                // Graffiti / Crasse
                x.fillStyle = '#aa0033'; 
                for(let i=0; i<50; i++) x.fillRect(Math.random()*texWidth, 400+Math.random()*200, Math.random()*20, Math.random()*50);
            }
            
            const img = new Image(); img.src = c.toDataURL(); return img;
        }

        const TEX_VOSGES = createTexture('vosges_wall');
        const TEX_TREE = createTexture('vosges_tree');
        const TEX_PIGALLE = createTexture('pigalle');

        // Texture Indice (Pixel Art 64x64)
        const clueCanvas = document.createElement('canvas'); clueCanvas.width=64; clueCanvas.height=64;
        const cCtx = clueCanvas.getContext('2d');
        cCtx.fillStyle = '#ffcc00'; cCtx.fillRect(16,20,32,36); // Dossier
        cCtx.fillStyle = '#fff'; cCtx.fillRect(18,24,28,4); // Étiquette
        cCtx.strokeStyle='#000'; cCtx.lineWidth=2; cCtx.strokeRect(16,20,32,36);
        const clueSprite = new Image(); clueSprite.src = clueCanvas.toDataURL();

        // --- 4. CONFIG ET GAMEPLAY ---
        const TILE_SIZE = 64; 
        const FOV = Math.PI / 2.5; 
        let playerObj = { x: 0, y: 0, dir: 0 };
        
        // VITESSE RALENTIE (Joueur plus lourd)
        const WALK = 2.0; 
        const RUN = 3.5; 
        const ROT = 0.03; 

        let currentLevel = 0; let gameActive = false; let timer = 0;
        let cluesFound = 0; let dialogueTimer = null;
        let keys = {}; // Touches

        // Textes narratifs
        const narrative = [
            [ 
                "Un ticket du 'Café Hugo'. 21h15. Il était là.", 
                "Son carnet de croquis. Une page est arrachée violemment.", 
                "Sa carte Navigo. Samuel ne l'aurait jamais jetée." 
            ],
            [ 
                "Un flyer froissé : 'Moulin Rouge - Staff'. Samuel ne bosse pas là...", 
                "Des lunettes de soleil cassées. Les siennes.", 
                "Son téléphone. Écran brisé. Message non envoyé : 'AIDE MOI'." 
            ]
        ];

        // 1=Mur, 2=Arbre, 5=Indice, 9=Sortie, 0=Vide
        const levels = [
            {
                name: "PLACE DES VOSGES (22H45)",
                texWall: TEX_VOSGES, texTree: TEX_TREE, hasGrass: true,
                map: [
                    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                    [1,0,0,2,2,2,2,2,0,0,2,2,2,2,2,2,0,0,2,2,2,0,0,1], // Entrées (0)
                    [1,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,1],
                    [1,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,2,0,0,1], // Indice
                    [1,0,0,2,0,0,0,2,2,0,0,0,0,0,0,2,2,0,0,0,2,0,0,1],
                    [1,0,0,2,0,0,0,2,2,0,0,0,0,0,0,2,2,0,0,0,2,0,0,1],
                    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], // Grande allée centrale
                    [1,0,0,2,2,2,0,0,0,0,2,2,2,2,0,0,0,0,2,2,2,0,0,1],
                    [1,0,0,2,2,2,0,0,0,0,2,2,2,2,0,0,0,0,2,2,2,0,0,1],
                    [1,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,1],
                    [1,0,0,2,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,2,0,0,1], // Indice
                    [1,0,0,2,0,0,0,2,2,0,0,0,0,0,0,2,2,0,0,0,2,0,0,1],
                    [1,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,1],
                    [1,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,5,1], // Indice
                    [1,0,0,2,2,2,2,2,0,0,2,2,2,2,2,2,0,0,2,2,2,0,0,1], // Entrées (0)
                    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,1], // Sortie
                    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
                ], 
                start: {x: 2.5, y: 2.5, dir: 0.8}
            },
            {
                name: "PIGALLE - IMPASSE (23H30)",
                texWall: TEX_PIGALLE, texTree: TEX_PIGALLE, hasGrass: false,
                // CARTE CORRIGÉE : RUES LARGES (3 BLOCS DE LARGE)
                map: [
                    [1,1,1,1,1,1,1,1,1,1,1,1],
                    [1,0,0,0,5,0,0,0,0,0,0,1],
                    [1,0,0,0,0,0,0,0,0,0,0,1],
                    [1,0,0,1,1,1,0,1,1,1,0,1],
                    [1,0,0,1,0,0,0,0,0,1,0,1],
                    [1,0,0,1,0,5,0,5,0,1,0,1],
                    [1,0,0,1,0,0,0,0,0,1,0,1],
                    [1,0,0,1,1,1,0,1,1,1,0,1],
                    [1,5,0,0,0,0,0,0,0,0,8,1],
                    [1,0,0,0,0,0,0,0,0,0,0,1],
                    [1,1,1,1,1,1,1,1,1,1,1,1]
                ], 
                // Départ sécurisé au milieu de la rue large
                start: {x: 2.5, y: 1.5, dir: 0}
            }
        ];

        let map=[]; let items=[];

        function loadLevel(idx) {
            if(idx >= levels.length) return;
            currentLevel = idx; cluesFound = 0;
            const lvl = levels[idx];

            document.getElementById('zoneName').innerText = lvl.name;
            document.getElementById('score').innerText = "0";
            hideDialogue();
            changeMusic(idx);
            
            // RESET DES TOUCHES POUR ÉVITER LE BUG DE COURSE
            for (let member in keys) delete keys[member];

            map = lvl.map;
            playerObj.x = lvl.start.x * TILE_SIZE;
            playerObj.y = lvl.start.y * TILE_SIZE;
            playerObj.dir = lvl.start.dir;

            items = [];
            let clueCount = 0;
            for(let y=0; y<map.length; y++) for(let x=0; x<map[y].length; x++) {
                if(map[y][x] === 5) {
                    let txt = narrative[currentLevel][clueCount] || "Un indice.";
                    items.push({x: x*TILE_SIZE+32, y: y*TILE_SIZE+32, type: 'clue', active:true, text: txt});
                    map[y][x] = 0; clueCount++;
                }
                if(map[y][x] === 8) {
                    items.push({x: x*TILE_SIZE+32, y: y*TILE_SIZE+32, type: 'samuel', active:true});
                    map[y][x] = 0;
                }
            }
        }

        // --- 5. LOGIQUE DU JEU ---
        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        function update() {
            if(!gameActive) return;

            // Rotation
            if (keys['ArrowLeft']) playerObj.dir -= ROT;
            if (keys['ArrowRight']) playerObj.dir += ROT;

            // Déplacement
            let speed = keys['ShiftLeft'] ? RUN : WALK;
            let step = 0;
            if (keys['ArrowUp']) step = speed;
            if (keys['ArrowDown']) step = -speed;
            
            if (step !== 0) {
                timer += speed * 0.1;
                let nextX = playerObj.x + Math.cos(playerObj.dir) * step;
                let nextY = playerObj.y + Math.sin(playerObj.dir) * step;
                
                let gridX = Math.floor(nextX / TILE_SIZE);
                let gridY = Math.floor(nextY / TILE_SIZE);

                // Collision
                if (map[gridY] && map[gridY][gridX] !== 1 && map[gridY][gridX] !== 2) {
                    playerObj.x = nextX;
                    playerObj.y = nextY;

                    // Sortie (Case 9)
                    if (map[gridY][gridX] === 9) {
                        if (cluesFound >= 3) {
                            showDialogue("Une piste vers le Nord... Pigalle.", 3000);
                            // Petit recul pour éviter le spam
                            playerObj.x -= Math.cos(playerObj.dir)*30; 
                            playerObj.y -= Math.sin(playerObj.dir)*30;
                            setTimeout(() => loadLevel(1), 2000);
                        } else {
                            playerObj.x -= Math.cos(playerObj.dir)*20;
                            playerObj.y -= Math.sin(playerObj.dir)*20;
                            showDialogue("Je dois trouver 3 indices avant de partir.", 2000);
                        }
                    }
                }
            }

            // Ramasser Objets
            items.forEach(item => {
                if(!item.active) return;
                let d = Math.hypot(playerObj.x - item.x, playerObj.y - item.y);
                if(d < 50) { // Rayon de ramassage
                    if(item.type === 'clue') {
                        item.active = false; cluesFound++;
                        document.getElementById('score').innerText = cluesFound;
                        showDialogue(item.text, 5000);
                    } else if(item.type === 'samuel') {
                        gameActive = false;
                        document.getElementById('win-screen').style.display = 'flex';
                        document.getElementById('ui-layer').style.display = 'none';
                        document.getElementById('dialogue-box').style.display = 'none';
                    }
                }
            });
        }

        function showDialogue(text, time) {
            const box = document.getElementById('dialogue-box');
            box.innerText = text; box.classList.add('active');
            if(dialogueTimer) clearTimeout(dialogueTimer);
            if(time) dialogueTimer = setTimeout(hideDialogue, time);
        }
        function hideDialogue() { document.getElementById('dialogue-box').classList.remove('active'); }

        // --- 6. RAYCASTING (RENDU) ---
        function draw() {
            // Ciel
            ctx.fillStyle = "#050505"; ctx.fillRect(0,0,canvas.width,canvas.height/2);
            // Sol (Vert pour Vosges, Gris pour Pigalle)
            ctx.fillStyle = levels[currentLevel].hasGrass ? "#0e1a0e" : "#151515"; 
            ctx.fillRect(0,canvas.height/2,canvas.width,canvas.height/2);

            const numRays = Math.ceil(canvas.width / 2);
            const bob = Math.sin(timer) * 4; // Head bobbing réduit

            for (let i = 0; i < numRays; i++) {
                let angle = (playerObj.dir - FOV/2) + (i/numRays) * FOV;
                let eyeX = Math.cos(angle), eyeY = Math.sin(angle);
                let dist = 0, hit = 0;
                let rayX = playerObj.x, rayY = playerObj.y;
                let textureId = 1;

                // Raycast
                while(dist < 2000 && hit === 0) {
                    dist += 4;
                    rayX += eyeX*4; rayY += eyeY*4;
                    let tx = Math.floor(rayX/TILE_SIZE), ty = Math.floor(rayY/TILE_SIZE);
                    
                    if(ty<0 || ty>=map.length || tx<0 || tx>=map[0].length) { 
                        hit=1; 
                    } else if(map[ty][tx] > 0 && map[ty][tx] !== 9 && map[ty][tx] !== 5 && map[ty][tx] !== 8) { 
                        hit = 1; textureId = map[ty][tx]; 
                    }
                }

                // Dessin colonne
                if(dist < 2000) {
                    let correctedDist = dist * Math.cos(angle - playerObj.dir);
                    let h = (TILE_SIZE * canvas.height) / correctedDist;
                    let x = i*2; 
                    let y = (canvas.height - h)/2 + bob;
                    
                    let tex = (textureId === 2) ? levels[currentLevel].texTree : levels[currentLevel].texWall;
                    
                    // Calcul texture X
                    let texX = 0;
                    if(Math.abs((rayX%TILE_SIZE) - TILE_SIZE) < 3 || (rayX%TILE_SIZE) < 3) texX = rayY%TILE_SIZE;
                    else texX = rayX%TILE_SIZE;
                    
                    // Mapping précis sur la texture 128px de large
                    texX = Math.floor((texX/TILE_SIZE) * texWidth); 

                    // Ombrage distance
                    let shade = Math.max(0, 1 - dist/1500);
                    
                    ctx.drawImage(tex, texX, 0, 1, texHeight, x, y, 2, h);
                    ctx.fillStyle = `rgba(0,0,0,${1-shade})`; 
                    ctx.fillRect(x,y,2,h);
                }
            }

            // Sprites
            items.sort((a,b) => Math.hypot(playerObj.x-b.x, playerObj.y-b.y) - Math.hypot(playerObj.x-a.x, playerObj.y-a.y));
            items.forEach(item => {
                if(!item.active) return;
                let dx = item.x - playerObj.x, dy = item.y - playerObj.y;
                let d = Math.sqrt(dx*dx + dy*dy);
                let itemAngle = Math.atan2(dy, dx) - playerObj.dir;
                while(itemAngle < -Math.PI) itemAngle += 2*Math.PI; while(itemAngle > Math.PI) itemAngle -= 2*Math.PI;

                if(Math.abs(itemAngle) < FOV/1.5 && d > 20) {
                    let h = (TILE_SIZE * canvas.height) / d;
                    let x = (0.5 * (itemAngle/(FOV/2)) + 0.5) * canvas.width - h/2;
                    let y = (canvas.height - h)/2 + bob;
                    
                    let img = item.type==='samuel' ? samuelSprite : clueSprite;
                    if(img.complete) ctx.drawImage(img, x, y, h, h);
                }
            });

            drawRadar();
        }

        function drawRadar() {
            radarCtx.clearRect(0,0,120,120);
            const zoom = 4; const cx=60, cy=60;
            for(let y=0; y<map.length; y++) for(let x=0; x<map[0].length; x++) {
                let dx = (x*TILE_SIZE - playerObj.x)/TILE_SIZE * zoom;
                let dy = (y*TILE_SIZE - playerObj.y)/TILE_SIZE * zoom;
                if(Math.abs(dx)<60 && Math.abs(dy)<60) {
                    if(map[y][x]===1) { radarCtx.fillStyle='#555'; radarCtx.fillRect(cx+dx,cy+dy,zoom,zoom); }
                    if(map[y][x]===2) { radarCtx.fillStyle='#252'; radarCtx.fillRect(cx+dx,cy+dy,zoom,zoom); }
                    if(map[y][x]===9) { radarCtx.fillStyle='#d00'; radarCtx.fillRect(cx+dx,cy+dy,zoom,zoom); }
                }
            }
            // Joueur
            radarCtx.fillStyle='#fff'; radarCtx.beginPath(); radarCtx.arc(cx,cy,2,0,6.28); radarCtx.fill();
        }

        function loop() { update(); draw(); requestAnimationFrame(loop); }

        document.getElementById('win-screen').addEventListener('click', () => location.reload());

    </script>
</body>
</html>
