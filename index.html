<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission: Place des Vosges</title>
    <style>
        /* --- STYLE GLOBAL --- */
        body { 
            background-color: #050505; 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Courier New', monospace; 
            color: white; 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
        }

        /* --- 1. ECRAN TITRE --- */
        #title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 300; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            animation: fadeOut 1.5s ease-in-out 3s forwards; pointer-events: none;
        }
        #title-main { font-size: 60px; color: #fff; letter-spacing: 10px; font-weight: bold; }
        #title-sub { font-size: 25px; color: #d43737; letter-spacing: 5px; margin-top: 10px; }
        
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

        /* --- 2. TÉLÉPHONE (CHAT) --- */
        #phone-container {
            position: absolute; width: 360px; height: 720px;
            background: #111; border: 12px solid #222; border-radius: 40px;
            display: flex; flex-direction: column; overflow: hidden;
            z-index: 200; box-shadow: 0 0 50px rgba(0,0,0,0.8);
            opacity: 0; animation: fadeIn 1s ease-out 3.5s forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        #chat-header {
            background: #202020; padding: 20px; text-align: center; border-bottom: 1px solid #333;
            color: #fff; font-weight: bold; font-size: 16px;
        }
        #chat-body {
            flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 12px;
            background: #000; overflow-y: auto; scroll-behavior: smooth;
        }
        .msg {
            max-width: 80%; padding: 12px; border-radius: 18px; font-size: 14px; line-height: 1.4;
            animation: slideUp 0.3s ease-out; position: relative;
        }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .left { background: #333; align-self: flex-start; border-bottom-left-radius: 2px; color: #ddd; }
        .right { background: #007aff; align-self: flex-end; border-bottom-right-radius: 2px; color: white; }
        .sender { font-size: 10px; color: #888; margin-bottom: 4px; display: block; }

        #btn-start {
            padding: 25px; background: #27ae60; color: white; text-align: center; 
            cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 18px;
            display: none; border-top: 2px solid #2ecc71;
        }
        #btn-start:hover { background: #2ecc71; }

        /* --- 3. JEU (CANVAS + UI) --- */
        #game-container { position: relative; display: none; }
        
        canvas { 
            background: #111; border: 4px solid #555; box-shadow: 0 0 60px rgba(0,0,0,1);
            image-rendering: pixelated; display: block;
        }

        #game-ui {
            position: absolute; top: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.8); padding: 15px; border-radius: 8px; border: 2px solid #fff;
            color: white; font-family: sans-serif; min-width: 200px;
        }
        .ui-title { color: #e74c3c; font-weight: bold; font-size: 18px; margin-bottom: 5px; }
        .ui-score { font-size: 16px; }
        #msg-popup { 
            margin-top: 10px; color: #3498db; font-weight: bold; height: 20px; 
            text-shadow: 1px 1px 0 #000;
        }

        /* --- 4. FIN --- */
        #end-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5,5,5,0.98); z-index: 400; display: none;
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        #samuel-img {
            width: 250px; height: 250px; object-fit: cover; border: 5px solid #27ae60; margin: 20px;
            background: #222; display: flex; align-items: center; justify-content: center; color: #666;
        }
    </style>
</head>
<body>

    <div id="youtube-audio" style="position:absolute; top:-9999px;"></div>

    <div id="title-screen">
        <div id="title-main">PARIS</div>
        <div id="title-sub">BY NIGHT</div>
    </div>

    <div id="phone-container">
        <div id="chat-header">Groupe: Les Chipies (4)</div>
        <div id="chat-body"></div>
        <div id="btn-start">ALLER CHERCHER SAMUEL</div>
    </div>

    <div id="game-container">
        <div id="game-ui">
            <div class="ui-title">PLACE DES VOSGES</div>
            <div class="ui-score">Indices : <span id="score" style="color:#f1c40f">0</span> / 3</div>
            <div id="msg-popup"></div>
        </div>
        <canvas id="gameCanvas" width="800" height="800"></canvas>
    </div>

    <div id="end-screen">
        <h1 style="color:#27ae60; font-size:40px;">SAMUEL RETROUVÉ !</h1>
        
        <img id="samuel-img" src="samuel.jpg" alt="Samuel" onerror="this.style.display='none'; document.getElementById('alt-text').style.display='block'">
        <div id="alt-text" style="display:none; color:white; border:2px solid #444; padding:20px; margin:20px;">(Ajoute 'samuel.jpg' dans le dossier pour voir la photo)</div>

        <div style="background:#222; padding:20px; border-radius:10px; max-width:600px; font-size:20px; line-height:1.5;">
            "Wesh l'équipe... J'ai plus de batterie.<br>
            Je dormais sur un banc.<br>
            C'était pas la police, juste des pigeons qui m'attaquaient."
        </div>
        <br>
        <button onclick="location.reload()" style="padding:15px 30px; font-size:18px; cursor:pointer; background:#d43737; color:white; border:none; border-radius:5px;">REJOUER</button>
    </div>

    <script>
        // --- 1. CONFIGURATION AUDIO (Youtube) ---
        var player;
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-audio', {
                height: '0', width: '0',
                videoId: 'Vol9dZ-t93s', // La Bohème - Aznavour
                playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1, 'playlist': 'Vol9dZ-t93s' }
            });
        }

        // --- 2. DONNEES DU JEU ---
        const TILE = 40; // Taille d'une case (20x20 cases = 800px)
        const GRID_SIZE = 20;
        
        // Chat
        const messages = [
            { s: 'Matthieu', t: "Il est où Samuel ? Le prof va faire l'appel." },
            { s: 'Samuel', t: "LES CHIPIES C'EST CHAUD." },
            { s: 'Samuel', t: "La police me coursent !!" },
            { s: 'Moi', t: "Mdr arrête tes mythos Sam, t'as encore bu ?" },
            { s: 'Samuel', t: "Jure que non ! J'étais Place des Vosges." },
            { s: 'Julie', t: "Il a encore perdu sa carte étudiante..." },
            { s: 'Samuel', t: "J'ai tout paumé en courant. Venez me chercher." },
            { s: 'Moi', t: "Ok j'arrive. Bouge pas." }
        ];

        // Items à trouver
        let items = [
            {x: 4, y: 4, name: "Carte Étudiante"},
            {x: 15, y: 4, name: "Kebab Sauce Blanche"},
            {x: 4, y: 15, name: "Paquet de Clopes"}
        ];
        
        let samuelPos = {x: 16, y: 16}; // Samuel caché
        let playerPos = {x: 10, y: 18}; // Départ en bas
        let score = 0;
        let gameActive = false;

        // Génération de la Carte (Place des Vosges simplifiée)
        // 0=Herbe, 1=Mur Rouge, 2=Chemin Gris, 3=Statue, 9=Samuel
        let map = [];

        function generateMap() {
            for(let y=0; y<GRID_SIZE; y++) {
                let row = [];
                for(let x=0; x<GRID_SIZE; x++) {
                    // Par défaut : Herbe
                    let type = 0; 

                    // MURS EXTERIEURS (Bâtiments rouges)
                    if (x===0 || x===GRID_SIZE-1 || y===0 || y===GRID_SIZE-1) type = 1;

                    // CHEMINS (Arcades intérieures + Croix centrale)
                    else if (x===2 || x===GRID_SIZE-3 || y===2 || y===GRID_SIZE-3) type = 2; // Tour
                    else if (x===GRID_SIZE/2 || x===GRID_SIZE/2-1) type = 2; // Vertical
                    else if (y===GRID_SIZE/2 || y===GRID_SIZE/2-1) type = 2; // Horizontal
                    
                    // FONTAINES (Coins du carré central) - Optionnel, on laisse en herbe pour l'instant
                    
                    row.push(type);
                }
                map.push(row);
            }
            // Statue au centre
            map[9][9] = 3; map[10][10] = 3; map[9][10] = 3; map[10][9] = 3;
        }

        // --- 3. FONCTIONS LOGIQUES ---
        
        // Intro Chat
        let msgIndex = 0;
        function playChat() {
            if (msgIndex >= messages.length) {
                document.getElementById('btn-start').style.display = 'block';
                return;
            }
            const m = messages[msgIndex];
            const div = document.createElement('div');
            div.className = `msg ${m.s === 'Moi' ? 'right' : 'left'}`;
            div.innerHTML = `<span class="sender">${m.s}</span>${m.t}`;
            
            const chatBox = document.getElementById('chat-body');
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            msgIndex++;
            setTimeout(playChat, 1200);
        }

        // Démarrage Jeu
        function startGame() {
            document.getElementById('phone-container').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            
            // Lancer la musique (User Interaction requise, donc ici ça marche)
            if(player && player.playVideo) {
                player.unMute();
                player.setVolume(80);
                player.playVideo();
            }

            gameActive = true;
            generateMap();
            drawGame();
        }

        // Déplacement
        function movePlayer(dx, dy) {
            if(!gameActive) return;

            let nx = playerPos.x + dx;
            let ny = playerPos.y + dy;

            // Collision Murs (1) et Statue (3)
            if(map[ny][nx] === 1 || map[ny][nx] === 3) return;

            playerPos.x = nx;
            playerPos.y = ny;

            // Check Items
            let itemIdx = items.findIndex(i => i.x === nx && i.y === ny);
            if(itemIdx !== -1) {
                score++;
                document.getElementById('score').innerText = score;
                showMsg(`Trouvé : ${items[itemIdx].name}`);
                items.splice(itemIdx, 1); // Retirer l'objet
            }

            // Check Samuel
            if(nx === samuelPos.x && ny === samuelPos.y) {
                if(score >= 3) endGame();
                else showMsg("Il te manque des objets !");
            }

            drawGame();
        }

        function showMsg(text) {
            const el = document.getElementById('msg-popup');
            el.innerText = text;
            setTimeout(() => el.innerText = "", 2000);
        }

        function endGame() {
            gameActive = false;
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('end-screen').style.display = 'flex';
        }

        // --- 4. MOTEUR GRAPHIQUE ---
        const ctx = document.getElementById('gameCanvas').getContext('2d');

        function drawGame() {
            ctx.clearRect(0, 0, 800, 800);

            // 1. DESSINER LA CARTE
            for(let y=0; y<GRID_SIZE; y++) {
                for(let x=0; x<GRID_SIZE; x++) {
                    let type = map[y][x];
                    let px = x * TILE;
                    let py = y * TILE;

                    if(type === 0) { // Herbe
                        ctx.fillStyle = "#27ae60"; ctx.fillRect(px, py, TILE, TILE);
                        // Petit détail herbe
                        ctx.fillStyle = "#2ecc71"; ctx.fillRect(px+10, py+10, 5, 5); 
                    } 
                    else if(type === 1) { // Mur Brique
                        ctx.fillStyle = "#c0392b"; ctx.fillRect(px, py, TILE, TILE);
                        ctx.strokeStyle = "#922b21"; ctx.strokeRect(px, py, TILE, TILE);
                    }
                    else if(type === 2) { // Chemin
                        ctx.fillStyle = "#ecf0f1"; ctx.fillRect(px, py, TILE, TILE);
                    }
                    else if(type === 3) { // Statue
                        ctx.fillStyle = "#7f8c8d"; ctx.fillRect(px, py, TILE, TILE);
                    }
                }
            }

            // 2. DESSINER ITEMS
            items.forEach(item => {
                let px = item.x * TILE + TILE/2;
                let py = item.y * TILE + TILE/2;
                ctx.fillStyle = "#f1c40f"; 
                ctx.beginPath(); ctx.arc(px, py, 12, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = "#000"; ctx.stroke();
            });

            // 3. DESSINER SAMUEL (Caché)
            // On affiche un indice visuel discret
            let sx = samuelPos.x * TILE;
            let sy = samuelPos.y * TILE;
            ctx.fillStyle = "#d35400"; ctx.fillRect(sx+10, sy+10, 20, 20); // Juste une tache orange
            
            // 4. DESSINER JOUEUR
            let plx = playerPos.x * TILE;
            let ply = playerPos.y * TILE;
            
            // Corps
            ctx.fillStyle = "#3498db"; ctx.fillRect(plx+5, ply+10, 30, 25);
            // Tête
            ctx.fillStyle = "#f1c40f"; ctx.fillRect(plx+10, ply+2, 20, 15);
        }

        // --- 5. INITIALISATION ---
        window.onload = function() {
            // Lancer le chat après 4s (temps de l'intro)
            setTimeout(playChat, 4000);
        };

        document.getElementById('btn-start').addEventListener('click', startGame);

        window.addEventListener('keydown', (e) => {
            if(e.key === "ArrowUp") movePlayer(0, -1);
            if(e.key === "ArrowDown") movePlayer(0, 1);
            if(e.key === "ArrowLeft") movePlayer(-1, 0);
            if(e.key === "ArrowRight") movePlayer(1, 0);
        });

    </script>
</body>
</html>
