<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission: Retrouver Samuel (ESG Edition)</title>
    <style>
        body { 
            background-color: #1a1a1a; 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Courier New', monospace; 
            color: white; 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* --- UI DU TÉLÉPHONE (Intro) --- */
        #phone-container {
            position: absolute; width: 350px; height: 700px;
            background: #000; border: 8px solid #333; border-radius: 30px;
            display: flex; flex-direction: column; overflow: hidden;
            z-index: 100; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        #chat-header {
            background: #222; padding: 15px; text-align: center; border-bottom: 1px solid #444;
            font-weight: bold; color: #fff;
        }
        #chat-body {
            flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 10px;
            background: #111; overflow-y: auto;
        }
        .msg {
            max-width: 80%; padding: 10px; border-radius: 15px; font-size: 14px;
            animation: pop 0.3s ease-out;
        }
        .left { background: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        .right { background: #007aff; align-self: flex-end; border-bottom-right-radius: 2px; }
        .name { font-size: 10px; color: #aaa; margin-bottom: 3px; }
        
        #btn-start {
            padding: 20px; background: #28a745; color: white; text-align: center; 
            cursor: pointer; font-weight: bold; text-transform: uppercase;
            transition: background 0.2s;
        }
        #btn-start:hover { background: #218838; }

        /* --- UI JEU --- */
        #game-ui {
            position: absolute; top: 20px; left: 20px; z-index: 10; display: none;
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; border: 2px solid #555;
        }
        .hud-text { margin: 5px 0; font-size: 16px; }
        .item-list { color: #ffd700; font-size: 14px; margin-top: 5px; }

        canvas { 
            box-shadow: 0 0 30px rgba(0,0,0,0.5); 
            image-rendering: pixelated; 
            display: none; /* Caché au début */
        }

        #end-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; display: none;
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        
        @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="phone-container">
        <div id="chat-header">Groupe: PROJET DE GROUPE (4)</div>
        <div id="chat-body">
            </div>
        <div id="btn-start" style="display:none;">ALLER CHERCHER SAMUEL</div>
    </div>

    <div id="game-ui">
        <div class="hud-text" style="color:#4db8ff; font-weight:bold;" id="zone-name">PLACE DES VOSGES</div>
        <div class="hud-text">Objets trouvés: <span id="score">0</span>/3</div>
        <div class="hud-text" style="font-size:12px; color:#aaa;">[FLÈCHES] Bouger</div>
        <div id="message-area" style="margin-top:10px; color:#ff5555; font-weight:bold; min-height:20px;"></div>
    </div>

    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="end-screen">
        <h1 style="color: #28a745; font-size: 40px;">SAMUEL RETROUVÉ !</h1>
        <p style="font-size: 20px; max-width: 600px; line-height: 1.5;">
            "Wesh les gars, désolé j'avais plus de batterie et je me suis endormi dans le Kebab.<br>
            C'est pas la police, c'est juste le vigile du Monoprix qui m'a regardé bizarre."
        </p>
        <br>
        <button onclick="location.reload()" style="padding:15px 30px; font-size:20px; cursor:pointer;">RETOURNER EN COURS</button>
    </div>

    <script>
        // --- 1. SYSTÈME AUDIO ---
        const AudioSys = {
            ctx: null,
            init: function() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            beep: function(freq, type) {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type || 'sine';
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.15);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.15);
            },
            playMusic: function(mood) {
                // Simulation simple d'ambiance (bruit de fond basse fréquence)
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = mood === 'pigalle' ? 'sawtooth' : 'triangle';
                osc.frequency.setValueAtTime(mood === 'pigalle' ? 50 : 100, this.ctx.currentTime);
                gain.gain.value = 0.02; // Très bas
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start();
                // Note: Dans un vrai jeu web, on utiliserait un fichier mp3, ici on garde tout en 1 fichier.
            }
        };

        // --- 2. SCÉNARIO (HUMOUR ESG) ---
        const messages = [
            { sender: 'Matthieu', text: "Il est où Samuel ? Le prof va faire l'appel." },
            { sender: 'Samuel', text: "LES GARS C'EST CHAUD." },
            { sender: 'Samuel', text: "La police me coursent." },
            { sender: 'Moi', text: "Mdr arrête tes mythos Sam, t'as encore bu ?" },
            { sender: 'Samuel', text: "Jure que non ! J'étais Place des Vosges, y'a eu une descente." },
            { sender: 'Julie', text: "Pff... Il a surement perdu sa carte étudiante et il ose pas venir." },
            { sender: 'Samuel', text: "J'ai paumé mes affaires en courant vers Pigalle." },
            { sender: 'Samuel', text: "Venez me chercher je suis perdu." },
            { sender: 'Moi', text: "Ok j'arrive. Bouge pas (pour une fois)." }
        ];

        // --- 3. JEU (MOTEUR 2D) ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const TILE = 40; // Taille d'une case
        
        let player = { x: 2, y: 2, color: '#fff' };
        let levelIndex = 0;
        let itemsFound = 0;
        let gameActive = false;
        let currentMap = [];
        let items = [];
        let exit = {};

        // COULEURS THEMATIQUES
        const THEMES = {
            vosges: { bg: '#2d6a4f', wall: '#b22222', ground: '#40916c', text: 'PLACE DES VOSGES' }, // Vert parc / Brique rouge
            pigalle: { bg: '#1a1a1a', wall: '#ff0055', ground: '#333333', text: 'PIGALLE (LA NUIT)' } // Noir / Néon Rose / Bitume
        };
        let currentTheme = THEMES.vosges;

        // CARTES (1 = Mur, 0 = Sol)
        // Niveau 1 : Place des Vosges (Carré d'herbe)
        const map1 = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,1,1,1,0,1,0,1,1,1,1,1,0,1,1,0,1],
            [1,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0,0,1],
            [1,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,1],
            [1,0,1,1,1,0,1,1,1,1,1,0,1,1,1,0,1,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,0,1,0,1,1,1,0,1,1,1,0,1,0,1,0,0,1],
            [1,0,1,0,1,0,0,0,0,0,0,0,0,0,1,0,1,0,0,1],
            [1,0,1,1,1,0,1,1,1,1,1,0,1,1,1,0,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], // Grand espace
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1] // 2 = Sortie
        ];

        // Niveau 2 : Pigalle (Rues étroites, néons) - PLUS DE BUG
        const map2 = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1], // Spawn large
            [1,0,1,1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,0,1],
            [1,0,1,0,0,0,0,0,0,0,1,0,1,0,1,0,0,0,0,1],
            [1,0,1,0,1,1,1,1,1,0,1,0,0,0,1,0,1,1,0,1], // Rues
            [1,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,1],
            [1,0,1,1,1,0,1,1,1,0,1,1,1,1,1,0,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], // Carrefour
            [1,1,1,0,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1],
            [1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,1,0,1,0,1,1,1,1,1,1,1,0,1,1,0,1],
            [1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,3,1], // 3 = Samuel
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        // Items "ESG" humoristiques
        const level1Items = [
            {x: 5, y: 4, label: "Carte Étudiante Perdue"},
            {x: 15, y: 2, label: "Kebab Sauce Algérienne"},
            {x: 10, y: 8, label: "Paquet de clopes vide"}
        ];
        
        const level2Items = [
            {x: 1, y: 11, label: "Ticket de métro"},
            {x: 17, y: 3, label: "Flyer soirée BDE"},
            {x: 8, y: 5, label: "Chaussure de Samuel"}
        ];

        // --- LOGIQUE JEU ---

        function initLevel(lvl) {
            levelIndex = lvl;
            itemsFound = 0;
            document.getElementById('score').innerText = "0";
            
            if (lvl === 0) {
                currentMap = map1;
                items = JSON.parse(JSON.stringify(level1Items)); // Copie profonde
                currentTheme = THEMES.vosges;
                player.x = 2; player.y = 2;
                exit = {x: 18, y: 13, type: 'exit'}; // Bas droite
            } else {
                currentMap = map2;
                items = JSON.parse(JSON.stringify(level2Items));
                currentTheme = THEMES.pigalle;
                player.x = 2; player.y = 1; // Spawn en haut gauche
                exit = {x: 18, y: 11, type: 'samuel'}; // Bas droite
            }

            document.getElementById('zone-name').innerText = currentTheme.text;
            AudioSys.playMusic(lvl === 0 ? 'vosges' : 'pigalle');
            draw();
        }

        function move(dx, dy) {
            const newX = player.x + dx;
            const newY = player.y + dy;

            // Collision Mur (1)
            if (currentMap[newY][newX] === 1) {
                // Son "Mur" sourd
                return; 
            }

            player.x = newX;
            player.y = newY;
            AudioSys.beep(100, 'triangle'); // Bruit de pas

            checkEvents();
            draw();
        }

        function checkEvents() {
            // Ramasser Item
            const itemIndex = items.findIndex(i => i.x === player.x && i.y === player.y);
            if (itemIndex !== -1) {
                itemsFound++;
                document.getElementById('score').innerText = itemsFound;
                showMessage("Trouvé : " + items[itemIndex].label);
                AudioSys.beep(600, 'sine'); // Ding!
                items.splice(itemIndex, 1);
            }

            // Sortie / Samuel
            if (player.x === exit.x && player.y === exit.y) {
                if (itemsFound < 3) {
                    showMessage("Il te manque des indices ! (" + itemsFound + "/3)");
                    player.x -= 1; // Repousse
                } else {
                    if (exit.type === 'exit') {
                        initLevel(1); // Go niveau 2
                    } else {
                        winGame();
                    }
                }
            }
        }

        function showMessage(txt) {
            const el = document.getElementById('message-area');
            el.innerText = txt;
            setTimeout(() => el.innerText = "", 3000);
        }

        function winGame() {
            gameActive = false;
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('end-screen').style.display = 'flex';
        }

        // --- RENDU GRAPHIQUE ---
        function draw() {
            // Fond
            ctx.fillStyle = currentTheme.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Dessin Map
            for (let y = 0; y < currentMap.length; y++) {
                for (let x = 0; x < currentMap[y].length; x++) {
                    const cell = currentMap[y][x];
                    const posX = x * TILE;
                    const posY = y * TILE;

                    if (cell === 1) {
                        ctx.fillStyle = currentTheme.wall;
                        ctx.fillRect(posX, posY, TILE, TILE);
                        // Effet brique ou néon
                        ctx.strokeStyle = "rgba(0,0,0,0.3)";
                        ctx.strokeRect(posX, posY, TILE, TILE);
                    } else {
                        ctx.fillStyle = currentTheme.ground;
                        ctx.fillRect(posX, posY, TILE, TILE);
                    }
                }
            }

            // Dessin Items
            items.forEach(item => {
                ctx.fillStyle = "#FFD700"; // Or
                ctx.beginPath();
                ctx.arc(item.x * TILE + TILE/2, item.y * TILE + TILE/2, 8, 0, Math.PI * 2);
                ctx.fill();
                // Petit point d'interrogation
                ctx.fillStyle = "black";
                ctx.font = "bold 12px Arial";
                ctx.fillText("?", item.x * TILE + 15, item.y * TILE + 24);
            });

            // Dessin Sortie / Samuel
            const exX = exit.x * TILE; 
            const exY = exit.y * TILE;
            if (exit.type === 'exit') {
                ctx.fillStyle = "#00ff00"; // Sortie verte
                ctx.fillRect(exX, exY, TILE, TILE);
                ctx.fillStyle = "black"; ctx.fillText("GO", exX+10, exY+25);
            } else {
                ctx.fillStyle = "#00ffff"; // Samuel Cyan
                ctx.beginPath();
                ctx.arc(exX + TILE/2, exY + TILE/2, 15, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = "black"; ctx.fillText("SAM", exX+8, exY+25);
            }

            // Dessin Joueur
            ctx.fillStyle = "#fff";
            ctx.fillRect(player.x * TILE + 5, player.y * TILE + 5, TILE - 10, TILE - 10);
            // Yeux
            ctx.fillStyle = "black";
            ctx.fillRect(player.x * TILE + 10, player.y * TILE + 10, 5, 5);
            ctx.fillRect(player.x * TILE + 25, player.y * TILE + 10, 5, 5);
        }

        // --- INPUTS ---
        window.addEventListener('keydown', (e) => {
            if (!gameActive) return;
            switch(e.key) {
                case "ArrowUp": move(0, -1); break;
                case "ArrowDown": move(0, 1); break;
                case "ArrowLeft": move(-1, 0); break;
                case "ArrowRight": move(1, 0); break;
            }
        });

        // --- GESTION INTRO ---
        let msgIdx = 0;
        const chatBody = document.getElementById('chat-body');
        
        function playChat() {
            if (msgIdx >= messages.length) {
                document.getElementById('btn-start').style.display = 'block';
                return;
            }
            const m = messages[msgIdx];
            const div = document.createElement('div');
            div.className = `msg ${m.sender === 'Moi' ? 'right' : 'left'}`;
            div.innerHTML = `<div class="name">${m.sender}</div>${m.text}`;
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
            AudioSys.beep(800, 'sine'); // Bip message
            
            msgIdx++;
            setTimeout(playChat, 1500);
        }

        window.onload = () => {
            setTimeout(playChat, 1000);
        };

        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('phone-container').style.display = 'none';
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('game-ui').style.display = 'block';
            
            gameActive = true;
            AudioSys.init();
            initLevel(0);
        });

    </script>
</body>
</html>
