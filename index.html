<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Samuel √† Paris ‚Äî Director's Cut</title>
    <style>
        /* ===========================
           üé® DESIGN SYSTEM NEO-PARIS
           =========================== */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');

        :root {
            --neo-cyan: #00F5FF;
            --neo-magenta: #FF006E;
            --neo-yellow: #FFBE0B;
            --dark-1: #0A0E27;
            --dark-2: #1A1F3A;
            --dark-3: #2E3856;
            --success: #39FF14;
            --danger: #FF003C;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body { 
            background: linear-gradient(135deg, #000000 0%, #0d1b2a 50%, #1b263b 100%);
            margin: 0; overflow: hidden; 
            font-family: 'Rajdhani', 'Courier New', monospace; 
            color: white; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; user-select: none; position: relative;
        }

        /* --- EFFETS VISUELS --- */
        .scanlines {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 999;
            background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.1) 1px, transparent 1px, transparent 2px);
        }
        
        body::before {
            content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at center, transparent 0%, rgba(0,0,0,0.8) 100%);
            pointer-events: none; z-index: 998;
        }

        /* --- ECRAN TITRE --- */
        #title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at center, #000 0%, #000428 100%);
            z-index: 300; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; transition: opacity 0.5s;
        }

        #title-main { 
            font-family: 'Orbitron', monospace; font-size: 90px; font-weight: 900; 
            background: linear-gradient(45deg, var(--neo-cyan), var(--neo-magenta), var(--neo-yellow));
            background-size: 200% 200%; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 245, 255, 0.5); letter-spacing: 5px; margin: 0;
            animation: title-anim 5s ease infinite;
        }
        @keyframes title-anim { 0%,100% { filter: hue-rotate(0deg); } 50% { filter: hue-rotate(30deg); } }

        #title-subtitle { font-size: 30px; color: var(--neo-magenta); letter-spacing: 8px; margin-bottom: 40px; }

        .menu-btn {
            padding: 20px 40px; font-family: 'Rajdhani', monospace; font-size: 22px; font-weight: 900;
            background: rgba(255, 255, 255, 0.05); border: 2px solid var(--neo-cyan); color: white;
            border-radius: 50px; cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            width: 350px; margin: 10px; transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.2);
        }
        .menu-btn:hover { background: var(--neo-cyan); color: #000; transform: scale(1.05); }
        .menu-btn.bonus { border-color: var(--neo-yellow); color: var(--neo-yellow); }
        .menu-btn.bonus:hover { background: var(--neo-yellow); color: #000; }

        /* --- GAME CONTAINER --- */
        #game-container { position: relative; display: none; }
        
        canvas { 
            background: #000; border: 4px solid var(--dark-3); border-radius: 15px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); image-rendering: pixelated;
        }

        /* --- HUD & POPUPS --- */
        #game-ui {
            position: absolute; top: 15px; left: 15px; background: rgba(10, 14, 39, 0.7); 
            backdrop-filter: blur(5px); padding: 10px 15px; border-radius: 10px; 
            border: 1px solid var(--neo-cyan); z-index: 10;
        }
        .ui-level { color: var(--neo-yellow); font-weight: 900; font-size: 14px; text-transform: uppercase; }
        .ui-score { font-size: 18px; font-weight: 700; color: #fff; }
        .ui-score span { color: var(--success); }

        #msg-popup { 
            margin-top: 5px; padding: 5px; background: rgba(255, 0, 60, 0.2); 
            border-left: 2px solid var(--danger); border-radius: 4px; color: var(--danger); 
            font-weight: 700; font-size: 12px; display: none;
        }

        #main-popup {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(10, 14, 39, 0.95); padding: 30px; border: 2px solid var(--neo-yellow);
            z-index: 100; display: none; text-align: center; border-radius: 15px; min-width: 300px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        #main-popup h3 { color: var(--neo-yellow); margin-top: 0; text-transform: uppercase; }
        #main-popup p { font-size: 16px; line-height: 1.4; color: #eee; }

        #tourist-popup {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            background: #fff; color: #000; padding: 8px 15px; border-radius: 15px;
            border: 2px solid #000; font-family: 'Courier New', monospace; font-weight: bold;
            display: none; z-index: 150; white-space: nowrap;
        }
        #tourist-popup::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            border-width: 8px 8px 0; border-style: solid; border-color: #000 transparent transparent transparent;
        }

        /* --- ECRAN FIN --- */
        #end-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10,14,39,0.95); z-index: 400; display: none; 
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        #end-screen h1 { color: var(--success); font-size: 50px; text-shadow: 0 0 20px var(--success); }
        #samuel-img { 
            width: 200px; height: 200px; object-fit: cover; border: 4px solid var(--success); 
            border-radius: 50%; margin: 20px; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .end-text { max-width: 500px; font-size: 18px; margin-bottom: 20px; line-height: 1.5; }

        @media (max-width: 800px) { canvas { width: 95vw; height: 95vw; } }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div id="youtube-audio" style="position:absolute; top:-9999px;"></div>

    <div id="title-screen">
        <div id="title-main">PARIS</div>
        <div id="title-subtitle">MISSION SAMUEL</div>
        <button class="menu-btn" onclick="selectMode('classic')">‚òï Classico (2 Niveaux)</button>
        <button class="menu-btn bonus" onclick="selectMode('bonus')">üçî Grosse Faim (4 Niveaux)</button>
    </div>

    <div id="game-container">
        <div id="game-ui">
            <div class="ui-level" id="level-name">NIVEAU 1</div>
            <div class="ui-score">Indices : <span id="score">0</span> / 3</div>
            <div id="msg-popup"></div>
        </div>
        <div id="main-popup"></div>
        <div id="tourist-popup"></div>
        <canvas id="gameCanvas" width="800" height="800"></canvas>
    </div>

    <div id="end-screen">
        <h1>‚ú® SAMUEL RETROUV√â ! ‚ú®</h1>
        <img id="samuel-img" src="samuel.jpg" alt="Samuel" onerror="this.style.display='none';">
        <div class="end-text"> 
            "Wesh l'√©quipe... J'avais plus de batterie.<br>
            C'√©tait pas la police, juste des pigeons qui m'attaquaient.<br>
            Merci d'√™tre venu me chercher !"
        </div>
        <button class="menu-btn" onclick="location.reload()">üîÑ REJOUER</button>
    </div>

    <script>
        // --- CONSTANTES ---
        const TILE = 40; 
        const GRID_SIZE = 20;
        const LERP_SPEED = 0.2;

        // --- VARIABLES GLOBALES ---
        let renderPlayer = { x: 0, y: 0 }; 
        let playerDir = { x: 0, y: 1 };
        let screenShake = 0;               
        let particles = [];                
        let gameMode = 'classic';
        let currentLevel = 1;
        let map = [];
        let items = [];
        let enemies = [];
        let playerPos = {x: 0, y: 0};
        let score = 0;
        let gameActive = false;
        let animTimer = 0;

        // --- AUDIO ENGINE ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        function initAudio() { if(!audioCtx) audioCtx = new AudioContext(); if(audioCtx.state === 'suspended') audioCtx.resume(); }
        const Sound = {
            step: () => playTone('triangle', 100, 50, 0.05, 0.05),
            collect: () => playTone('sine', 600, 1200, 0.1, 0.2),
            hurt: () => playTone('sawtooth', 150, 50, 0.1, 0.2),
            win: () => { 
                if(!audioCtx) return; 
                [440,554,659].forEach((f,i)=> setTimeout(()=>playTone('square', f, f, 0.1, 0.2), i*100)); 
            },
            tourist: () => playTone('triangle', 200, 150, 0.05, 0.1)
        };
        function playTone(type, fStart, fEnd, vol, dur) {
            if(!audioCtx) return;
            const o=audioCtx.createOscillator(), g=audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.type=type; 
            o.frequency.setValueAtTime(fStart, audioCtx.currentTime);
            o.frequency.linearRampToValueAtTime(fEnd, audioCtx.currentTime+dur);
            g.gain.setValueAtTime(vol, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+dur);
            o.start(); o.stop(audioCtx.currentTime+dur);
        }

        // --- YOUTUBE ---
        var player;
        var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0]; firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        function onYouTubeIframeAPIReady() { player = new YT.Player('youtube-audio', { height: '0', width: '0', videoId: 'Vol9dZ-t93s', playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1, 'playlist': 'Vol9dZ-t93s' } }); }

        // --- DATA ---
        const touristPhrases = ["Emily in Paris ?", "Where is la plage ?", "C'est beau mais sale.", "Baguette ?", "Photo please !"];

        const levels = {
            1: {
                name: "üå≥ PLACE DES VOSGES",
                colorWall: '#a52a2a', colorGround: '#27ae60', colorPath: '#ecf0f1',
                items: [{x:4,y:4,type:'card',name:'üí≥ Carte Bancaire'}, {x:15,y:4,type:'kebab',name:'ü•ô Kebab Sauce Blanche'}, {x:4,y:15,type:'cap',name:'üß¢ Casquette Mbapp√©'}],
                enemies: [{x:8,y:8,dx:1,type:'pigeon'}, {x:12,y:12,dx:-1,type:'pigeon'}, {x:10,y:10,dx:0,type:'tourist'}], 
                start: {x:10,y:18}, exit: {x:10,y:0}, exitName: "M√âTRO"
            },
            2: {
                name: "üåÉ PIGALLE (LA NUIT)",
                colorWall: '#2c2c2c', colorGround: '#1a1a1a', colorPath: '#333',
                items: [{x:3,y:3,type:'letter',name:"üíå Lettre d'amour"}, {x:16,y:3,type:'key',name:"üîë Cl√© d'Ang√®le"}, {x:16,y:16,type:'foodbag',name:"üõçÔ∏è Sac de courses"}],
                enemies: [{x:5,y:5,dx:1,type:'pigeon'}, {x:15,y:15,dx:-1,type:'pigeon'}, {x:5,y:15,dx:1,type:'pigeon'}, {x:10,y:10,dx:1,type:'tourist'}],
                start: {x:10,y:18}, exit: {x:10,y:9}, exitName: "SAMUEL"
            },
            3: {
                name: "‚öì QUAIS DE SEINE",
                colorWall: '#2980b9', colorGround: '#95a5a6', colorPath: '#bdc3c7',
                items: [{x:2,y:2,type:'bottle',name:"üíß Eau Min√©rale"}, {x:17,y:2,type:'lock',name:"üîí Cadenas d'Amour"}, {x:2,y:17,type:'crepe',name:"ü•û Cr√™pe Nutella"}],
                enemies: [{x:8,y:8,dx:1,type:'rat'}, {x:12,y:12,dx:-1,type:'rat'}, {x:6,y:14,dx:1,type:'rat'}, {x:10,y:5,dx:0,type:'tourist'}],
                start: {x:10,y:18}, exit: {x:18,y:10}, exitName: "PONT NEUF"
            },
            4: {
                name: "üöï RUE DE RIVOLI",
                colorWall: '#ecf0f1', colorGround: '#34495e', colorPath: '#2c3e50',
                items: [{x:9,y:9,type:'phone',name:"üì± Chargeur"}, {x:5,y:5,type:'shoe',name:"üëü Basket Gauche"}, {x:15,y:15,type:'ticket',name:"üé´ Ticket Resto"}],
                enemies: [{x:1,y:4,dx:1,type:'car'}, {x:18,y:8,dx:-1,type:'car'}, {x:1,y:12,dx:1,type:'car'}, {x:18,y:16,dx:-1,type:'car'}],
                start: {x:10,y:18}, exit: {x:10,y:1}, exitName: "MAISON"
            }
        };

        const ctx = document.getElementById('gameCanvas').getContext('2d');
        ctx.imageSmoothingEnabled = false;

        // --- FONCTIONS CL√âS ---
        function selectMode(mode) {
            gameMode = mode;
            document.getElementById('title-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('title-screen').style.display = 'none';
                initAudio();
                startGame();
            }, 500);
        }

        function startGame() {
            document.getElementById('game-container').style.display = 'block';
            if(player && player.playVideo) { player.unMute(); player.setVolume(50); player.playVideo(); }
            gameActive = true;
            loadLevel(1);
            gameLoop();
        }

        function loadLevel(lvlIdx) {
            currentLevel = lvlIdx;
            const data = levels[lvlIdx];
            map = [];
            // G√©n√©ration Map
            for(let y=0; y<GRID_SIZE; y++) {
                let row = [];
                for(let x=0; x<GRID_SIZE; x++) {
                    let type = 0;
                    if (x===0 || x===GRID_SIZE-1 || y===0 || y===GRID_SIZE-1) type = 1;
                    // Custom Maps
                    if (lvlIdx === 1) { if (x===10 && y===0) type=2; else if((x===2||x===17) && (y===2||y===17)) type=2; }
                    else if (lvlIdx === 2) { if (x===10 && y===9) type=0; else if (x===10 && y<9) type=1; }
                    else if (lvlIdx === 3) { if(y>4 && y<8) type=2; else if(x===10) type=2; }
                    else if (lvlIdx === 4) { if(y%4===0 && x>1 && x<18) type=2; else if(x===10) type=2; }
                    row.push(type);
                }
                map.push(row);
            }
            items = JSON.parse(JSON.stringify(data.items));
            enemies = JSON.parse(JSON.stringify(data.enemies));
            playerPos = {...data.start};
            renderPlayer = { x: playerPos.x*TILE, y: playerPos.y*TILE };
            score = 0;
            particles = [];
            
            // M√©t√©o
            if(lvlIdx === 1) for(let i=0; i<50; i++) particles.push(new Particle(Math.random()*800, Math.random()*800, 'pollen'));
            if(lvlIdx === 2 || lvlIdx === 3) for(let i=0; i<100; i++) particles.push(new Particle(Math.random()*800, Math.random()*800, 'rain'));

            document.getElementById('level-name').innerText = data.name;
            document.getElementById('score').innerText = '0';
            showMsg(data.name);
        }

        // --- VISUELS D√âTAILL√âS (SPRITES) ---
        function drawSprite(ctx, type, x, y) {
            const px = x * TILE; const py = y * TILE;
            let bounce = Math.sin(animTimer*2) * 2;

            if (type === 'card') {
                // Carte Bleue D√©taill√©e
                const grad = ctx.createLinearGradient(px+5, py+10, px+35, py+30);
                grad.addColorStop(0, '#2980b9'); grad.addColorStop(1, '#3498db');
                ctx.fillStyle = grad;
                ctx.shadowBlur = 10; ctx.shadowColor = '#3498db';
                ctx.fillRect(px+5, py+12, 30, 18);
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#f1c40f'; ctx.fillRect(px+8, py+16, 6, 5); // Puce
                ctx.fillStyle = '#000'; ctx.fillRect(px+5, py+14, 30, 3); // Bande
                ctx.fillStyle = 'rgba(255,255,255,0.4)'; ctx.font = '6px Arial'; ctx.fillText('####', px+15, py+26);
            } 
            else if (type === 'kebab') {
                // Kebab Sauce Blanche
                ctx.fillStyle = '#e67e22'; // Pain
                ctx.beginPath(); ctx.ellipse(px+20, py+20, 12, 14, 0.2, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.ellipse(px+18, py+12, 6, 8, 0, 0, Math.PI*2); ctx.fill(); // Sauce
                ctx.fillStyle = '#c0392b'; ctx.fillRect(px+20, py+20, 4, 4); // Tomate
                ctx.fillStyle = '#2ecc71'; ctx.fillRect(px+16, py+18, 5, 3); // Salade
            }
            else if (type === 'cap') {
                // Casquette PSG
                ctx.fillStyle = '#001f3f'; // Bleu nuit
                ctx.beginPath(); ctx.arc(px+20, py+20, 12, 0, Math.PI, true); ctx.fill();
                ctx.fillStyle = '#e74c3c'; ctx.fillRect(px+18, py+10, 4, 10); // Bande rouge
                ctx.fillStyle = '#fff'; ctx.fillRect(px+12, py+20, 16, 4); // Visi√®re
            }
            else if (type === 'letter') {
                // Lettre
                ctx.fillStyle = '#ecf0f1'; ctx.fillRect(px+8, py+12, 24, 16);
                ctx.strokeStyle = '#bdc3c7'; ctx.beginPath(); ctx.moveTo(px+8, py+12); ctx.lineTo(px+20, py+22); ctx.lineTo(px+32, py+12); ctx.stroke();
                ctx.fillStyle = '#e74c3c'; ctx.font = '14px Arial'; ctx.fillText('‚ù§Ô∏è', px+13, py+25);
            }
            else if (type === 'key') {
                // Cl√© Dor√©e
                ctx.shadowBlur = 10; ctx.shadowColor = '#f1c40f';
                ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.arc(px+20, py+15, 6, 0, Math.PI*2); ctx.fill();
                ctx.fillRect(px+18, py+20, 4, 12); ctx.fillRect(px+22, py+28, 4, 3);
                ctx.shadowBlur = 0;
            }
            else if (type === 'crepe') {
                // Cr√™pe (Nouveau)
                ctx.fillStyle = '#f39c12'; ctx.beginPath(); ctx.arc(px+20, py+20, 12, 0, Math.PI*2); ctx.fill(); // P√¢te
                ctx.fillStyle = '#3e2723'; ctx.beginPath(); ctx.arc(px+20, py+20, 6, 0, Math.PI*2); ctx.fill(); // Nutella
            }
            else if (type === 'lock') {
                // Cadenas (Nouveau)
                ctx.fillStyle = '#bdc3c7'; ctx.beginPath(); ctx.arc(px+20, py+15, 6, Math.PI, 0); ctx.stroke(); // Anse
                ctx.fillStyle = '#f1c40f'; ctx.fillRect(px+14, py+15, 12, 10); // Corps
            }
            else if (type === 'bottle') {
                ctx.fillStyle = '#3498db'; ctx.fillRect(px+16, py+12, 8, 20); ctx.fillStyle='#ecf0f1'; ctx.fillRect(px+16, py+18, 8, 6);
            }
            else if (type === 'phone') {
                ctx.fillStyle = '#000'; ctx.fillRect(px+14, py+12, 12, 22); ctx.fillStyle='#2ecc71'; ctx.fillRect(px+16, py+14, 8, 14); // Ecran
            }
            else if (type === 'shoe') {
                ctx.fillStyle = '#95a5a6'; ctx.beginPath(); ctx.ellipse(px+20, py+25, 10, 5, 0, 0, Math.PI*2); ctx.fill();
            }
            else if (type === 'ticket') {
                ctx.fillStyle = '#27ae60'; ctx.fillRect(px+12, py+15, 16, 10); ctx.fillStyle='#000'; ctx.fillRect(px+18, py+15, 4, 10); // Bande
            }
            else if (type === 'pigeon') {
                // Pigeon (D√©taill√©)
                ctx.shadowColor = 'rgba(0,0,0,0.3)'; ctx.shadowBlur = 5;
                ctx.fillStyle = '#7f8c8d'; ctx.beginPath(); ctx.arc(px+20, py+22+bounce, 10, 0, Math.PI*2); ctx.fill(); // Corps
                ctx.fillStyle = '#bdc3c7'; ctx.beginPath(); ctx.arc(px+20, py+15+bounce, 6, 0, Math.PI*2); ctx.fill(); // T√™te
                ctx.fillStyle = '#e67e22'; ctx.beginPath(); ctx.moveTo(px+24, py+15+bounce); ctx.lineTo(px+30, py+16+bounce); ctx.lineTo(px+24, py+18+bounce); ctx.fill(); // Bec
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(px+22, py+14+bounce, 1.5, 0, Math.PI*2); ctx.fill(); // Oeil
                ctx.fillStyle = '#555'; ctx.beginPath(); ctx.ellipse(px+14, py+22+bounce, 6, 3, -0.5, 0, Math.PI*2); ctx.fill(); // Aile
                ctx.shadowBlur = 0;
            }
            else if (type === 'rat') {
                // Rat (D√©taill√©)
                let run = Math.sin(animTimer*10)*2;
                ctx.fillStyle = '#5d4037'; ctx.beginPath(); ctx.ellipse(px+20, py+30, 12, 7, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#3e2723'; ctx.beginPath(); ctx.arc(px+30, py+32+run, 4, 0, Math.PI*2); ctx.fill(); // T√™te
                ctx.fillStyle = '#ffab91'; ctx.beginPath(); ctx.arc(px+30, py+29+run, 2.5, 0, Math.PI*2); ctx.fill(); // Oreille
                ctx.strokeStyle = '#ffab91'; ctx.beginPath(); ctx.moveTo(px+10, py+30); ctx.lineTo(px, py+28); ctx.stroke(); // Queue
            }
            else if (type === 'car') {
                // Voiture (D√©taill√©e)
                ctx.fillStyle = '#e74c3c'; ctx.fillRect(px+2, py+10, 36, 20);
                ctx.fillStyle = '#34495e'; ctx.fillRect(px+8, py+12, 6, 16); ctx.fillRect(px+26, py+12, 6, 16);
                ctx.shadowColor = '#f1c40f'; ctx.shadowBlur = 10;
                ctx.fillStyle = '#f1c40f'; ctx.fillRect(px+36, py+11, 4, 4); ctx.fillRect(px+36, py+25, 4, 4); // Phares
                ctx.shadowBlur = 0;
            }
            else if (type === 'tourist') {
                // Touriste
                ctx.fillStyle = '#bdc3c7'; ctx.fillRect(px+10, py+15, 20, 20); // Shirt
                ctx.fillStyle = '#e67e22'; ctx.fillRect(px+10, py+30, 20, 8); // Pantalon
                ctx.fillStyle = '#ffccaa'; ctx.beginPath(); ctx.arc(px+20, py+12, 8, 0, Math.PI*2); ctx.fill(); // T√™te
                ctx.fillStyle = '#2ecc71'; ctx.fillRect(px+8, py+5, 24, 5); ctx.fillRect(px+12, py+2, 16, 5); // Bob
                ctx.fillStyle = '#333'; ctx.fillRect(px+14, py+20, 12, 8); // Camera
            }
            // D√©cors
            else if (type === 'flower') {
                ctx.fillStyle = '#27ae60'; ctx.fillRect(px+19, py+25, 2, 10);
                ctx.fillStyle = (x+y)%2===0 ? '#e74c3c' : '#fff'; ctx.beginPath(); ctx.arc(px+20, py+22, 6, 0, Math.PI*2); ctx.fill();
            }
            else if (type === 'bench') {
                ctx.fillStyle = '#8e44ad'; ctx.fillRect(px+4, py+10, 32, 8); // Banc moderne
                ctx.fillStyle = '#555'; ctx.fillRect(px+4, py+18, 4, 10); ctx.fillRect(px+32, py+18, 4, 10);
            }
            else if (type === 'metroExit') {
                // Entr√©e M√©tro
                ctx.shadowColor = '#f1c40f'; ctx.shadowBlur = 20;
                ctx.strokeStyle = '#f1c40f'; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(px+20, py+10, 15, 0, Math.PI*2); ctx.stroke();
                ctx.fillStyle = '#2980b9'; ctx.font = 'bold 20px Arial'; ctx.fillText('M', px+12, py+17);
                ctx.shadowBlur = 0;
            }
        }

        function drawPlayer(ctx) {
            const bob = Math.sin(animTimer/2)*2;
            const px = renderPlayer.x; const py = renderPlayer.y;
            // Ombre
            ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.beginPath(); ctx.ellipse(px+20, py+36, 12, 5, 0, 0, Math.PI*2); ctx.fill();
            // Corps
            ctx.fillStyle = '#3498db'; ctx.fillRect(px+10, py+16+bob, 20, 18);
            // T√™te
            ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.arc(px+20, py+12+bob, 10, 0, Math.PI*2); ctx.fill();
            // Yeux (Regard)
            const ex = playerDir.x*3; const ey = playerDir.y*2;
            ctx.fillStyle = '#000'; ctx.fillRect(px+16+ex, py+10+ey+bob, 3, 3); ctx.fillRect(px+21+ex, py+10+ey+bob, 3, 3);
            // Sourire
            ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.beginPath(); ctx.arc(px+20+ex/2, py+14+bob, 4, 0.2*Math.PI, 0.8*Math.PI); ctx.stroke();
        }

        // --- GAME LOOP ---
        function gameLoop() {
            if(!gameActive) return;
            
            // Logique Ennemis
            if(Math.floor(animTimer)%12 === 0) {
                enemies.forEach(e => {
                    if(e.type === 'tourist') {
                        if(Math.random()<0.3) {
                            const moves=[{dx:0,dy:1},{dx:0,dy:-1},{dx:1,dy:0},{dx:-1,dy:0}];
                            const m=moves[Math.floor(Math.random()*4)];
                            if(map[e.y+m.dy]?.[e.x+m.dx] !== 1) { e.x+=m.dx; e.y+=m.dy; }
                        }
                    } else {
                        let nx = e.x+e.dx;
                        if(nx<0 || nx>=GRID_SIZE || map[e.y][nx]===1) e.dx *= -1; else e.x += e.dx;
                    }
                    if(e.x===playerPos.x && e.y===playerPos.y) hitPlayer(e.type);
                });
            }

            // Lerp Player
            renderPlayer.x += (playerPos.x*TILE - renderPlayer.x) * LERP_SPEED;
            renderPlayer.y += (playerPos.y*TILE - renderPlayer.y) * LERP_SPEED;

            // Dessin
            drawGame();
            animTimer += 0.2;
            requestAnimationFrame(gameLoop);
        }

        function hitPlayer(type) {
            screenShake = 20;
            if(type === 'tourist') {
                Sound.tourist();
                const p = touristPhrases[Math.floor(Math.random()*touristPhrases.length)];
                const el=document.getElementById('tourist-popup'); el.innerText=p; el.style.display='block';
                setTimeout(()=>el.style.display='none', 2000);
            } else {
                Sound.hurt();
                if(score>0) { score--; document.getElementById('score').innerText=score; showMsg("VOL√â !"); }
                else showMsg("A√èE !");
                // Recul
                if(map[playerPos.y][playerPos.x-playerDir.x] !== 1) playerPos.x -= playerDir.x;
            }
        }

        function movePlayer(dx, dy) {
            if(!gameActive) return;
            playerDir = {x:dx, y:dy};
            let nx = playerPos.x+dx; let ny = playerPos.y+dy;
            if(map[ny][nx]===1 && !(currentLevel===1 && nx===10 && ny===0)) return;
            
            playerPos.x = nx; playerPos.y = ny;
            Sound.step();

            // Items
            let idx = items.findIndex(i => i.x===nx && i.y===ny);
            if(idx !== -1) {
                const item = items[idx];
                score++; document.getElementById('score').innerText = score;
                Sound.collect();
                
                // --- DESCRIPTIONS DR√îLES (RESTAUR√âES !) ---
                let txt = "Indice trouv√© !";
                if(item.type==='kebab') txt = "Le Kebab refroidit...";
                if(item.type==='card') txt = "Encore paum√©e...";
                if(item.type==='cap') txt = "Ici c'est Paris !";
                if(item.type==='crepe') txt = "Miam, Nutella !";
                if(item.type==='lock') txt = "C'est lourd ce truc.";
                if(item.type==='ticket') txt = "8‚Ç¨ le ticket ?! Abus√©.";
                if(item.type==='bottle') txt = "L'eau de la Seine... bof.";
                
                showPopup(`<h3>${item.name}</h3><p>${txt}</p>`, 2000);
                items.splice(idx, 1);
                
                if(score===3) {
                    Sound.win();
                    setTimeout(()=>showPopup(`<h3>Mission Compl√®te !</h3><p>Go -> ${levels[currentLevel].exitName}</p>`, 3000), 1000);
                }
            }

            // Exit
            if(nx===levels[currentLevel].exit.x && ny===levels[currentLevel].exit.y) {
                if(score>=3) {
                    if(gameMode==='classic' && currentLevel===2) endGame();
                    else if(gameMode==='bonus' && currentLevel===4) endGame();
                    else loadLevel(currentLevel+1);
                } else {
                    showMsg("Il manque des objets !");
                    playerPos.x -= dx; playerPos.y -= dy; // Rebond
                }
            }
        }

        function drawGame() {
            let shakeX=0, shakeY=0;
            if(screenShake>0) { shakeX=(Math.random()-0.5)*screenShake; shakeY=(Math.random()-0.5)*screenShake; screenShake*=0.9; }
            
            ctx.save();
            ctx.translate(shakeX, shakeY);
            ctx.clearRect(0, 0, 800, 800);
            
            const conf = levels[currentLevel];

            for(let y=0; y<GRID_SIZE; y++) {
                for(let x=0; x<GRID_SIZE; x++) {
                    let t = map[y][x]; let px = x*TILE; let py = y*TILE;
                    if(t===1) { ctx.fillStyle=conf.colorWall; ctx.fillRect(px,py,TILE,TILE); ctx.strokeStyle='rgba(0,0,0,0.2)'; ctx.strokeRect(px,py,TILE,TILE); }
                    else if(t===2) { ctx.fillStyle=conf.colorPath; ctx.fillRect(px,py,TILE,TILE); }
                    else { ctx.fillStyle=conf.colorGround; ctx.fillRect(px,py,TILE,TILE); }
                    
                    // Decors Sol
                    if(t===0 && (x+y)%5===0 && currentLevel===1) drawSprite(ctx, 'flower', x, y);
                    if(t===0 && (x%4===0 && y%6===0) && currentLevel===1) drawSprite(ctx, 'bench', x, y);
                }
            }
            
            items.forEach(i => drawSprite(ctx, i.type, i.x, i.y));
            enemies.forEach(e => drawSprite(ctx, e.type, e.x, e.y));
            drawPlayer(ctx);
            drawSprite(ctx, 'metroExit', levels[currentLevel].exit.x, levels[currentLevel].exit.y);
            
            // Particules
            particles.forEach(p => { p.update(); p.draw(ctx); });
            
            // Lumi√®re Nuit
            if(currentLevel===2 || currentLevel===3) {
                const gx = renderPlayer.x+20; const gy = renderPlayer.y+20;
                const grad = ctx.createRadialGradient(gx, gy, 40, gx, gy, 350);
                grad.addColorStop(0, 'rgba(0,0,0,0)'); grad.addColorStop(1, 'rgba(0,0,0,0.95)');
                ctx.fillStyle = grad; ctx.fillRect(-50,-50, 900, 900);
            }
            ctx.restore();
        }

        class Particle {
            constructor(x, y, type) { this.x=x; this.y=y; this.type=type; this.life=1; this.vx=(Math.random()-0.5); this.vy=Math.random()*5+2; }
            update() { this.x+=this.vx; this.y+=this.vy; if(this.y>800) { this.y=-10; this.x=Math.random()*800; } }
            draw(ctx) { ctx.globalAlpha=0.5; ctx.fillStyle=this.type==='pollen'?'gold':'lightblue'; ctx.fillRect(this.x,this.y,2,this.type==='pollen'?2:10); ctx.globalAlpha=1; }
        }

        function showMsg(txt) { const el=document.getElementById('msg-popup'); el.innerText=txt; el.style.display='block'; setTimeout(()=>el.style.display='none', 2000); }
        function showPopup(html, dur) { const el=document.getElementById('main-popup'); el.innerHTML=html; el.style.display='block'; setTimeout(()=>el.style.display='none', dur); }
        function endGame() { gameActive=false; document.getElementById('game-container').style.display='none'; document.getElementById('end-screen').style.display='flex'; }

        // INPUTS
        window.addEventListener('keydown', e => {
            if(['ArrowUp','w'].includes(e.key)) movePlayer(0,-1);
            if(['ArrowDown','s'].includes(e.key)) movePlayer(0,1);
            if(['ArrowLeft','a'].includes(e.key)) movePlayer(-1,0);
            if(['ArrowRight','d'].includes(e.key)) movePlayer(1,0);
        });
        let tx=0, ty=0;
        document.addEventListener('touchstart', e=>{ tx=e.touches[0].clientX; ty=e.touches[0].clientY; }, {passive:true});
        document.addEventListener('touchend', e=>{
            let dx=e.changedTouches[0].clientX-tx; let dy=e.changedTouches[0].clientY-ty;
            if(Math.abs(dx)>Math.abs(dy)) movePlayer(dx>0?1:-1,0); else movePlayer(0,dy>0?1:-1);
        }, {passive:true});

    </script>
</body>
</html>
