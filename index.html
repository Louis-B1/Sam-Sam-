<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission: Samuel (Ultimate Fix)</title>
    <style>
        /* --- STYLE --- */
        body { 
            background-color: #050505; margin: 0; overflow: hidden; 
            font-family: 'Courier New', monospace; color: white; 
            display: flex; justify-content: center; align-items: center; height: 100vh;
            user-select: none;
        }
        .scanlines {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
        }

        /* --- TITLE --- */
        #title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 300; display: flex; flex-direction: column; justify-content: center; align-items: center;
            animation: fadeOut 1.5s ease-in-out 3s forwards; pointer-events: none;
        }
        #title-main { font-size: 80px; font-weight: bold; text-shadow: 6px 6px 0 #d43737; }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

        /* --- PHONE --- */
        #phone-container {
            position: absolute; width: 360px; height: 720px;
            background: #111; border: 12px solid #222; border-radius: 40px;
            display: flex; flex-direction: column; overflow: hidden;
            z-index: 200; box-shadow: 0 0 50px rgba(0,0,0,0.8);
            opacity: 0; animation: fadeIn 1s ease-out 3.5s forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        #chat-header { background: #202020; padding: 20px; text-align: center; border-bottom: 1px solid #333; font-weight: bold; }
        #chat-body { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: #000; overflow-y: auto; }
        .msg { max-width: 80%; padding: 12px; border-radius: 18px; font-size: 13px; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .left { background: #333; align-self: flex-start; color: #ddd; }
        .right { background: #007aff; align-self: flex-end; }
        .sender { font-size: 10px; color: #888; margin-bottom: 4px; display: block; font-weight: bold; text-transform: uppercase; }
        #btn-start { padding: 25px; background: #27ae60; text-align: center; cursor: pointer; font-weight: bold; font-size: 18px; display: none; border-top: 2px solid #2ecc71; }

        /* --- JEU --- */
        #game-container { position: relative; display: none; }
        canvas { background: #111; border: 8px solid #444; box-shadow: 0 0 60px rgba(0,0,0,1); image-rendering: pixelated; }
        
        #game-ui {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.9); padding: 15px; border-radius: 8px; border: 2px solid #fff;
            min-width: 250px; z-index: 10;
        }
        .ui-level { color: #f1c40f; font-weight: bold; font-size: 14px; margin-bottom: 5px; text-transform: uppercase; }
        .ui-score { font-size: 20px; font-weight: bold;}
        #msg-popup { margin-top: 10px; color: #e74c3c; font-weight: bold; height: 20px; font-size: 14px; }

        /* --- POPUPS --- */
        #main-popup {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); color: #fff; padding: 25px; border: 4px solid #f1c40f;
            z-index: 100; display: none; text-align: center; box-shadow: 0 0 30px #f1c40f;
            border-radius: 10px; min-width: 300px;
        }
        #main-popup h3 { margin-top: 0; color: #f1c40f; }
        #main-popup p { font-size: 16px; line-height: 1.4; color: #ddd; }

        #letter-popup {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #fff; color: #000; padding: 30px; border: 6px double #e74c3c;
            z-index: 101; display: none; text-align: center; box-shadow: 0 0 50px #e74c3c;
            border-radius: 5px; font-family: 'Courier New', cursive; min-width: 350px;
        }
        #letter-popup h3 { margin-top: 0; color: #e74c3c; font-size: 24px; text-decoration: underline; }
        #letter-popup p { font-size: 18px; font-weight: bold; font-style: italic; }

        /* --- CIN√âMATIQUE M√âTRO --- */
        #cinematic-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 500; display: none;
            color: #fff; flex-direction: column; justify-content: center; align-items: center;
        }
        .metro-lights {
            width: 100%; height: 20px;
            background: repeating-linear-gradient(90deg, #000, #000 50px, #fff 50px, #fff 55px);
            animation: moveLights 0.5s linear infinite; margin: 20px 0;
        }
        @keyframes moveLights { from { background-position: 0 0; } to { background-position: 110px 0; } }

        /* --- FIN --- */
        #end-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5,5,5,0.98); z-index: 400; display: none;
            flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        #samuel-img { width: 250px; height: 250px; object-fit: cover; border: 5px solid #27ae60; margin: 20px; background: #222; animation: pulseSam 2s infinite ease-in-out; }
        @keyframes pulseSam { 0% { transform: scale(1); box-shadow: 0 0 20px #27ae60; } 50% { transform: scale(1.05); box-shadow: 0 0 40px #2ecc71; } 100% { transform: scale(1); box-shadow: 0 0 20px #27ae60; } }
        .end-text-box { background:#222; padding:20px; border-radius:10px; max-width:600px; font-size:18px; line-height:1.5; animation: slideUpBox 0.8s ease-out 0.3s backwards; }
        @keyframes slideUpBox { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div id="youtube-audio" style="position:absolute; top:-9999px;"></div>

    <div id="cinematic-overlay">
        <div class="metro-lights"></div>
        <h2 style="letter-spacing: 5px;">DIRECTION : PIGALLE...</h2>
        <div class="metro-lights"></div>
    </div>

    <div id="title-screen">
        <div id="title-main">PARIS</div>
        <div style="font-size: 40px; color: #d43737; letter-spacing: 7px; margin-top: 10px;">BY NIGHT</div>
    </div>

    <div id="phone-container">
        <div id="chat-header">Les Chipies (4)</div>
        <div id="chat-body"></div>
        <div id="btn-start">SAUVER LE SOLDAT SAMUEL</div>
    </div>

    <div id="game-container">
        <div id="game-ui">
            <div class="ui-level" id="level-name">NIVEAU 1</div>
            <div class="ui-score">Indices : <span id="score" style="color:#2ecc71">0</span> / 3</div>
            <div id="msg-popup"></div>
        </div>
        <div id="main-popup"></div>
        <div id="letter-popup">
            <h3>üíå Lettre d'Alexis üíå</h3>
            <p>"Mon Sam ch√©ri, rejoins-moi vite. Le Kebab refroidit... Je t'attends. <3"</p>
        </div>
        <canvas id="gameCanvas" width="800" height="800"></canvas>
    </div>

    <div id="end-screen">
        <h1 style="color:#27ae60; text-shadow: 0 0 10px #27ae60;">SAMUEL RETROUV√â !</h1>
        <img id="samuel-img" src="samuel.jpg" alt="Samuel" onerror="this.style.display='none';">
        <div class="end-text-box"> 
            "Wesh l'√©quipe... J'ai plus de batterie.<br>
            Je dormais sur un banc.<br>
            C'√©tait pas la police, juste des pigeons qui m'attaquaient.<br>
            <b>Paris be like !</b>"
        </div>
        <br>
        <button onclick="location.reload()" style="padding:15px 30px; font-size:18px; cursor:pointer; background:#d43737; color:white; border:none; border-radius:5px;">REJOUER</button>
    </div>

    <script>
        const TILE = 40; 
        const GRID_SIZE = 20;
        
        // --- AUDIO ---
        var player;
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-audio', {
                height: '0', width: '0', videoId: 'Vol9dZ-t93s',
                playerVars: { 'autoplay': 0, 'controls': 0, 'loop': 1, 'playlist': 'Vol9dZ-t93s' }
            });
        }

        // --- DONNEES ---
        const chatMessages = [
            { s: 'Mathis', t: "Il est pass√© o√π Samuel ?" },
            { s: 'Samuel', t: "Oh les gars ! C‚Äôest Chaud l√† !" },
            { s: 'Samuel', t: "La police me coursent !!" },
            { s: 'In√®ss', t: "Mdr arr√™te Sam, t'as encore bu avoue ?" }, // Corrig√©
            { s: 'Samuel', t: "Non ! J'√©tais Place des Vosges, puis j'ai fui vers Pigalle." },
            { s: 'Lily', t: "Encore..." },
            { s: 'Samuel', t: "J'ai paum√© mes affaires. Attention aux pigeons, ils sont violents." },
            { s: 'Moi', t: "Ok j'arrive." }
        ];

        let currentLevel = 1;
        
        const levels = {
            1: {
                name: "PLACE DES VOSGES",
                colorWall: "#a52a2a", colorGround: "#27ae60", colorPath: "#ecf0f1",
                items: [
                    {x: 4, y: 4, type: "card", name: "Carte Bancaire"},
                    {x: 15, y: 4, type: "kebab", name: "Kebab Sauce Blanche"},
                    {x: 4, y: 15, type: "cap", name: "Casquette Mbapp√©"}
                ],
                enemies: [{x: 8, y: 8, dx: 1}, {x: 12, y: 12, dx: -1}], 
                start: {x: 10, y: 18},
                exit: {x: 10, y: 0}, exitName: "M√âTRO"
            },
            2: {
                name: "PIGALLE (LA NUIT)",
                colorWall: "#2c2c2c", colorGround: "#1a1a1a", colorPath: "#333",
                items: [
                    {x: 3, y: 3, type: "letter", name: "Lettre d'amour d'Alexis"},
                    {x: 16, y: 3, type: "key", name: "Cl√© d'Ang√®le"},
                    {x: 16, y: 16, type: "foodbag", name: "Sac de nourriture"}
                ],
                enemies: [{x: 5, y: 5, dx: 1}, {x: 15, y: 15, dx: -1}, {x: 5, y: 15, dx: 1}, {x: 10, y: 10, dx: 1}],
                start: {x: 10, y: 18},
                exit: {x: 10, y: 9}, exitName: "SAMUEL"
            }
        };

        let map = [];
        let items = [];
        let enemies = [];
        let playerPos = {x: 0, y: 0};
        let score = 0;
        let gameActive = false;
        let animTimer = 0;

        const ctx = document.getElementById('gameCanvas').getContext('2d');

        // --- DESSIN DES SPRITES ---
        function drawSprite(ctx, type, x, y) {
            const px = x * TILE; const py = y * TILE;
            
            if (type === 'card') {
                ctx.fillStyle = "#2980b9"; ctx.fillRect(px+8, py+10, 24, 16); ctx.fillStyle = "#f1c40f"; ctx.fillRect(px+10, py+14, 6, 5); ctx.fillStyle = "#000"; ctx.fillRect(px+8, py+12, 24, 2); 
            } 
            else if (type === 'kebab') {
                ctx.fillStyle = "#e67e22"; ctx.beginPath(); ctx.ellipse(px+20, py+20, 10, 14, 0.2, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "#ecf0f1"; ctx.fillRect(px+16, py+10, 8, 10); ctx.fillStyle = "#c0392b"; ctx.fillRect(px+18, py+20, 4, 4);
            }
            else if (type === 'cap') {
                ctx.fillStyle = "#000"; ctx.beginPath(); ctx.arc(px+20, py+18, 10, 0, Math.PI, true); ctx.fill(); ctx.fillStyle = "#e74c3c"; ctx.fillRect(px+18, py+18, 15, 4); ctx.fillStyle = "#fff"; ctx.font="8px Arial"; ctx.fillText("PSG", px+14, py+16);
            }
            else if (type === 'key') {
                ctx.fillStyle = "#f1c40f"; ctx.fillRect(px+15, py+10, 10, 10); ctx.fillRect(px+18, py+20, 4, 15); ctx.fillRect(px+22, py+30, 6, 4);
            }
            else if (type === 'foodbag') {
                 ctx.fillStyle = "#8e44ad"; ctx.fillRect(px+10, py+15, 20, 20); ctx.fillStyle = "#2ecc71"; ctx.fillRect(px+12, py+10, 5, 5); ctx.fillStyle = "#e74c3c"; ctx.fillRect(px+20, py+10, 5, 5); ctx.strokeStyle = "#6c3483"; ctx.strokeRect(px+10, py+15, 20, 20);
            }
            else if (type === 'letter') {
                ctx.fillStyle = "#fff"; ctx.fillRect(px+8, py+12, 24, 16); ctx.strokeStyle = "#e74c3c"; ctx.lineWidth = 1; ctx.strokeRect(px+8, py+12, 24, 16); ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.moveTo(px+15, py+20); ctx.lineTo(px+20, py+25); ctx.lineTo(px+25, py+20); ctx.fill();
            }
            else if (type === 'pigeon') {
                let bounce = Math.sin(animTimer) * 3;
                ctx.fillStyle = "#7f8c8d"; ctx.beginPath(); ctx.arc(px+20, py+20+bounce, 10, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "#bdc3c7"; ctx.beginPath(); ctx.arc(px+20, py+20+bounce, 6, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "#f39c12"; ctx.beginPath(); ctx.moveTo(px+28, py+18+bounce); ctx.lineTo(px+34, py+22+bounce); ctx.lineTo(px+28, py+24+bounce); ctx.fill(); ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(px+24, py+16+bounce, 3, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(px+25, py+16+bounce, 1, 0, Math.PI*2); ctx.fill();
            }
            else if (type === 'player') {
                ctx.fillStyle = "#3498db"; ctx.fillRect(px+10, py+12, 20, 16); ctx.fillStyle = "#f1c40f"; ctx.beginPath(); ctx.arc(px+20, py+14, 9, 0, Math.PI*2); ctx.fill();
            }
            else if (type === 'flower') {
                ctx.fillStyle = "#2ecc71"; ctx.fillRect(px+19, py+22, 2, 8); 
                ctx.fillStyle = (x+y)%2===0 ? "#e74c3c" : "#fff"; ctx.beginPath(); ctx.arc(px+20, py+20, 6, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "#f1c40f"; ctx.beginPath(); ctx.arc(px+20, py+20, 2, 0, Math.PI*2); ctx.fill();
            }
            else if (type === 'bench') {
                 ctx.fillStyle = "#8B4513"; ctx.fillRect(px+5, py+10, 30, 10); ctx.fillStyle = "#A0522D"; ctx.fillRect(px+5, py+12, 30, 2); ctx.fillRect(px+5, py+16, 30, 2);
            }
            else if (type === 'metroExit') {
                 ctx.fillStyle = "#2c3e50"; ctx.fillRect(px, py+15, TILE, TILE-15);
                 ctx.fillStyle = "#34495e"; for(let i=0; i<3; i++) ctx.fillRect(px, py+15 + i*6, TILE, 2);
                 ctx.fillStyle = "#7f8c8d"; ctx.fillRect(px+30, py, 5, 20);
                 ctx.fillStyle = "#f1c40f"; ctx.beginPath(); ctx.arc(px+32, py, 12, 0, Math.PI*2); ctx.fill();
                 ctx.strokeStyle = "#f39c12"; ctx.lineWidth=2; ctx.stroke();
                 ctx.fillStyle = "#2980b9"; ctx.font="bold 16px Arial"; ctx.textAlign = "center"; ctx.fillText("M", px+32, py+5); ctx.textAlign = "start"; 
            }
        }

        // --- G√âN√âRATION S√âCURIS√âE DES NIVEAUX ---
        function loadLevel(lvlIdx) {
            currentLevel = lvlIdx;
            const data = levels[lvlIdx];
            map = [];
            
            // 1. On remplit tout avec du sol (Safe par d√©faut)
            for(let y=0; y<GRID_SIZE; y++) {
                let row = [];
                for(let x=0; x<GRID_SIZE; x++) {
                    row.push(0); // 0 = Sol (Marchable)
                }
                map.push(row);
            }

            // 2. On dessine les murs et chemins selon le niveau
            for(let y=0; y<GRID_SIZE; y++) {
                for(let x=0; x<GRID_SIZE; x++) {
                    if (lvlIdx === 1) { // VOSGES
                        // Bords = Murs (Sauf sortie)
                        if ((x===0 || x===GRID_SIZE-1 || y===0 || y===GRID_SIZE-1) && !(x===10 && y===0)) map[y][x] = 1;
                        // Chemins
                        if (x===2 || x===GRID_SIZE-3 || y===2 || y===GRID_SIZE-3) map[y][x] = 2;
                        if (x===GRID_SIZE/2 || y===GRID_SIZE/2) map[y][x] = 2;
                        if (x===10 && y===0) map[y][x] = 2; // Force le chemin sous le m√©tro
                    } 
                    else if (lvlIdx === 2) { // PIGALLE
                        // Bords = Murs
                        if (x===0 || x===GRID_SIZE-1 || y===0 || y===GRID_SIZE-1) map[y][x] = 1;
                        // Trottoirs
                        if (x===2 || x===GRID_SIZE-3 || y===2 || y===GRID_SIZE-3 || x===GRID_SIZE/2 || y===GRID_SIZE/2) map[y][x] = 2;
                        // Le reste reste √† 0 (Rue)
                    }
                }
            }

            items = JSON.parse(JSON.stringify(data.items));
            enemies = JSON.parse(JSON.stringify(data.enemies));
            
            // Reset joueur en position s√ªre
            playerPos = {...data.start}; 
            
            score = 0;
            document.getElementById('level-name').innerText = data.name;
            document.getElementById('score').innerText = "0";
            if (lvlIdx === 2) showMsg("Sam est √† Pigalle ! C'est glauque ici...");
        }

        function startGame() {
            document.getElementById('phone-container').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            if(player && player.playVideo) { player.unMute(); player.setVolume(70); player.playVideo(); }
            gameActive = true;
            loadLevel(1);
            drawGame();
            gameLoop();
        }

        function gameLoop() {
            if(!gameActive) return;
            updateEnemies();
            drawGame();
            animTimer += 0.2;
            requestAnimationFrame(gameLoop);
        }

        function updateEnemies() {
            if (Math.floor(animTimer) % 10 !== 0) return;
            enemies.forEach(e => {
                let nextX = e.x + e.dx;
                // Verif simple mur
                if (nextX < 0 || nextX >= GRID_SIZE || map[e.y][nextX] === 1) e.dx *= -1; 
                else e.x += e.dx;

                if (e.x === playerPos.x && e.y === playerPos.y) {
                    if(score > 0) {
                        score--; document.getElementById('score').innerText = score;
                        showMsg("Le pigeon a vol√© un indice !");
                        const originalItems = levels[currentLevel].items;
                        const randomItem = originalItems[Math.floor(Math.random() * originalItems.length)];
                        // On ajoute l'objet vol√© √† une pos al√©atoire mais s√ªre (au centre)
                        items.push({x: 10, y: 10, type: randomItem.type, name: randomItem.name});
                    } else { showMsg("A√Øe ! Sale pigeon !"); }
                    
                    // Recul s√©curis√©
                    let backX = playerPos.x - e.dx * 2;
                    if(backX > 1 && backX < GRID_SIZE-1 && map[playerPos.y][backX] !== 1) playerPos.x = backX;
                }
            });
        }

        let popupTimeout;
        function showPopup(html, duration = 3000) {
            const popup = document.getElementById('main-popup');
            popup.innerHTML = html; popup.style.display = 'block';
            clearTimeout(popupTimeout);
            popupTimeout = setTimeout(() => { popup.style.display = 'none'; }, duration);
        }

        function showLoveLetter() {
            const popup = document.getElementById('letter-popup');
            popup.style.display = 'block';
            setTimeout(() => { popup.style.display = 'none'; }, 5000);
        }

        function playMetroCinematic(onComplete) {
            gameActive = false;
            document.getElementById('cinematic-overlay').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('cinematic-overlay').style.display = 'none';
                onComplete();
                gameActive = true; // IMPORTANT : On r√©active le jeu
                drawGame();
            }, 3000);
        }

        function movePlayer(dx, dy) {
            if(!gameActive) return;
            let nx = playerPos.x + dx; let ny = playerPos.y + dy;
            
            // Collision basique
            if(nx < 0 || nx >= GRID_SIZE || ny < 0 || ny >= GRID_SIZE) return;
            if(map[ny][nx] === 1) return; // Mur
            
            playerPos.x = nx; playerPos.y = ny;

            let idx = items.findIndex(i => i.x === nx && i.y === ny);
            if(idx !== -1) {
                score++;
                document.getElementById('score').innerText = score;
                const item = items[idx];
                
                if(item.type === 'letter') showLoveLetter();
                else {
                    let desc = "Indice trouv√© !";
                    if(item.type === 'card') desc = "La carte de Sam ! Il l'a encore paum√©e...";
                    if(item.type === 'kebab') desc = "Le d√Æner de Sam. Il y a un mot d'Alexis dessus.";
                    if(item.type === 'cap') desc = "Il ne sort jamais sans.";
                    if(item.type === 'key') desc = "Pourquoi il a les cl√©s d'Ang√®le ? Bizarre...";
                    if(item.type === 'foodbag') desc = "Il a fait des courses avant de s'endormir.";
                    let popupHtml = `<h3>${item.name}</h3><p>${desc}</p>`;
                    showPopup(popupHtml, 3500); 
                }
                items.splice(idx, 1);

                if(score === 3) {
                    setTimeout(() => {
                         const exitName = levels[currentLevel].exitName;
                         showPopup(`<h3>‚úÖ MISSION ACCOMPLIE ‚úÖ</h3><p>Fonce vers : <b>${exitName}</b> !</p>`, 4000);
                    }, 4000);
                }
            }

            const exit = levels[currentLevel].exit;
            if(nx === exit.x && ny === exit.y) {
                if(score >= 3) {
                    if(currentLevel === 1) {
                        playMetroCinematic(() => { loadLevel(2); });
                    } else {
                        endGame(); 
                    }
                } else {
                    showMsg("Il te manque des objets !");
                    playerPos.y += (currentLevel===1 ? 1 : -1); 
                }
            }
        }

        function showMsg(txt) {
            const el = document.getElementById('msg-popup'); el.innerText = txt;
            setTimeout(() => el.innerText = "", 2500);
        }
        function endGame() {
            gameActive = false; document.getElementById('game-container').style.display = 'none';
            document.getElementById('end-screen').style.display = 'flex';
        }

        function drawGame() {
            ctx.clearRect(0, 0, 800, 800);
            const conf = levels[currentLevel];

            for(let y=0; y<GRID_SIZE; y++) {
                for(let x=0; x<GRID_SIZE; x++) {
                    let t = map[y][x]; let px = x*TILE; let py = y*TILE;
                    
                    if(currentLevel === 1) {
                        // VOSGES STYLE
                        if (t===1) { ctx.fillStyle = conf.colorWall; ctx.fillRect(px,py,TILE,TILE); ctx.strokeStyle = "rgba(0,0,0,0.2)"; ctx.strokeRect(px,py,TILE,TILE); }
                        else if (t===2) { ctx.fillStyle = conf.colorPath; ctx.fillRect(px,py,TILE,TILE); }
                        else { 
                            ctx.fillStyle = conf.colorGround; ctx.fillRect(px,py,TILE,TILE); 
                            if((x+y)%9 === 0 && x%3 !== 0 && x>2 && x<17 && y>2 && y<17 && t===0) drawSprite(ctx, 'flower', x, y);
                            if((x === 3 || x === 16) && y%4 === 0 && y>2 && y<17) drawSprite(ctx, 'bench', x, y);
                        }
                    } else {
                        // PIGALLE STYLE
                        if (t===1) {
                            ctx.fillStyle = conf.colorWall; ctx.fillRect(px,py,TILE,TILE);
                            ctx.strokeStyle = "#111"; ctx.strokeRect(px,py,TILE,TILE);
                            // N√©ons fixes
                            if((x%3===0 || y%3===0)) {
                                 ctx.fillStyle = (x+y)%2===0 ? "#ff00cc" : "#00ccff"; 
                                 if(Math.sin(animTimer*2) > 0) ctx.fillRect(px+5, py+5, TILE-10, TILE-10);
                            }
                        } else if (t===2) {
                            ctx.fillStyle = conf.colorPath; ctx.fillRect(px,py,TILE,TILE); // Trottoir
                        } else {
                            ctx.fillStyle = "#1a1a1a"; ctx.fillRect(px,py,TILE,TILE); // Rue
                            ctx.strokeStyle = "#222"; ctx.strokeRect(px,py,TILE,TILE); 
                        }
                    }
                }
            }

            items.forEach(i => drawSprite(ctx, i.type, i.x, i.y));
            enemies.forEach(e => drawSprite(ctx, 'pigeon', e.x, e.y));
            drawSprite(ctx, 'player', playerPos.x, playerPos.y);

            const ex = levels[currentLevel].exit;
            if(currentLevel === 1) {
                drawSprite(ctx, 'metroExit', ex.x, ex.y);
            } else {
                ctx.fillStyle = "#e74c3c"; ctx.fillRect(ex.x*TILE+10, ex.y*TILE+10, 20, 20); ctx.fillStyle="white"; ctx.fillText("SAM", ex.x*TILE+8, ex.y*TILE+24);
            }
        }

        let msgIndex = 0;
        function playChat() {
            if (msgIndex >= chatMessages.length) { document.getElementById('btn-start').style.display = 'block'; return; }
            const m = chatMessages[msgIndex];
            const div = document.createElement('div'); div.className = `msg ${m.s === 'Moi' ? 'right' : 'left'}`;
            div.innerHTML = `<span class="sender">${m.s}</span>${m.t}`;
            document.getElementById('chat-body').appendChild(div); msgIndex++; setTimeout(playChat, 1200);
        }
        window.onload = () => { setTimeout(playChat, 4000); };
        document.getElementById('btn-start').addEventListener('click', startGame);
        window.addEventListener('keydown', e => {
            if(e.key.includes('Arrow')) { e.preventDefault(); 
                if(e.key==="ArrowUp") movePlayer(0,-1); if(e.key==="ArrowDown") movePlayer(0,1);
                if(e.key==="ArrowLeft") movePlayer(-1,0); if(e.key==="ArrowRight") movePlayer(1,0);
            }
        });
    </script>
</body>
</html>
