<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mission Samuel: Paris RPG HD (v5.0 REFACTORED)</title>
    <style>
        /* ===========================
           üé® DESIGN SYSTEM v5.0
           =========================== */
        :root {
            /* Palette N√©on */
            --neo-cyan: #00F5FF;
            --neo-magenta: #FF006E;
            --neo-yellow: #FFBE0B;
            --neo-purple: #8B5CF6;
            
            /* Surfaces */
            --dark-1: #0A0E27;
            --dark-2: #1A1F3A;
            --dark-3: #2E3856;
            
            /* Feedback */
            --success: #39FF14;
            --danger: #FF003C;
            --warning: #FFD60A;
            
            /* Glassmorphism */
            --glass-bg: rgba(26, 31, 58, 0.85);
            --glass-border: rgba(255, 255, 255, 0.18);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body { 
            background: linear-gradient(135deg, var(--dark-1) 0%, var(--dark-2) 100%);
            margin: 0; overflow: hidden; 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            color: white; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh;
            user-select: none;
        }

        /* Animations Globales */
        @keyframes glow-pulse {
            0%, 100% { filter: drop-shadow(0 0 5px currentColor); }
            50% { filter: drop-shadow(0 0 20px currentColor); }
        }

        @keyframes slide-in-up {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }

        /* Cadre Principal */
        #game-wrapper {
            position: relative;
            box-shadow: 
                0 0 60px rgba(0, 245, 255, 0.4),
                0 0 120px rgba(255, 0, 110, 0.2);
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid var(--neo-cyan);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #game-wrapper:hover {
            transform: scale(1.02);
        }

        canvas { 
            background: #000; 
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        /* --- HUD GLASSMORPHISM --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
        }

        .hud-top {
            display: flex; 
            justify-content: space-between; 
            padding: 20px;
            animation: slide-in-up 0.6s ease-out;
        }

        .hud-badge {
            background: var(--glass-bg);
            border: 2px solid var(--glass-border);
            padding: 12px 24px;
            border-radius: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .hud-badge::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .hud-badge:hover::before {
            left: 100%;
        }

        .label { 
            font-size: 9px; 
            color: rgba(255,255,255,0.6); 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            display: block; 
            margin-bottom: 4px;
            font-weight: 600;
        }

        .value { 
            font-size: 20px; 
            font-weight: 900; 
            color: var(--neo-cyan);
            text-shadow: 0 0 10px currentColor;
            animation: glow-pulse 2s infinite;
        }

        .value.gold { color: var(--neo-yellow); }
        .value.danger { color: var(--danger); }

        /* --- PARTICLES CONTAINER --- */
        #particles-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        .particle {
            position: absolute;
            width: 4px; height: 4px;
            border-radius: 50%;
            pointer-events: none;
            animation: particle-float 1s ease-out forwards;
        }

        @keyframes particle-float {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
        }

        /* --- MODAL AM√âLIOR√â --- */
        #modal-overlay {
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%;
            background: rgba(10, 14, 39, 0.95);
            display: none; 
            justify-content: center; 
            align-items: center;
            z-index: 100; 
            pointer-events: auto;
            backdrop-filter: blur(8px);
            animation: fade-in 0.3s ease;
        }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-box {
            background: linear-gradient(135deg, var(--dark-2), var(--dark-3));
            border: 3px solid var(--neo-cyan);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            box-shadow: 
                0 0 40px rgba(0, 245, 255, 0.5),
                inset 0 0 60px rgba(0, 0, 0, 0.5);
            animation: modal-pop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            overflow: hidden;
        }

        @keyframes modal-pop {
            0% { transform: scale(0.5) rotate(-5deg); opacity: 0; }
            50% { transform: scale(1.05) rotate(2deg); }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }

        .modal-box::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: conic-gradient(
                transparent, 
                var(--neo-cyan), 
                transparent 30%
            );
            animation: rotate 4s linear infinite;
        }

        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }

        .modal-box::after {
            content: '';
            position: absolute;
            inset: 3px;
            background: var(--dark-2);
            border-radius: 17px;
            z-index: 1;
        }

        .modal-content {
            position: relative;
            z-index: 2;
        }

        .modal-title { 
            color: var(--neo-cyan); 
            margin: 0 0 15px 0; 
            text-transform: uppercase; 
            font-weight: 900;
            font-size: 28px;
            letter-spacing: 2px;
            text-shadow: 0 0 20px currentColor;
        }

        .modal-text { 
            color: #e0e0e0; 
            font-size: 16px; 
            line-height: 1.6; 
            margin-bottom: 25px;
            font-weight: 300;
        }
        
        button {
            background: linear-gradient(135deg, var(--neo-cyan), var(--neo-purple));
            color: #fff; 
            border: none;
            padding: 14px 32px; 
            font-weight: 900; 
            border-radius: 30px;
            cursor: pointer; 
            font-size: 16px; 
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 245, 255, 0.4);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 25px rgba(0, 245, 255, 0.6);
        }

        button:active {
            transform: translateY(0);
        }

        /* --- FLOATING MESSAGES --- */
        #floating-msg {
            position: absolute; 
            bottom: 100px; 
            width: 100%; 
            text-align: center;
            font-size: 24px; 
            font-weight: 900; 
            color: #fff;
            text-shadow: 
                0 0 10px currentColor,
                0 2px 10px rgba(0,0,0,0.8);
            pointer-events: none; 
            opacity: 0; 
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        #floating-msg.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- PHONE INTRO --- */
        #phone-intro {
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #000000, #1a1a2e);
            z-index: 200; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            animation: fade-in 0.5s ease;
        }

        .chat-box {
            width: 340px; 
            height: 500px; 
            background: var(--dark-2);
            border-radius: 30px;
            padding: 20px; 
            overflow-y: auto; 
            border: 3px solid var(--neo-cyan);
            box-shadow: 0 10px 50px rgba(0, 245, 255, 0.3);
            display: flex; 
            flex-direction: column; 
            gap: 12px;
        }

        .chat-box::-webkit-scrollbar { width: 6px; }
        .chat-box::-webkit-scrollbar-track { background: var(--dark-1); border-radius: 10px; }
        .chat-box::-webkit-scrollbar-thumb { background: var(--neo-cyan); border-radius: 10px; }

        .msg { 
            padding: 12px 16px; 
            border-radius: 18px; 
            font-size: 14px; 
            max-width: 80%;
            animation: slide-in-up 0.4s ease;
            line-height: 1.4;
        }

        .msg.left { 
            background: linear-gradient(135deg, var(--dark-3), var(--dark-2));
            align-self: flex-start;
            border: 1px solid var(--glass-border);
        }

        .msg.right { 
            background: linear-gradient(135deg, var(--neo-cyan), var(--neo-purple));
            align-self: flex-end;
            color: #fff;
            font-weight: 600;
        }

        /* --- COMBOS & SCORE POPUP --- */
        .score-popup {
            position: absolute;
            font-size: 32px;
            font-weight: 900;
            color: var(--neo-yellow);
            text-shadow: 0 0 20px currentColor;
            pointer-events: none;
            animation: score-fly 1s ease-out forwards;
        }

        @keyframes score-fly {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.5); opacity: 0; }
        }

        /* --- HEALTH BAR --- */
        #health-bar-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 30px;
            background: var(--dark-3);
            border-radius: 15px;
            border: 2px solid var(--glass-border);
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        #health-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--danger), var(--warning), var(--success));
            transition: width 0.3s ease;
            box-shadow: inset 0 0 10px rgba(255,255,255,0.5);
        }

        /* Responsive */
        @media (max-width: 850px) {
            #game-wrapper { 
                width: 100vw !important; 
                height: 100vh !important; 
                border-radius: 0;
            }
            canvas { 
                width: 100% !important; 
                height: 100% !important; 
            }
        }

    </style>
</head>
<body>

    <div id="game-wrapper">
        <canvas id="gameCanvas" width="800" height="800"></canvas>
        
        <!-- PARTICLES -->
        <div id="particles-layer"></div>

        <!-- UI -->
        <div id="ui-layer">
            <div class="hud-top">
                <div class="hud-badge">
                    <span class="label">üó∫Ô∏è LIEU</span>
                    <span class="value" id="ui-location">VOSGES</span>
                </div>
                <div class="hud-badge">
                    <span class="label">üîç INDICES</span>
                    <span class="value gold" id="ui-score">0/3</span>
                </div>
                <div class="hud-badge">
                    <span class="label">üí´ COMBO</span>
                    <span class="value" id="ui-combo">x0</span>
                </div>
            </div>

            <!-- Health Bar -->
            <div id="health-bar-container">
                <div id="health-bar" style="width: 100%;"></div>
            </div>

            <div id="floating-msg"></div>
        </div>

        <!-- MODAL -->
        <div id="modal-overlay">
            <div class="modal-box">
                <div class="modal-content">
                    <h2 class="modal-title" id="modal-h2">TITRE</h2>
                    <div class="modal-text" id="modal-p">Contenu</div>
                    <button id="modal-btn">CONTINUER</button>
                </div>
            </div>
        </div>

        <!-- INTRO -->
        <div id="phone-intro">
            <div class="chat-box" id="chat-list"></div>
            <button id="start-btn" style="margin-top: 20px; display:none;">üöÄ PARTIR EN MISSION</button>
        </div>
    </div>

    <!-- AUDIO (HTML5 au lieu de Youtube) -->
    <audio id="bg-music" loop>
        <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" type="audio/wav">
    </audio>

    <script>
        // ===========================
        // üéÆ GAME ENGINE v5.0
        // ===========================

        const CONFIG = {
            TILE_SIZE: 40,
            GRID_SIZE: 20,
            CANVAS_SIZE: 800,
            MAX_HEALTH: 100,
            PLAYER_SPEED: 1,
            ENEMY_SPEED: 10, // Frames entre mouvements
            PARTICLE_COUNT: 12,
            SCREENSHAKE_DURATION: 200,
            FREEZE_FRAME_DURATION: 80
        };

        // ===========================
        // üèóÔ∏è ARCHITECTURE (ECS-like)
        // ===========================

        class Game {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.ctx.imageSmoothingEnabled = false;
                
                this.state = {
                    isPlaying: false,
                    isPaused: false,
                    frame: 0,
                    level: 1,
                    score: 0,
                    combo: 0,
                    health: CONFIG.MAX_HEALTH,
                    shake: { x: 0, y: 0, duration: 0 },
                    freezeFrame: 0
                };

                this.entities = {
                    player: null,
                    items: [],
                    enemies: []
                };

                this.map = [];
                this.textures = {};
                this.sounds = new SoundManager();
                
                this.initTextures();
                this.bindInputs();
            }

            initTextures() {
                const createCanvas = (w, h, drawFn) => {
                    const c = document.createElement('canvas');
                    c.width = w; c.height = h;
                    const cx = c.getContext('2d');
                    drawFn(cx);
                    return c;
                };

                const T = CONFIG.TILE_SIZE;

                // HERBE AM√âLIOR√âE
                this.textures.grass = createCanvas(T, T, (c) => {
                    const grad = c.createRadialGradient(T/2, T/2, 0, T/2, T/2, T/2);
                    grad.addColorStop(0, '#2d5a2d');
                    grad.addColorStop(1, '#1a3a1a');
                    c.fillStyle = grad;
                    c.fillRect(0, 0, T, T);
                    
                    // Brins
                    for(let i=0; i<20; i++) {
                        c.fillStyle = `rgba(45, 90, 45, ${Math.random()})`;
                        c.fillRect(Math.random()*T, Math.random()*T, 1, 3);
                    }
                });

                // PAV√âS AVEC NORMALE MAP SIMUL√âE
                this.textures.cobble = createCanvas(T, T, (c) => {
                    c.fillStyle = '#4a4a4a';
                    c.fillRect(0, 0, T, T);
                    
                    // Pierres
                    for(let i=0; i<3; i++) {
                        const x = (i % 2) * 20 + 5;
                        const y = Math.floor(i/2) * 20 + 5;
                        const rad = c.createRadialGradient(x, y, 2, x, y, 10);
                        rad.addColorStop(0, '#6a6a6a');
                        rad.addColorStop(1, '#3a3a3a');
                        c.fillStyle = rad;
                        c.beginPath();
                        c.arc(x, y, 8, 0, Math.PI*2);
                        c.fill();
                    }
                    
                    // Joints
                    c.strokeStyle = '#222';
                    c.lineWidth = 2;
                    c.strokeRect(0, 0, T, T);
                });

                // BRIQUES AVEC OMBRES PORT√âES
                this.textures.brick = createCanvas(T, T, (c) => {
                    c.fillStyle = '#6d2626';
                    c.fillRect(0, 0, T, T);
                    
                    const bricks = [
                        [2,2,16,8], [20,2,18,8],
                        [0,12,8,8], [10,12,18,8], [30,12,10,8],
                        [2,22,16,8], [20,22,18,8]
                    ];
                    
                    bricks.forEach(([x,y,w,h]) => {
                        // Highlight
                        c.fillStyle = '#8a3333';
                        c.fillRect(x, y, w, h);
                        // Shadow
                        c.fillStyle = 'rgba(0,0,0,0.4)';
                        c.fillRect(x, y+h-2, w, 2);
                    });
                });

                // BITUME AVEC GRUNGE
                this.textures.asphalt = createCanvas(T, T, (c) => {
                    c.fillStyle = '#1a1a1a';
                    c.fillRect(0, 0, T, T);
                    
                    const imageData = c.getImageData(0, 0, T, T);
                    for(let i=0; i<imageData.data.length; i+=4) {
                        const noise = Math.random() * 30;
                        imageData.data[i] += noise;
                        imageData.data[i+1] += noise;
                        imageData.data[i+2] += noise;
                    }
                    c.putImageData(imageData, 0, 0);
                });

                // TROTTOIR MODERNE
                this.textures.sidewalk = createCanvas(T, T, (c) => {
                    c.fillStyle = '#666';
                    c.fillRect(0, 0, T, T);
                    c.strokeStyle = '#444';
                    c.lineWidth = 2;
                    c.strokeRect(2, 2, T-4, T-4);
                    
                    // Effet 3D
                    c.fillStyle = 'rgba(255,255,255,0.1)';
                    c.fillRect(2, 2, T-4, 2);
                });
            }

            loadLevel(lvl) {
                this.state.level = lvl;
                this.state.score = 0;
                this.state.combo = 0;
                this.state.health = CONFIG.MAX_HEALTH;
                
                const data = LEVELS[lvl];
                
                // UI Update
                document.getElementById('ui-location').innerText = data.name;
                this.updateUI();

                // Generate Map
                this.map = this.generateMap(lvl);
                
                // Create Entities
                this.entities.player = new Player(data.start.x, data.start.y);
                this.entities.items = data.items.map(i => new Item(i.x, i.y, i.icon, i.name, i.desc));
                this.entities.enemies = data.enemies.map(e => new Enemy(e.x, e.y, e.dx));
            }

            generateMap(lvl) {
                const G = CONFIG.GRID_SIZE;
                const map = Array(G).fill(0).map(() => Array(G).fill(0));
                
                if(lvl === 1) {
                    // PLACE DES VOSGES
                    for(let y=0; y<G; y++) {
                        for(let x=0; x<G; x++) {
                            // Bordures
                            if(x===0 || x===G-1 || y===0 || y===G-1) map[y][x] = 1;
                            // Jardin central
                            else if(x>3 && x<16 && y>3 && y<16) map[y][x] = 0;
                            // All√©es
                            else map[y][x] = 2;
                            
                            // All√©es crois√©es
                            if((x===9||x===10) && y>1 && y<18) map[y][x] = 2;
                            if((y===9||y===10) && x>1 && x<18) map[y][x] = 2;
                            
                            // Fontaine
                            if(x>=9 && x<=10 && y>=9 && y<=10) map[y][x] = 1;
                            
                            // Entr√©es
                            if(x===10 && (y===0 || y===1 || y===18 || y===19)) map[y][x] = 2;
                            
                            // Obstacles d√©coratifs
                            if((x===4&&y===4) || (x===15&&y===4) || (x===4&&y===15) || (x===15&&y===15)) map[y][x] = 1;
                        }
                    }
                } else if(lvl === 2) {
                    // PIGALLE
                    for(let y=0; y<G; y++) {
                        for(let x=0; x<G; x++) {
                            map[y][x] = 0; // Bitume par d√©faut
                            
                            // Trottoirs
                            if(x<4 || x>15) map[y][x] = 2;
                            
                            // Immeubles
                            if(x<3 || x>16) map[y][x] = 1;
                            
                            // Blocs centraux (bars)
                            if(x>5 && x<9 && y>5 && y<14) map[y][x] = 1;
                            if(x>10 && x<14 && y>5 && y<14) map[y][x] = 1;
                            
                            // Limites
                            if(y===0 || y===G-1) map[y][x] = 1;
                            
                            // Sortie
                            if(x===10 && y<3) map[y][x] = 0;
                        }
                    }
                }
                
                return map;
            }

            update() {
                if(!this.state.isPlaying || this.state.isPaused) return;
                
                // Freeze Frame
                if(this.state.freezeFrame > 0) {
                    this.state.freezeFrame--;
                    return;
                }
                
                this.state.frame++;
                
                // Update Entities
                if(this.state.frame % CONFIG.ENEMY_SPEED === 0) {
                    this.entities.enemies.forEach(e => this.updateEnemy(e));
                }
                
                // Screen Shake Decay
                if(this.state.shake.duration > 0) {
                    this.state.shake.duration--;
                    this.state.shake.x = (Math.random() - 0.5) * 10;
                    this.state.shake.y = (Math.random() - 0.5) * 10;
                } else {
                    this.state.shake.x = 0;
                    this.state.shake.y = 0;
                }
                
                // Combo Decay
                if(this.state.frame % 180 === 0 && this.state.combo > 0) {
                    this.state.combo = Math.max(0, this.state.combo - 1);
                    this.updateUI();
                }
            }

            updateEnemy(enemy) {
                const nx = enemy.x + enemy.dx;
                
                // Wall collision
                if(nx <= 0 || nx >= CONFIG.GRID_SIZE-1 || this.map[enemy.y][nx] === 1) {
                    enemy.dx *= -1;
                } else {
                    enemy.x = nx;
                }
                
                // Player collision
                const p = this.entities.player;
                if(enemy.x === p.x && enemy.y === p.y) {
                    this.onPlayerHit();
                }
            }

            onPlayerHit() {
                this.state.health = Math.max(0, this.state.health - 20);
                this.state.combo = 0;
                this.updateUI();
                
                this.sounds.play('hit');
                this.screenShake();
                this.freezeFrame();
                this.spawnParticles(this.entities.player.x, this.entities.player.y, '#FF003C');
                this.showFloatMsg("üê¶ PIGEON ATTACK!", "#FF003C");
                
                // Push back
                const p = this.entities.player;
                if(this.map[p.y+1] && this.map[p.y+1][p.x] !== 1) p.y++;
                
                if(this.state.health <= 0) {
                    this.gameOver();
                }
            }

            movePlayer(dx, dy) {
                if(!this.state.isPlaying || this.state.isPaused) return;
                
                const p = this.entities.player;
                
                // Direction
                if(dy === -1) p.dir = 1;
                if(dy === 1) p.dir = 0;
                if(dx === -1) p.dir = 2;
                if(dx === 1) p.dir = 3;
                
                const nx = p.x + dx;
                const ny = p.y + dy;
                
                // Bounds & Wall check
                if(ny < 0 || ny >= CONFIG.GRID_SIZE || nx < 0 || nx >= CONFIG.GRID_SIZE) return;
                if(this.map[ny][nx] === 1) return;
                
                p.x = nx;
                p.y = ny;
                
                this.sounds.play('step');
                
                // Item collision
                const itemIdx = this.entities.items.findIndex(i => i.x === nx && i.y === ny);
                if(itemIdx !== -1) {
                    this.collectItem(itemIdx);
                }
                
                // Exit check
                const exit = LEVELS[this.state.level].exit;
                if(nx === exit.x && ny === exit.y) {
                    this.checkExit();
                }
            }

            collectItem(idx) {
                const item = this.entities.items[idx];
                this.entities.items.splice(idx, 1);
                
                this.state.score++;
                this.state.combo++;
                this.updateUI();
                
                this.sounds.play('collect');
                this.spawnParticles(item.x, item.y, '#FFBE0B');
                this.showScorePopup(item.x, item.y, `+${this.state.combo}x`);
                this.showModal(item.icon + " " + item.name, item.desc);
                
                if(this.state.score >= 3) {
                    this.showFloatMsg("‚úÖ SORTIE D√âVERROUILL√âE!", "#39FF14");
                }
            }

            checkExit() {
                if(this.state.score >= 3) {
                    if(this.state.level === 1) {
                        this.showModal("üéØ NIVEAU TERMIN√â", "Direction Pigalle ! Je prends le m√©tro.");
                        document.getElementById('modal-btn').onclick = () => {
                            this.hideModal();
                            this.loadLevel(2);
                        };
                    } else {
                        this.winGame();
                    }
                } else {
                    this.showFloatMsg("‚ùå Il manque des indices!", "#FFD60A");
                    this.entities.player.y++;
                }
            }

            draw() {
                const c = this.ctx;
                const T = CONFIG.TILE_SIZE;
                const G = CONFIG.GRID_SIZE;
                
                // Apply shake
                c.save();
                c.translate(this.state.shake.x, this.state.shake.y);
                
                // Clear
                c.fillStyle = '#000';
                c.fillRect(0, 0, CONFIG.CANVAS_SIZE, CONFIG.CANVAS_SIZE);
                
                // Draw Map
                for(let y=0; y<G; y++) {
                    for(let x=0; x<G; x++) {
                        const type = this.map[y][x];
                        const px = x * T;
                        const py = y * T;
                        
                        if(type === 1) {
                            this.drawWall(px, py);
                        } else if(type === 2) {
                            c.drawImage(
                                this.state.level === 2 ? this.textures.sidewalk : this.textures.cobble,
                                px, py
                            );
                        } else {
                            c.drawImage(
                                this.state.level === 2 ? this.textures.asphalt : this.textures.grass,
                                px, py
                            );
                        }
                        
                        // Fountain
                        if(this.state.level === 1 && x === 10 && y === 10) {
                            this.drawFountain(px, py);
                        }
                    }
                }
                
                // Draw Entities
                this.entities.items.forEach(i => this.drawItem(i));
                this.entities.enemies.forEach(e => this.drawEnemy(e));
                this.drawPlayer(this.entities.player);
                
                // Draw Exit
                const exit = LEVELS[this.state.level].exit;
                c.save();
                c.font = "bold 28px 'Inter'";
                c.textAlign = "center";
                c.fillStyle = this.state.score >= 3 ? '#00F5FF' : '#555';
                c.shadowBlur = this.state.score >= 3 ? 20 : 0;
                c.shadowColor = '#00F5FF';
                c.fillText("EXIT", exit.x*T + T/2, exit.y*T + T/2 + 8);
                c.restore();
                
                // Lighting/Vignette
                this.drawLighting();
                
                c.restore();
                
                requestAnimationFrame(() => {
                    this.update();
                    this.draw();
                });
            }

            drawWall(x, y) {
                const c = this.ctx;
                const T = CONFIG.TILE_SIZE;
                
                if(this.state.level === 2) {
                    // Pigalle: Dark walls with neon
                    c.fillStyle = '#1a0d1a';
                    c.fillRect(x, y, T, T);
                    
                    // Windows
                    if(Math.random() > 0.7) {
                        c.fillStyle = '#ffaa00';
                        c.shadowBlur = 10;
                        c.shadowColor = '#ffaa00';
                        c.fillRect(x+10, y+10, 20, 20);
                        c.shadowBlur = 0;
                    }
                } else {
                    c.drawImage(this.textures.brick, x, y);
                    // Shadow
                    c.fillStyle = 'rgba(0,0,0,0.3)';
                    c.fillRect(x, y+35, T, 5);
                }
            }

            drawFountain(x, y) {
                const c = this.ctx;
                const T = CONFIG.TILE_SIZE;
                const pulse = Math.sin(this.state.frame / 10) * 2;
                
                // Water
                c.fillStyle = 'rgba(0, 188, 212, 0.7)';
                c.shadowBlur = 15;
                c.shadowColor = '#00bcd4';
                c.beginPath();
                c.arc(x + T/2, y + T/2, 18 + pulse, 0, Math.PI*2);
                c.fill();
                c.shadowBlur = 0;
                
                // Jet
                if(this.state.frame % 20 < 10) {
                    c.fillStyle = '#fff';
                    c.fillRect(x + T/2 - 2, y + 10, 4, 20);
                }
            }

            drawItem(item) {
                const c = this.ctx;
                const T = CONFIG.TILE_SIZE;
                const px = item.x * T + T/2;
                const py = item.y * T + T/2;
                const pulse = Math.sin(this.state.frame / 10) * 5;
                const float = Math.sin(this.state.frame / 15) * 3;
                
                c.save();
                c.shadowBlur = 20 + pulse;
                c.shadowColor = '#FFBE0B';
                c.font = "28px Arial";
                c.textAlign = "center";
                c.textBaseline = "middle";
                c.fillText(item.icon, px, py + float);
                c.restore();
            }

            drawEnemy(enemy) {
                const c = this.ctx;
                const T = CONFIG.TILE_SIZE;
                const cx = enemy.x * T + T/2;
                const cy = enemy.y * T + T/2 + Math.sin(this.state.frame / 5) * 2;
                
                // Shadow
                c.fillStyle = 'rgba(0,0,0,0.5)';
                c.beginPath();
                c.ellipse(cx, cy + 15, 12, 6, 0, 0, Math.PI*2);
                c.fill();
                
                // Body
                c.fillStyle = '#78909c';
                c.beginPath();
                c.ellipse(cx, cy, 12, 8, 0, 0, Math.PI*2);
                c.fill();
                
                // Wing
                c.fillStyle = '#b0bec5';
                c.beginPath();
                c.ellipse(cx-2, cy-2, 8, 4, 0.5, 0, Math.PI*2);
                c.fill();
                
                // Head
                const hx = cx + (enemy.dx > 0 ? 8 : -8);
                const hy = cy - 6;
                c.fillStyle = '#546e7a';
                c.beginPath();
                c.arc(hx, hy, 5, 0, Math.PI*2);
                c.fill();
                
                // Beak
                c.fillStyle = '#ff9800';
                c.beginPath();
                c.moveTo(hx, hy);
                c.lineTo(hx + (enemy.dx > 0 ? 8 : -8), hy + 2);
                c.lineTo(hx, hy + 4);
                c.fill();
                
                // Eye (evil red)
                c.fillStyle = '#FF003C';
                c.shadowBlur = 5;
                c.shadowColor = '#FF003C';
                c.beginPath();
                c.arc(hx + (enemy.dx > 0 ? 2 : -2), hy - 2, 2, 0, Math.PI*2);
                c.fill();
                c.shadowBlur = 0;
            }

            drawPlayer(player) {
                const c = this.ctx;
                const T = CONFIG.TILE_SIZE;
                const cx = player.x * T + T/2;
                const cy = player.y * T + T/2;
                const bob = Math.sin(this.state.frame / 10) * 2;
                
                // Shadow
                c.fillStyle = 'rgba(0,0,0,0.5)';
                c.beginPath();
                c.ellipse(cx, cy + 15, 12, 6, 0, 0, Math.PI*2);
                c.fill();
                
                // Body
                c.fillStyle = '#3498db';
                c.fillRect(cx - 10, cy - 10 + bob, 20, 20);
                
                // Head
                c.fillStyle = '#ffccaa';
                c.beginPath();
                c.arc(cx, cy - 12 + bob, 10, 0, Math.PI*2);
                c.fill();
                
                // Cap
                c.fillStyle = '#222';
                c.beginPath();
                c.arc(cx, cy - 14 + bob, 10, 0, Math.PI, true);
                c.fill();
                
                // Eyes (direction based)
                c.fillStyle = '#000';
                const eyeOffsetX = player.dir === 2 ? -3 : player.dir === 3 ? 3 : 0;
                c.fillRect(cx - 3 + eyeOffsetX, cy - 13 + bob, 2, 2);
                c.fillRect(cx + 1 + eyeOffsetX, cy - 13 + bob, 2, 2);
            }

            drawLighting() {
                const c = this.ctx;
                const S = CONFIG.CANVAS_SIZE;
                
                // Vignette
                const grad = c.createRadialGradient(S/2, S/2, S*0.3, S/2, S/2, S*0.7);
                grad.addColorStop(0, 'rgba(0,0,0,0)');
                grad.addColorStop(1, 'rgba(0,0,0,0.7)');
                c.fillStyle = grad;
                c.fillRect(0, 0, S, S);
                
                // Night filter for Pigalle
                if(this.state.level === 2) {
                    c.fillStyle = 'rgba(20, 0, 50, 0.4)';
                    c.fillRect(0, 0, S, S);
                }
            }

            // --- EFFECTS ---
            screenShake() {
                this.state.shake.duration = CONFIG.SCREENSHAKE_DURATION / 16; // frames
            }

            freezeFrame() {
                this.state.freezeFrame = CONFIG.FREEZE_FRAME_DURATION / 16;
            }

            spawnParticles(gridX, gridY, color) {
                const container = document.getElementById('particles-layer');
                const T = CONFIG.TILE_SIZE;
                const px = gridX * T + T/2;
                const py = gridY * T + T/2;
                
                for(let i=0; i<CONFIG.PARTICLE_COUNT; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    p.style.left = px + 'px';
                    p.style.top = py + 'px';
                    p.style.backgroundColor = color;
                    
                    const angle = (Math.PI * 2 * i) / CONFIG.PARTICLE_COUNT;
                    const dist = 30 + Math.random() * 20;
                    const tx = Math.cos(angle) * dist;
                    const ty = Math.sin(angle) * dist;
                    
                    p.style.setProperty('--tx', tx + 'px');
                    p.style.setProperty('--ty', ty + 'px');
                    
                    container.appendChild(p);
                    
                    setTimeout(() => p.remove(), 1000);
                }
            }

            showScorePopup(gridX, gridY, text) {
                const T = CONFIG.TILE_SIZE;
                const px = gridX * T + T/2;
                const py = gridY * T;
                
                const popup = document.createElement('div');
                popup.className = 'score-popup';
                popup.innerText = text;
                popup.style.left = px + 'px';
                popup.style.top = py + 'px';
                
                document.getElementById('particles-layer').appendChild(popup);
                setTimeout(() => popup.remove(), 1000);
            }

            // --- UI ---
            updateUI() {
                document.getElementById('ui-score').innerText = `${this.state.score}/3`;
                document.getElementById('ui-combo').innerText = `x${this.state.combo}`;
                document.getElementById('health-bar').style.width = this.state.health + '%';
                
                const comboEl = document.getElementById('ui-combo');
                comboEl.parentElement.style.display = this.state.combo > 0 ? 'block' : 'none';
            }

            showModal(title, text) {
                const prevState = this.state.isPlaying;
                this.state.isPaused = true;
                
                const m = document.getElementById('modal-overlay');
                document.getElementById('modal-h2').innerText = title;
                document.getElementById('modal-p').innerText = text;
                m.style.display = 'flex';
                
                document.getElementById('modal-btn').onclick = () => {
                    this.hideModal();
                    this.state.isPaused = false;
                };
            }

            hideModal() {
                document.getElementById('modal-overlay').style.display = 'none';
            }

            showFloatMsg(text, color) {
                const el = document.getElementById('floating-msg');
                el.innerText = text;
                el.style.color = color;
                el.classList.add('show');
                
                setTimeout(() => el.classList.remove('show'), 2000);
            }

            // --- GAME STATES ---
            gameOver() {
                this.state.isPlaying = false;
                this.showModal(
                    "üíÄ GAME OVER",
                    "Les pigeons ont gagn√©... Samuel est toujours perdu."
                );
                document.getElementById('modal-btn').innerText = "R√âESSAYER";
                document.getElementById('modal-btn').onclick = () => {
                    location.reload();
                };
            }

            winGame() {
                this.state.isPlaying = false;
                document.getElementById('phone-intro').style.display = 'flex';
                const chat = document.getElementById('chat-list');
                chat.innerHTML = `
                    <div class="msg left" style="background: linear-gradient(135deg, var(--neo-cyan), var(--neo-purple)); color:#fff; font-size:18px; text-align:center; padding:30px;">
                        üéâ <b>SAMUEL RETROUV√â!</b><br><br>
                        "Wesh merci! J'avais plus de batterie."<br>
                        "Ces pigeons sont fous ici."<br><br>
                        <small>Score Final: ${this.state.score}/6</small><br>
                        <small>Combo Max: x${this.state.combo}</small>
                    </div>
                `;
                
                const btn = document.createElement('button');
                btn.innerText = 'üîÑ REJOUER';
                btn.style.marginTop = '20px';
                btn.onclick = () => location.reload();
                chat.appendChild(btn);
                
                document.getElementById('start-btn').style.display = 'none';
            }

            // --- INPUT ---
            bindInputs() {
                window.addEventListener('keydown', (e) => {
                    if(!this.state.isPlaying || this.state.isPaused) return;
                    
                    const moves = {
                        'ArrowUp': [0, -1],
                        'ArrowDown': [0, 1],
                        'ArrowLeft': [-1, 0],
                        'ArrowRight': [1, 0],
                        'w': [0, -1],
                        's': [0, 1],
                        'a': [-1, 0],
                        'd': [1, 0]
                    };
                    
                    if(moves[e.key]) {
                        e.preventDefault();
                        this.movePlayer(...moves[e.key]);
                    }
                });
                
                // Touch
                let tx = 0, ty = 0;
                this.canvas.addEventListener('touchstart', (e) => {
                    tx = e.touches[0].clientX;
                    ty = e.touches[0].clientY;
                }, {passive: true});
                
                this.canvas.addEventListener('touchend', (e) => {
                    if(!this.state.isPlaying || this.state.isPaused) return;
                    
                    const dx = e.changedTouches[0].clientX - tx;
                    const dy = e.changedTouches[0].clientY - ty;
                    
                    if(Math.abs(dx) > Math.abs(dy)) {
                        this.movePlayer(dx > 0 ? 1 : -1, 0);
                    } else {
                        this.movePlayer(0, dy > 0 ? 1 : -1);
                    }
                }, {passive: true});
            }

            // --- CHAT INTRO ---
            startChat() {
                const msgs = [
                    {t: "T'es o√π Sam??", side: 'right'},
                    {t: "J'suis perdu √† Paris...", side: 'left'},
                    {t: "Y'a des pigeons chelous Place des Vosges.", side: 'left'},
                    {t: "J'ai paum√© ma CB et mon Kebab.", side: 'left'},
                    {t: "Bouge pas, j'arrive.", side: 'right'}
                ];
                
                const container = document.getElementById('chat-list');
                const btn = document.getElementById('start-btn');
                let i = 0;
                
                const next = () => {
                    if(i >= msgs.length) {
                        btn.style.display = 'block';
                        btn.onclick = () => {
                            document.getElementById('phone-intro').style.display = 'none';
                            this.loadLevel(1);
                            this.state.isPlaying = true;
                            this.sounds.playMusic();
                            this.draw();
                        };
                        return;
                    }
                    
                    const m = msgs[i];
                    const d = document.createElement('div');
                    d.className = `msg ${m.side}`;
                    d.innerText = m.t;
                    container.appendChild(d);
                    container.scrollTop = container.scrollHeight;
                    
                    this.sounds.play('message');
                    i++;
                    setTimeout(next, 800);
                };
                
                setTimeout(next, 500);
            }
        }

        // ===========================
        // üéµ SOUND MANAGER
        // ===========================
        class SoundManager {
            constructor() {
                this.sounds = {};
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.initSounds();
            }

            initSounds() {
                // Synth√©tiser des sons simples
                this.sounds.step = this.createTone(200, 0.05, 'sine');
                this.sounds.collect = this.createTone(600, 0.2, 'square');
                this.sounds.hit = this.createTone(100, 0.3, 'sawtooth');
                this.sounds.message = this.createTone(400, 0.1, 'sine');
            }

            createTone(freq, duration, type) {
                return () => {
                    const osc = this.audioContext.createOscillator();
                    const gain = this.audioContext.createGain();
                    
                    osc.type = type;
                    osc.frequency.value = freq;
                    
                    gain.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    osc.connect(gain);
                    gain.connect(this.audioContext.destination);
                    
                    osc.start();
                    osc.stop(this.audioContext.currentTime + duration);
                };
            }

            play(name) {
                if(this.sounds[name]) this.sounds[name]();
            }

            playMusic() {
                // Musique d'ambiance (loop simple)
                const music = document.getElementById('bg-music');
                music.volume = 0.3;
                music.play().catch(() => {}); // Ignore autoplay policy
            }
        }

        // ===========================
        // üì¶ ENTITIES
        // ===========================
        class Player {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.dir = 1; // 0=bas, 1=haut, 2=gauche, 3=droite
            }
        }

        class Item {
            constructor(x, y, icon, name, desc) {
                this.x = x;
                this.y = y;
                this.icon = icon;
                this.name = name;
                this.desc = desc;
            }
        }

        class Enemy {
            constructor(x, y, dx) {
                this.x = x;
                this.y = y;
                this.dx = dx;
            }
        }

        // ===========================
        // üó∫Ô∏è LEVEL DATA
        // ===========================
        const LEVELS = {
            1: {
                name: "PLACE DES VOSGES",
                items: [
                    {x: 4, y: 5, icon: 'üí≥', name: "Carte Bancaire", desc: "La Gold de Sam. Il l'a laiss√©e sur un banc."},
                    {x: 15, y: 4, icon: 'ü•ô', name: "Kebab Froid", desc: "Sauce Blanche, Salade, Tomate, Oignon."},
                    {x: 5, y: 15, icon: 'üß¢', name: "Casquette", desc: "Il ne sort jamais sans."}
                ],
                enemies: [
                    {x:6, y:6, dx:1}, 
                    {x:13, y:13, dx:-1}, 
                    {x:6, y:13, dx:1}, 
                    {x:12, y:5, dx:-1}
                ],
                start: {x: 10, y: 18},
                exit: {x: 10, y: 1}
            },
            2: {
                name: "PIGALLE BY NIGHT",
                items: [
                    {x: 2, y: 4, icon: 'üíå', name: "Lettre d'Amour", desc: "Pour Alexis... C'est mignon."},
                    {x: 17, y: 4, icon: 'üîë', name: "Cl√© Myst√®re", desc: "Ouvre une porte rue de Douai."},
                    {x: 10, y: 10, icon: 'üõçÔ∏è', name: "Sac de Courses", desc: "Des p√¢tes et du pesto."}
                ],
                enemies: [
                    {x:5, y:8, dx:1}, 
                    {x:14, y:8, dx:-1}, 
                    {x:5, y:12, dx:1}, 
                    {x:14, y:12, dx:-1}, 
                    {x:10, y:5, dx:0}
                ],
                start: {x: 10, y: 18},
                exit: {x: 10, y: 2}
            }
        };

        // ===========================
        // üöÄ BOOTSTRAP
        // ===========================
        let game;
        window.onload = () => {
            game = new Game();
            game.startChat();
        };

    </script>
</body>
</html>
