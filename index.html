<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Samuel ‚Äî Paris By Night</title>
    <style>
        /* ===========================
           üé® DESIGN SYSTEM NEO-PARIS
           =========================== */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');

        :root {
            --neo-cyan: #00F5FF;
            --neo-magenta: #FF006E;
            --neo-yellow: #FFBE0B;
            --neo-purple: #8B5CF6;
            --dark-1: #0A0E27;
            --dark-2: #1A1F3A;
            --dark-3: #2E3856;
            --success: #39FF14;
            --danger: #FF003C;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body { 
            background: linear-gradient(270deg, #0A0E27, #1A1F3A, #2E3856, #1A1F3A);
            background-size: 400% 400%;
            animation: bg-shift 20s ease infinite;
            margin: 0; overflow: hidden; 
            font-family: 'Rajdhani', 'Courier New', monospace; 
            color: white; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh;
            user-select: none;
            position: relative;
        }

        @keyframes bg-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- SCANLINES + VIGNETTE --- */
        .scanlines {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%; 
            pointer-events: none; z-index: 999;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            animation: scanline-anim 8s linear infinite;
        }

        @keyframes scanline-anim {
            0% { transform: translateY(0); }
            100% { transform: translateY(10px); }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at center, transparent 0%, rgba(0,0,0,0.7) 100%);
            pointer-events: none;
            z-index: 998;
        }

        /* --- TITLE SCREEN --- */
        #title-screen {
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #000000, #1a1f3a);
            z-index: 300; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            animation: titleFadeOut 1.5s ease-in-out 2s forwards;
            pointer-events: none;
        }

        #title-main { 
            font-family: 'Orbitron', monospace;
            font-size: 90px; 
            font-weight: 900; 
            background: linear-gradient(45deg, var(--neo-cyan), var(--neo-magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 60px var(--neo-cyan);
            animation: titlePulse 2s ease-in-out infinite;
            text-align: center;
            line-height: 1;
        }

        #title-subtitle {
            font-family: 'Orbitron', monospace;
            font-size: 60px;
            font-weight: 700;
            color: var(--neo-yellow);
            text-shadow: 0 0 40px var(--neo-yellow);
            margin-top: 15px;
            text-align: center;
        }

        @keyframes titlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes titleFadeOut { 
            to { opacity: 0; visibility: hidden; } 
        }

        /* --- PHONE CONTAINER --- */
        #phone-container {
            position: absolute; 
            width: 380px; 
            height: 750px;
            background: linear-gradient(135deg, #1a1f3a, #2e3856);
            border: 14px solid #0a0e27;
            border-radius: 45px;
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            z-index: 200; 
            box-shadow: 
                0 0 80px rgba(0, 245, 255, 0.6),
                0 0 120px rgba(255, 0, 110, 0.4),
                inset 0 0 60px rgba(0, 0, 0, 0.8);
            opacity: 0; 
            animation: phoneFadeIn 1s ease-out 2s forwards;
        }

        @keyframes phoneFadeIn { 
            to { opacity: 1; } 
        }

        #phone-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 30px;
            background: #000;
            border-radius: 0 0 20px 20px;
            z-index: 10;
        }

        #chat-header { 
            background: linear-gradient(135deg, var(--dark-2), var(--dark-3));
            padding: 45px 20px 20px 20px; 
            text-align: center; 
            border-bottom: 2px solid var(--neo-cyan);
            font-weight: 700;
            font-size: 18px;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--neo-cyan);
            position: relative;
            flex-shrink: 0;
        }

        #chat-header::after {
            content: '‚óè';
            position: absolute;
            top: 50px;
            right: 20px;
            color: var(--success);
            font-size: 14px;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        #chat-body { 
            flex: 1; 
            padding: 20px 20px 120px 20px;
            display: flex; 
            flex-direction: column; 
            gap: 14px; 
            background: var(--dark-1);
            overflow-y: auto; 
            overflow-x: hidden;
        }

        #chat-body::-webkit-scrollbar { width: 6px; }
        #chat-body::-webkit-scrollbar-track { background: var(--dark-2); }
        #chat-body::-webkit-scrollbar-thumb { 
            background: var(--neo-cyan); 
            border-radius: 10px; 
        }

        .msg { 
            max-width: 75%; 
            padding: 14px 18px; 
            border-radius: 20px; 
            font-size: 14px; 
            line-height: 1.5;
            animation: msgSlideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            color: white; 
        }

        @keyframes msgSlideUp { 
            from { transform: translateY(20px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }

        .left { 
            background: linear-gradient(135deg, #2e3856, #3c4865);
            align-self: flex-start; 
            color: #e0e0e0; 
            border-bottom-left-radius: 4px;
        }

        .right { 
            background: linear-gradient(135deg, #007aff, #0051d5);
            align-self: flex-end; 
            color: white;
            border-bottom-right-radius: 4px;
        }

        .sender { 
            font-size: 11px; 
            color: var(--neo-yellow); 
            margin-bottom: 6px; 
            display: block; 
            font-weight: 700; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #btn-start {
            background: linear-gradient(135deg, var(--success), #2ecc71);
            color: #000;
            padding: 20px;
            text-align: center;
            font-weight: 900;
            font-size: 16px;
            cursor: pointer;
            display: none;
            border-radius: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 -4px 20px rgba(57, 255, 20, 0.4);
            transition: all 0.3s ease;
            position: absolute;
            bottom: 0;
            width: 100%;
            z-index: 20;
        }

        #btn-start:hover {
            background: linear-gradient(135deg, #2ecc71, var(--success));
            transform: translateY(-2px);
            box-shadow: 0 -6px 30px rgba(57, 255, 20, 0.6);
        }

        /* --- GAME CONTAINER --- */
        #game-container {
            display: none;
            position: relative;
            animation: game-enter 0.8s ease-out;
        }

        @keyframes game-enter {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        canvas { 
            background: #000;
            border: 6px solid var(--dark-3);
            border-radius: 20px;
            box-shadow: 
                0 0 60px rgba(0, 245, 255, 0.5),
                0 0 100px rgba(255, 0, 110, 0.3),
                inset 0 0 100px rgba(0, 0, 0, 0.8);
            image-rendering: pixelated;
        }

        /* --- HUD --- */
        #game-ui {
            position: absolute; 
            top: 20px; 
            right: 20px;
            background: rgba(10, 14, 39, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 25px;
            border-radius: 20px;
            border: 2px solid var(--neo-cyan);
            min-width: 240px;
            z-index: 10;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            animation: hud-slide-in 0.6s ease-out;
        }

        @keyframes hud-slide-in {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .ui-level {
            font-size: 16px;
            font-weight: 700;
            color: var(--neo-yellow);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            text-shadow: 0 0 10px var(--neo-yellow);
        }

        .ui-score {
            font-size: 20px;
            font-weight: 900;
            color: var(--success);
            text-shadow: 0 0 15px var(--success);
        }

        .ui-score span {
            font-size: 32px;
            animation: scorePulse 0.5s ease;
        }

        @keyframes scorePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); color: var(--neo-yellow); }
        }

        #msg-popup { 
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 0, 60, 0.2);
            border-left: 3px solid var(--danger);
            border-radius: 8px;
            color: var(--danger);
            font-weight: 700;
            min-height: 20px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: msg-flash 0.5s ease;
        }

        @keyframes msg-flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; background: rgba(255, 0, 60, 0.4); }
        }

        /* --- POPUPS --- */
        #main-popup {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(46, 56, 86, 0.98));
            backdrop-filter: blur(10px);
            color: #fff;
            padding: 35px;
            border: 4px solid var(--neo-yellow);
            z-index: 100;
            display: none;
            text-align: center;
            box-shadow: 
                0 0 50px var(--neo-yellow),
                inset 0 0 60px rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            min-width: 350px;
            max-width: 500px;
            animation: popup-enter 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes popup-enter {
            from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        #main-popup h3 {
            font-size: 26px;
            margin-bottom: 15px;
            color: var(--neo-yellow);
            text-shadow: 0 0 20px var(--neo-yellow);
        }

        #main-popup p {
            font-size: 16px;
            line-height: 1.6;
        }

        #letter-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.95), rgba(100, 50, 200, 0.95));
            backdrop-filter: blur(15px);
            padding: 40px;
            border: 4px solid var(--neo-magenta);
            border-radius: 20px;
            z-index: 150;
            display: none;
            text-align: center;
            box-shadow: 
                0 0 60px var(--neo-magenta),
                inset 0 0 80px rgba(0, 0, 0, 0.5);
            animation: popup-enter 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-width: 400px;
        }

        #letter-popup h3 {
            font-size: 28px;
            margin-bottom: 20px;
            color: var(--neo-magenta);
            text-shadow: 0 0 20px var(--neo-magenta);
        }

        #letter-popup p {
            font-size: 18px;
            line-height: 1.8;
            font-style: italic;
            color: #fff;
        }

        /* --- METRO TRANSITION --- */
        #metro-transition {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            z-index: 500;
            display: none;
            justify-content: center;
            align-items: center;
            animation: metro-fade-in 0.5s ease;
        }

        @keyframes metro-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .metro-screen {
            text-align: center;
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .metro-tunnel {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: repeating-linear-gradient(
                90deg,
                #1a1a1a 0px,
                #0a0a0a 50px,
                #1a1a1a 100px
            );
            animation: tunnel-move 1s linear infinite;
        }

        @keyframes tunnel-move {
            from { background-position: 0 0; }
            to { background-position: 100px 0; }
        }

        .metro-train {
            position: absolute;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 200px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-radius: 20px;
            box-shadow: 0 0 80px rgba(231, 76, 60, 0.8);
            animation: train-shake 0.1s infinite;
        }

        @keyframes train-shake {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(2px); }
        }

        .metro-train::before {
            content: '';
            position: absolute;
            top: 30px;
            left: 30px;
            width: 80px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .metro-train::after {
            content: '';
            position: absolute;
            top: 30px;
            right: 30px;
            width: 80px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .metro-text {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            font-weight: 900;
            color: var(--neo-cyan);
            text-shadow: 0 0 40px var(--neo-cyan);
            animation: text-pulse 1s ease-in-out infinite;
        }

        @keyframes text-pulse {
            0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.7; transform: translateX(-50%) scale(1.1); }
        }

        .metro-station {
            position: absolute;
            bottom: 15%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: var(--neo-yellow);
            text-shadow: 0 0 20px var(--neo-yellow);
        }

        /* --- END SCREEN --- */
        #end-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #0a0e27, #1a1f3a);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 400;
            animation: end-fade-in 1s ease;
        }

        @keyframes end-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #end-screen h1 {
            font-size: 56px;
            font-weight: 900;
            background: linear-gradient(45deg, var(--success), var(--neo-yellow));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 40px var(--success);
            margin-bottom: 20px;
            animation: end-title-bounce 1s ease-out;
        }

        @keyframes end-title-bounce {
            0% { transform: translateY(-100px); opacity: 0; }
            60% { transform: translateY(10px); }
            100% { transform: translateY(0); opacity: 1; }
        }

        #samuel-img { 
            width: 280px;
            height: 280px;
            object-fit: cover;
            border: 6px solid var(--success);
            border-radius: 50%;
            margin: 30px;
            background: var(--dark-2);
            box-shadow: 
                0 0 40px var(--success),
                inset 0 0 60px rgba(0, 0, 0, 0.5);
            animation: pulseSam 3s ease-in-out infinite;
        }

        @keyframes pulseSam { 
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 40px var(--success); 
            } 
            50% { 
                transform: scale(1.08); 
                box-shadow: 0 0 80px var(--success), 0 0 120px rgba(57, 255, 20, 0.5); 
            } 
        }

        .end-text-box { 
            background: linear-gradient(135deg, var(--dark-2), var(--dark-3));
            backdrop-filter: blur(10px);
            padding: 30px 40px;
            border-radius: 20px;
            border: 2px solid var(--neo-cyan);
            max-width: 650px;
            font-size: 20px;
            line-height: 1.8;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            animation: slideUpBox 0.8s ease-out 0.5s backwards;
        }

        @keyframes slideUpBox { 
            from { opacity: 0; transform: translateY(50px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        button.replay-btn {
            padding: 18px 45px;
            font-size: 20px;
            font-weight: 900;
            cursor: pointer;
            background: linear-gradient(135deg, var(--danger), #e74c3c);
            color: white;
            border: none;
            border-radius: 50px;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 6px 30px rgba(255, 0, 60, 0.6);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button.replay-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button.replay-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        button.replay-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 40px rgba(255, 0, 60, 0.8);
        }

    </style>
</head>
<body>
    <div class="scanlines"></div>

    <div id="title-screen">
        <div id="title-main">PARIS</div>
        <div id="title-subtitle">BY NIGHT !</div>
    </div>

    <div id="phone-container">
        <div id="chat-header">Les Chipies (4)</div>
        <div id="chat-body"></div>
        <div id="btn-start">üî´ SAUVER LE SOLDAT SAMUEL</div>
    </div>

    <div id="game-container">
        <canvas id="game-canvas" width="800" height="800"></canvas>
        
        <div id="game-ui">
            <div class="ui-level" id="level-name">PLACE DES VOSGES</div>
            <div class="ui-score">Indices : <span id="score">0</span> / 3</div>
            <div id="msg-popup"></div>
        </div>

        <div id="main-popup"></div>
        <div id="letter-popup">
            <h3>üíå Lettre d'Amour</h3>
            <p><em>"Mon Alexis,<br>Tu me manques d√©j√†...<br>Bisous, Samuel üíï"</em></p>
        </div>
    </div>

    <div id="metro-transition">
        <div class="metro-screen">
            <div class="metro-tunnel"></div>
            <div class="metro-train"></div>
            <div class="metro-text">EN ROUTE VERS PIGALLE</div>
            <div class="metro-station">Prochaine station ‚ûú Pigalle</div>
        </div>
    </div>

    <div id="end-screen">
        <h1>üéâ MISSION ACCOMPLIE ! üéâ</h1>
        <img id="samuel-img" src="https://i.pravatar.cc/280?img=12" alt="Samuel">
        <div class="end-text-box">
            <p><strong>F√©licitations !</strong> Gr√¢ce √† toi, Samuel a r√©cup√©r√© toutes ses affaires et a pu rejoindre Alexis √† temps ! üíï</p>
            <p>Les Chipies te remercient pour ton aide pr√©cieuse ! üôå</p>
        </div>
        <button class="replay-btn" onclick="location.reload()">üîÑ REJOUER</button>
    </div>

    <div id="yt-audio"></div>

    <script>
        // --- 1. CONFIGURATION DU JEU ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas ? canvas.getContext('2d') : null; 
        const GRID_SIZE = 20;
        const TILE = 40;

        let currentLevel = 1;
        let map = [];
        let playerPos = {x: 10, y: 18};
        let items = [];
        let enemies = [];
        let score = 0;
        let gameActive = false;
        let animTimer = 0;
        let player = null; // D√©claration unique ici

        // --- 2. SYST√àME DE CHAT ---
        const chatMessages = [
            {s: 'SAMUEL', t: 'Oh les gars ! C\'est chaud l√† !'},
            {s: 'SAMUEL', t: 'La police me course !!'},
            {s: 'IN√àS', t: 'Mdr arr√™te Sam, t\'as encore bu avau√© üòÇ'},
            {s: 'SAMUEL', t: 'Non ! J\'√©tais Place des Vosges, puis j\'ai fui vers Pigalle.'},
            {s: 'LILY', t: 'Encore...'},
            {s: 'SAMUEL', t: 'J\'ai paum√© mes affaires. Attention aux pigeons, ils sont violents.'}
        ];

        let msgIndex = 0;

        function playChat() {
            const chatBody = document.getElementById('chat-body');
            
            // S√©curit√© : si pas de chatBody, on arr√™te
            if (!chatBody) return;

            if (msgIndex >= chatMessages.length) { 
                const btn = document.getElementById('btn-start');
                if(btn) {
                    btn.style.display = 'block';
                    btn.style.animation = "msgSlideUp 0.5s ease forwards";
                }
                return; 
            }
            
            const m = chatMessages[msgIndex];
            const div = document.createElement('div');
            
            const side = (m.s === 'Moi') ? 'right' : 'left';
            div.className = 'msg ' + side;
            
            // Force opacit√© √† 1 pour √™tre s√ªr que √ßa s'affiche
            div.style.opacity = "1"; 
            div.innerHTML = '<span class="sender">' + m.s + '</span>' + m.t;
            
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
            
            msgIndex++;
            setTimeout(playChat, 1200); 
        }

        // --- 3. INITIALISATION ---
        document.addEventListener("DOMContentLoaded", function() {
            // Lancement du chat au chargement
            setTimeout(playChat, 800);
            
            const btnStart = document.getElementById('btn-start');
            if(btnStart) btnStart.addEventListener('click', startGame);
        });

        // --- 4. NIVEAUX ET LOGIQUE ---
        const levels = {
            1: { name: "üèõÔ∏è PLACE DES VOSGES", exitName: "le M√©tro", colorWall: '#8b0000', colorPath: '#c0c0c0', colorGround: '#2ecc71', items: [{x: 4, y: 5, type: 'card', name: "üí≥ Carte Bancaire"}, {x: 15, y: 4, type: 'kebab', name: "ü•ô Kebab Froid"}, {x: 5, y: 15, type: 'cap', name: "üß¢ Casquette"}], enemies: [{x:6, y:6, dx:1}, {x:13, y:13, dx:-1}, {x:6, y:13, dx:1}, {x:12, y:5, dx:-1}], start: {x: 10, y: 18}, exit: {x: 10, y: 1} },
            2: { name: "üåÉ PIGALLE (LA NUIT)", exitName: "Samuel", colorWall: '#1a1a2e', colorPath: '#2c2c3e', colorGround: '#0f0f1e', items: [{x: 2, y: 4, type: 'letter', name: "üíå Lettre d'Amour"}, {x: 17, y: 4, type: 'key', name: "üîë Cl√© Myst√®re"}, {x: 10, y: 10, type: 'foodbag', name: "üõçÔ∏è Sac de Courses"}], enemies: [{x:5, y:8, dx:1}, {x:14, y:8, dx:-1}, {x:5, y:12, dx:1}, {x:14, y:12, dx:-1}, {x:10, y:15, dx:1}], start: {x: 10, y: 18}, exit: {x: 10, y: 10} }
        };

        function generateMap(lvl) {
            const m = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill(0));
            if(lvl === 1) { for(let y=0; y<GRID_SIZE; y++) { for(let x=0; x<GRID_SIZE; x++) { if(y===0 || y===GRID_SIZE-1 || x===0 || x===GRID_SIZE-1) m[y][x] = 1; else if(y===1 || y===GRID_SIZE-2 || x===1 || x===GRID_SIZE-2) m[y][x] = 2; } } m[1][10] = 0; } 
            else { for(let y=0; y<GRID_SIZE; y++) { for(let x=0; x<GRID_SIZE; x++) { if(y<4 || y>15) m[y][x] = 1; else if(x<4 || x>15) m[y][x] = 1; else if(x>=4 && x<=6 && y>=7 && y<=9) m[y][x] = 1; else if(x>=13 && x<=15 && y>=7 && y<=9) m[y][x] = 1; else if(x>=4 && x<=6 && y>=11 && y<=13) m[y][x] = 1; else if(x>=13 && x<=15 && y>=11 && y<=13) m[y][x] = 1; else m[y][x] = (x===4 || x===15 || y===4 || y===15) ? 2 : 0; } } }
            return m;
        }

        // --- 5. VISUELS (DrawSprite Complet) ---
        function drawSprite(ctx, type, x, y) {
            const px = x * TILE;
            const py = y * TILE;
            
            // Ombre commune
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.beginPath();
            ctx.ellipse(px+20, py+35, 12, 5, 0, 0, Math.PI*2);
            ctx.fill();

            switch(type) {
                case 'player':
                    const bounce = Math.sin(animTimer * 4) * 2;
                    ctx.shadowBlur = 15; ctx.shadowColor = '#00F5FF';
                    ctx.fillStyle = '#00F5FF'; ctx.fillRect(px+12, py+18-bounce, 16, 16);
                    ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(px+20, py+13-bounce, 8, 0, Math.PI*2); ctx.fill();
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = '#000'; ctx.fillRect(px+17, py+11-bounce, 2, 2); ctx.fillRect(px+21, py+11-bounce, 2, 2);
                    break;

                case 'pigeon':
                    const flap = Math.sin(animTimer * 6) * 3;
                    ctx.fillStyle = '#999'; ctx.beginPath(); ctx.ellipse(px+20, py+22, 10, 8, 0, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#888'; ctx.beginPath(); ctx.arc(px+20, py+16, 6, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#f39c12'; ctx.beginPath(); ctx.moveTo(px+25, py+16); ctx.lineTo(px+30, py+16); ctx.lineTo(px+27, py+18); ctx.closePath(); ctx.fill();
                    ctx.fillStyle = '#666'; ctx.beginPath(); ctx.ellipse(px+12, py+22+flap, 8, 4, -0.5, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.ellipse(px+28, py+22+flap, 8, 4, 0.5, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#FF003C'; ctx.fillRect(px+18, py+15, 2, 2); ctx.fillRect(px+22, py+15, 2, 2);
                    break;

                case 'card':
                    ctx.shadowBlur = 10; ctx.shadowColor = '#00F5FF';
                    ctx.fillStyle = '#00F5FF'; ctx.fillRect(px+10, py+15, 20, 14);
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = '#FFD700'; ctx.fillRect(px+12, py+17, 16, 2); ctx.fillRect(px+12, py+21, 10, 2);
                    break;

                case 'kebab':
                    ctx.fillStyle = '#f39c12'; ctx.fillRect(px+14, py+12, 12, 20);
                    ctx.fillStyle = '#27ae60'; ctx.fillRect(px+16, py+15, 8, 3);
                    ctx.fillStyle = '#e74c3c'; ctx.fillRect(px+16, py+20, 8, 3);
                    ctx.fillStyle = '#8B4513'; ctx.fillRect(px+17, py+10, 6, 3);
                    break;

                case 'cap':
                    ctx.fillStyle = '#e74c3c'; ctx.fillRect(px+10, py+18, 20, 8); ctx.fillRect(px+8, py+22, 24, 4);
                    ctx.fillStyle = '#fff'; ctx.fillRect(px+16, py+20, 8, 2);
                    break;

                case 'letter':
                    ctx.shadowBlur = 10; ctx.shadowColor = '#FF006E';
                    ctx.fillStyle = '#fff'; ctx.fillRect(px+12, py+16, 16, 12);
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = '#FF006E'; ctx.fillRect(px+14, py+20, 12, 1); ctx.fillRect(px+14, py+22, 12, 1); ctx.fillRect(px+14, py+24, 8, 1);
                    break;

                case 'key':
                    ctx.shadowBlur = 10; ctx.shadowColor = '#FFBE0B';
                    ctx.fillStyle = '#FFBE0B'; ctx.beginPath(); ctx.arc(px+15, py+20, 5, 0, Math.PI*2); ctx.fill();
                    ctx.fillRect(px+18, py+18, 10, 4);
                    ctx.shadowBlur = 0;
                    ctx.fillRect(px+26, py+16, 2, 2); ctx.fillRect(px+26, py+20, 2, 2);
                    break;

                case 'foodbag':
                    ctx.fillStyle = '#8B5CF6'; ctx.fillRect(px+12, py+16, 16, 16);
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 14px Arial'; ctx.textAlign = 'center'; ctx.fillText('üçé', px+20, py+28); ctx.textAlign = 'start';
                    break;

                case 'metroExit':
                    const pulse = Math.sin(animTimer * 3) * 5;
                    ctx.shadowBlur = 20 + pulse; ctx.shadowColor = '#39FF14';
                    ctx.fillStyle = '#39FF14'; ctx.fillRect(px+8, py+8, 24, 24);
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = '#000'; ctx.font = 'bold 16px Arial'; ctx.textAlign = 'center'; ctx.fillText('M', px+20, py+26); ctx.textAlign = 'start';
                    break;
            }
        }

        // --- UTILITAIRES ---
        function showPopup(html, duration = 3000) { 
            const p = document.getElementById('main-popup'); 
            if(p){ p.innerHTML = html; p.style.display = 'block'; setTimeout(() => p.style.display = 'none', duration); }
        }
        function showMsg(txt) { 
            const el = document.getElementById('msg-popup'); 
            if(el) { el.innerText = txt; setTimeout(() => el.innerText = '', 2500); }
        }
        function showMetroTransition() {
            const metro = document.getElementById('metro-transition');
            if(metro) { metro.style.display = 'flex'; setTimeout(() => { metro.style.display = 'none'; loadLevel(2); }, 3000); }
        }

        // --- RENDER COMPLET ---
        function drawGame() {
            if(!ctx) return;
            ctx.clearRect(0, 0, 800, 800);
            const conf = levels[currentLevel];

            for(let y=0; y<GRID_SIZE; y++) {
                for(let x=0; x<GRID_SIZE; x++) {
                    const t = map[y][x]; const px = x * TILE; const py = y * TILE;

                    if(currentLevel === 1) { // VOSGES
                        if (t === 1) {
                            ctx.fillStyle = conf.colorWall; ctx.fillRect(px, py, TILE, TILE);
                            ctx.strokeStyle = '#6b0000'; ctx.strokeRect(px, py, TILE, TILE); ctx.strokeRect(px, py + TILE/2, TILE, TILE/2);
                        } else if (t === 2) {
                            ctx.fillStyle = conf.colorPath; ctx.fillRect(px, py, TILE, TILE);
                            ctx.strokeStyle = '#a0a0a0'; ctx.strokeRect(px, py, TILE, TILE);
                        } else {
                            ctx.fillStyle = conf.colorGround; ctx.fillRect(px, py, TILE, TILE);
                            if((x+y) % 2 === 0) { ctx.fillStyle = '#27ae60'; ctx.fillRect(px+5, py+5, TILE-10, TILE-10); }
                            ctx.strokeStyle = '#239954'; ctx.strokeRect(px, py, TILE, TILE);
                            if(x % 4 === 0 && y % 4 === 0 && x > 2 && x < 17 && y > 2 && y < 17) {
                                const flowerColors = ['#e74c3c', '#fff', '#f1c40f', '#ff69b4'];
                                ctx.fillStyle = flowerColors[(x+y) % flowerColors.length];
                                ctx.beginPath(); ctx.arc(px+20, py+20, 3, 0, Math.PI*2); ctx.fill();
                            }
                            if((x === 7 || x === 13) && y === 10) {
                                ctx.fillStyle = '#8B4513'; ctx.fillRect(px+8, py+12, 24, 6); ctx.fillRect(px+10, py+8, 4, 10); ctx.fillRect(px+26, py+8, 4, 10);
                            }
                            if((x === 5 || x === 15) && (y === 5 || y === 15)) {
                                ctx.strokeStyle = '#333'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(px+20, py+30); ctx.lineTo(px+20, py+10); ctx.stroke();
                                ctx.fillStyle = '#f1c40f'; ctx.shadowBlur = 15; ctx.shadowColor = '#f1c40f'; ctx.beginPath(); ctx.arc(px+20, py+10, 4, 0, Math.PI*2); ctx.fill();
                                ctx.shadowBlur = 0; ctx.lineWidth = 1;
                            }
                        }
                    } else { // PIGALLE
                        if (t===1) {
                            ctx.fillStyle = conf.colorWall; ctx.fillRect(px,py,TILE,TILE);
                            ctx.strokeStyle = '#111'; ctx.strokeRect(px,py,TILE,TILE);
                            if((x%3===0 || y%3===0)) {
                                ctx.fillStyle = (x+y)%2===0 ? '#ff00cc' : '#00ccff';
                                ctx.shadowBlur = 20; ctx.shadowColor = ctx.fillStyle;
                                if(Math.sin(animTimer*2) > 0) ctx.fillRect(px+5, py+5, TILE-10, TILE-10);
                                ctx.shadowBlur = 0;
                            }
                        } else if (t===2) {
                            ctx.fillStyle = conf.colorPath; ctx.fillRect(px,py,TILE,TILE);
                            ctx.strokeStyle = '#3c3c4e'; ctx.strokeRect(px,py,TILE,TILE);
                        } else {
                            ctx.fillStyle = conf.colorGround; ctx.fillRect(px,py,TILE,TILE);
                            ctx.strokeStyle = '#222'; ctx.strokeRect(px,py,TILE,TILE);
                            if(x === GRID_SIZE/2 && y%3===0) { ctx.fillStyle = '#f1c40f'; ctx.fillRect(px+15, py+10, 10, 20); }
                            if((x===3 || x===16) && y%5===0 && y>2 && y<17) {
                                const neonColors = ['#ff00cc', '#00ccff', '#39FF14'];
                                ctx.fillStyle = neonColors[(x+y) % neonColors.length];
                                ctx.shadowBlur = 15; ctx.shadowColor = ctx.fillStyle;
                                ctx.fillRect(px+2, py+10, 8, 20); ctx.shadowBlur = 0;
                            }
                        }
                    }
                }
            }
            // Entit√©s
            items.forEach(i => drawSprite(ctx, i.type, i.x, i.y));
            enemies.forEach(e => drawSprite(ctx, 'pigeon', e.x, e.y));
            drawSprite(ctx, 'player', playerPos.x, playerPos.y);

            // Sortie
            const ex = levels[currentLevel].exit;
            if(currentLevel === 1) {
                drawSprite(ctx, 'metroExit', ex.x, ex.y);
            } else {
                const pulse = Math.sin(animTimer * 3) * 3;
                ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.beginPath(); ctx.ellipse(ex.x*TILE+20, ex.y*TILE+35, 15, 6, 0, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 20 + pulse; ctx.shadowColor = '#e74c3c';
                ctx.fillStyle = '#e74c3c'; ctx.fillRect(ex.x*TILE+10, ex.y*TILE+15, 20, 18);
                ctx.fillStyle = '#f39c12'; ctx.beginPath(); ctx.arc(ex.x*TILE+20, ex.y*TILE+12, 10, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;
                ctx.fillStyle = '#000'; ctx.fillRect(ex.x*TILE+16, ex.y*TILE+10, 3, 3); ctx.fillRect(ex.x*TILE+21, ex.y*TILE+10, 3, 3);
                ctx.fillStyle = '#fff'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center'; ctx.fillText('SAM', ex.x*TILE+20, ex.y*TILE+48); ctx.textAlign = 'start';
                if(score === 3) {
                    const arrowBounce = Math.sin(animTimer * 4) * 5;
                    ctx.fillStyle = '#39FF14'; ctx.shadowBlur = 15; ctx.shadowColor = '#39FF14';
                    ctx.beginPath(); ctx.moveTo(ex.x*TILE+20, ex.y*TILE-10-arrowBounce); ctx.lineTo(ex.x*TILE+15, ex.y*TILE-20-arrowBounce); ctx.lineTo(ex.x*TILE+25, ex.y*TILE-20-arrowBounce); ctx.closePath(); ctx.fill();
                    ctx.shadowBlur = 0;
                }
            }
        }

        // --- 6. LOGIQUE DE JEU ---
        function loadLevel(lvlIdx) {
            currentLevel = lvlIdx;
            map = generateMap(lvlIdx);
            items = JSON.parse(JSON.stringify(levels[lvlIdx].items));
            enemies = JSON.parse(JSON.stringify(levels[lvlIdx].enemies));
            playerPos = {...levels[lvlIdx].start};
            score = 0;
            const lvlName = document.getElementById('level-name');
            if(lvlName) lvlName.innerText = levels[lvlIdx].name;
            const scoreEl = document.getElementById('score');
            if(scoreEl) scoreEl.innerText = '0';
            if(lvlIdx === 2) showMsg("üåÉ Sam est √† Pigalle !");
        }

        function startGame() {
            const phone = document.getElementById('phone-container');
            const game = document.getElementById('game-container');
            if(phone) phone.style.display = 'none';
            if(game) game.style.display = 'block';
            
            try {
                if(player && typeof player.playVideo === 'function') { 
                    player.unMute(); player.setVolume(50); player.playVideo(); 
                }
            } catch(e) { console.log("Pas de musique (local)"); }
            
            gameActive = true;
            loadLevel(1);
            if(ctx) drawGame();
            gameLoop();
        }

        function gameLoop() {
            if(!gameActive) return;
            updateEnemies();
            if(ctx) drawGame();
            animTimer += 0.15;
            requestAnimationFrame(gameLoop);
        }
        
        function updateScore() { 
            const s = document.getElementById('score');
            if(s) s.innerText = score; 
        }

        function updateEnemies() {
            enemies.forEach(e => {
                const nextX = e.x + e.dx;
                if(nextX < 2 || nextX >= GRID_SIZE-2 || map[e.y][nextX] === 1) e.dx *= -1;
                else e.x = nextX;
                if (e.x === playerPos.x && e.y === playerPos.y) {
                    if(score > 0) { score--; updateScore(); showMsg("ü¶Ö Vol√© !"); }
                    let backX = playerPos.x - e.dx * 2;
                    if(backX > 1 && backX < GRID_SIZE-1 && map[playerPos.y][backX] !== 1) playerPos.x = backX;
                }
            });
        }

        function movePlayer(dx, dy) {
            if(!gameActive) return;
            const nx = playerPos.x + dx; const ny = playerPos.y + dy;
            if(nx < 0 || nx >= GRID_SIZE || ny < 0 || ny >= GRID_SIZE) return;
            if(map[ny][nx] === 1) return;
            playerPos.x = nx; playerPos.y = ny;

            const itemIndex = items.findIndex(i => i.x === nx && i.y === ny);
            if(itemIndex !== -1) {
                const item = items[itemIndex];
                items.splice(itemIndex, 1);
                score++; updateScore();
                if(item.type === 'letter') {
                    const lp = document.getElementById('letter-popup');
                    if(lp) { lp.style.display = 'block'; setTimeout(() => lp.style.display = 'none', 3000); }
                } else showPopup(`<h3>‚úÖ TROUV√â !</h3><p>${item.name}</p>`, 2000);
                
                if(score === 3) setTimeout(() => showPopup(`<h3>‚úÖ FINI !</h3><p>Go vers la sortie !</p>`, 4000), 1000);
            }

            const ex = levels[currentLevel].exit;
            if(nx === ex.x && ny === ex.y) {
                if(score >= 3) {
                    gameActive = false;
                    if(currentLevel === 1) { showMetroTransition(); setTimeout(() => gameActive = true, 3100); }
                    else { 
                        document.getElementById('game-container').style.display='none';
                        document.getElementById('end-screen').style.display='flex';
                    }
                } else {
                    showMsg("‚ùå Il manque des objets !");
                    playerPos.y += (currentLevel===1 ? 1 : -1);
                }
            }
        }

        // Contr√¥les
        window.addEventListener('keydown', e => {
            if(['ArrowUp','w','ArrowDown','s','ArrowLeft','a','ArrowRight','d'].includes(e.key)) {
                e.preventDefault();
                if(e.key==='ArrowUp' || e.key==='w') movePlayer(0,-1);
                if(e.key==='ArrowDown' || e.key==='s') movePlayer(0,1);
                if(e.key==='ArrowLeft' || e.key==='a') movePlayer(-1,0);
                if(e.key==='ArrowRight' || e.key==='d') movePlayer(1,0);
            }
        });
        
        let touchStartX = 0, touchStartY = 0;
        document.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; }, {passive: true});
        document.addEventListener('touchend', e => {
            if(!gameActive) return;
            const dx = e.changedTouches[0].clientX - touchStartX; const dy = e.changedTouches[0].clientY - touchStartY;
            if(Math.abs(dx) > Math.abs(dy)) movePlayer(dx > 0 ? 1 : -1, 0); else movePlayer(0, dy > 0 ? 1 : -1);
        }, {passive: true});

        // --- YOUTUBE API ---
        function onYouTubeIframeAPIReady() {
            try {
                player = new YT.Player('yt-audio', {
                    height: '0', width: '0', videoId: 'jfKfPfyJRdk',
                    playerVars: { 'autoplay': 0, 'loop': 1, 'playlist': 'jfKfPfyJRdk', 'controls': 0 },
                    events: { 'onReady': function(e){ console.log("Musique pr√™te"); } }
                });
            } catch(e) { console.warn("YouTube API Error (ignorable)"); }
        }
    </script>
    <script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
